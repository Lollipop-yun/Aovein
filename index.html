
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aovein</title>
    <!-- 依赖库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* ==================== 全局配置 ==================== */
        body { 
            background-color: #000; 
            color: #000; 
            font-family: var(--custom-font, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif);
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            overflow: hidden; 
            margin: 0; padding: 0;
        }

        [v-cloak] { display: none !important; }

        /* ==================== Aovein 加载页 ==================== */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; z-index: 999999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        .loading-title { font-size: 40px; font-weight: 300; color: #000; letter-spacing: 4px; margin-bottom: 40px; opacity: 0; animation: fadeInTitle 1s ease-out forwards; }
        .progress-container { width: 200px; height: 2px; background-color: #f0f0f0; border-radius: 2px; overflow: hidden; opacity: 0; animation: fadeInBar 1s ease-out 0.5s forwards; }
        .progress-bar { width: 0%; height: 100%; background-color: #000; animation: progressFill 2.5s ease-in-out 0.8s forwards; }

        /* ==================== 激活界面 ==================== */
        #activation-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; z-index: 999990;
            display: flex; flex-direction: column; align-items: center; padding-top: 120px;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.6s;
        }
        .activation-header { text-align: center; margin-bottom: 40px; }
        .activation-logo { font-size: 24px; font-weight: 600; letter-spacing: 2px; margin-bottom: 8px; }
        .activation-sub { font-size: 14px; color: #888; }
        .device-id-box { background: #f9f9f9; padding: 15px 20px; border-radius: 12px; font-family: monospace; font-size: 16px; color: #333; letter-spacing: 1px; margin-bottom: 30px; border: 1px solid #eee; text-align: center; user-select: text !important; }
        .device-label { font-size: 10px; color: #aaa; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .code-input-group { width: 80%; max-width: 320px; margin-bottom: 20px; }
        .code-input { width: 100%; padding: 15px; text-align: center; font-size: 18px; border: 2px solid #eee; border-radius: 12px; outline: none; letter-spacing: 2px; text-transform: uppercase; font-family: monospace; transition: all 0.3s; background: white; color: black; }
        .code-input:focus { border-color: #000; }
        .code-input.error { border-color: #ff4d4f; animation: shake 0.4s; }
        .error-msg { color: #ff4d4f; font-size: 12px; margin-top: 8px; height: 16px; text-align: center; opacity: 0; transition: opacity 0.2s; }
        .error-msg.show { opacity: 1; }
        .activate-btn { background-color: #000; color: white; padding: 15px 60px; border-radius: 30px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .activate-btn:active { transform: scale(0.95); }
        .hidden-screen { opacity: 0; pointer-events: none; visibility: hidden; }

        /* ==================== 动画与通用 ==================== */
        @keyframes fadeInTitle { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInBar { from { opacity: 0; } to { opacity: 1; } }
        @keyframes progressFill { 0% { width: 0%; } 100% { width: 100%; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes typing-bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-3px); } }
        .typing-dot { display: inline-block; animation: typing-bounce 1.4s infinite ease-in-out both; margin: 0 1px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        input, textarea, select { -webkit-user-select: text !important; user-select: text !important; pointer-events: auto !important; cursor: text !important; transform: translate3d(0,0,0); font-family: inherit; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scale-enter-active, .scale-leave-active { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .scale-enter-from, .scale-leave-to { transform: scale(0.9); opacity: 0; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .app-slide-enter-active, .app-slide-leave-active { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .app-slide-enter-from { transform: translateY(100%); }
        .app-slide-leave-to { transform: translateY(100%); }
        .page-slide-enter-active, .page-slide-leave-active { transition: transform 0.25s ease; position: absolute; width: 100%; top: 0; }
        .page-slide-enter-from { transform: translateX(100%); }
        .page-slide-leave-to { transform: translateX(-20%); opacity: 0; }
        
        .home-icon img { transition: all 0.2s; border-radius: 12px; }
        .home-icon:active img { transform: scale(0.9); }
        .home-icon i { color: #9ca3af; transition: color 0.2s; }
        .home-icon-custom img { filter: none !important; }

        .dock-container { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); border-radius: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .widget-bubble { background: white; border-radius: 12px; padding: 4px 8px; font-size: 10px; font-weight: bold; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; margin-bottom: 6px; white-space: normal; max-width: 70px; text-align: center; line-height: 1.2; word-break: break-all; }
        .widget-bubble::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid white; }

        /* ==================== 微信相关样式 ==================== */
        .wechat-pill-tab { transition: all 0.2s ease; border-radius: 999px; padding: 6px 16px; font-size: 13px; font-weight: 500; }
        .wechat-pill-active { background-color: #000; color: #fff; }
        .wechat-pill-inactive { background-color: transparent; color: #333; }
        .wechat-bottom-nav { background: white; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 90%; height: 60px; margin-bottom: 20px; }
        .wechat-avatar-ring { border: 2px solid #ffb6c1; padding: 2px; }
        .vip-badge { background-color: #666; color: white; font-size: 9px; padding: 1px 4px; border-radius: 4px; font-weight: bold; letter-spacing: 0.5px; }
        .wechat-search-input::placeholder { text-align: center; color: #9ca3af; }
        .wechat-dropdown { position: absolute; top: 50px; right: 10px; width: 150px; background-color: #4c4c4c; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); z-index: 40000; padding: 4px 0; color: white; display: flex; flex-direction: column; overflow: visible; }
        .wechat-dropdown::before { content: ''; position: absolute; top: -6px; right: 12px; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 6px solid #4c4c4c; }
        
        .chat-attach-menu { 
            position: absolute; bottom: 65px; left: 50%; transform: translateX(-50%); width: 95%; 
            background: rgba(255, 255, 255, 0.98); border-radius: 24px; padding: 20px 10px; 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15); border: 1px solid #f0f0f0; 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; z-index: 50; 
        }
        .attach-item { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.1s; }
        .attach-item:active { transform: scale(0.95); }
        .attach-icon-box { 
            width: 54px; height: 54px; background: #fff; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; color: #4b5563; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
        }
        .attach-label { font-size: 11px; color: #666; font-weight: 500; }

        /* 气泡基础样式 */
        .chat-bubble { border-radius: 18px; padding: 8px 12px; font-size: 14px; max-width: 100%; line-height: 1.4; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.03); }
        .chat-bubble-ai { background-color: #ffffff; color: #333; border-top-left-radius: 4px; }
        .chat-bubble-user { background-color: #f2f2f2; color: #333; border-top-right-radius: 4px; }
        .chat-bubble-voice { display: flex; align-items: center; gap: 8px; min-width: 60px; cursor: pointer; transition: width 0.2s ease; }
        .chat-bubble-image { padding: 4px; border-radius: 12px; overflow: hidden; background: transparent; box-shadow: none; }
        .chat-bubble-image img { border-radius: 8px; max-width: 180px; max-height: 180px; }
        
        .chat-bubble-fake-image { 
            width: 140px; height: 190px; background-color: #e5e7eb; 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
        .fake-image-text { 
            padding: 15px; font-size: 13px; text-align: center; color: #374151; font-weight: 500;
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        /* ---------------- 特殊卡片样式 (强制样式保护) ---------------- */
        
        /* 1. 朋友圈转发卡片 - 强制白底黑字 */
        .chat-bubble-moment { 
            background-color: #ffffff !important; 
            color: #333 !important; 
            padding: 12px; 
            width: 240px; 
            cursor: pointer; 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        
        /* 2. 聊天记录转发卡片 - 强制白底黑字 */
        .forward-card { 
            background-color: #ffffff !important; 
            color: #333 !important; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            padding: 12px; 
            width: 220px; 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
        }

        /* 3. 红包与转账 - 强制颜色 */
        .chat-bubble-finance { padding: 0; overflow: hidden; color: white; width: 230px; display: flex; flex-direction: column; cursor: pointer; }
        .chat-bubble-transfer { background: #fa9d3b !important; }
        .chat-bubble-transfer.received { background: #f7bb79 !important; opacity: 0.9; } 
        .chat-bubble-redpacket { background: #ea5f39 !important; }
        
        /* --------------------------------------------------------- */

        .finance-content { padding: 15px; display: flex; align-items: center; gap: 12px; }
        .finance-icon-box { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fa9d3b; font-size: 20px; }
        .chat-bubble-redpacket .finance-icon-box { color: #ea5f39; background: #fce8cd; }
        .finance-text { display: flex; flex-direction: column; color: white; }
        .finance-title { font-size: 15px; font-weight: 500; }
        .finance-desc { font-size: 12px; opacity: 0.9; margin-top: 2px;}
        .finance-footer { background: white; padding: 6px 12px; font-size: 11px; color: #999; border-top: 1px solid rgba(255,255,255,0.2); }

        .chat-bubble-qinmi { background: #ffffff; color: #333; padding: 0; overflow: hidden; width: 240px; cursor: pointer; display: flex; flex-direction: column; border: 1px solid #eee; border-radius: 12px !important; }
        .qinmi-header { background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%); padding: 15px; display: flex; align-items: center; gap: 12px; color: white; }
        .qinmi-icon { font-size: 24px; }
        .qinmi-body { padding: 12px; font-size: 13px; color: #666; }
        .qinmi-footer { border-top: 1px solid #f5f5f5; padding: 8px 12px; font-size: 11px; color: #999; display: flex; justify-content: space-between; align-items: center; }
        
        .moment-card-header { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #666; border-bottom: 1px solid #f0f0f0; padding-bottom: 6px; }
        .moment-card-content { display: flex; gap: 10px; }
        .moment-card-thumb { width: 50px; height: 50px; background: #eee; object-fit: cover; border-radius: 4px; shrink: 0; }
        .moment-card-text { font-size: 13px; color: #333; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }

        .chat-timestamp-small { font-size: 10px; color: #999; margin-top: 2px; }
        .quote-block { background-color: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; font-size: 12px; color: #666; border-left: 2px solid #ccc; }
        .chat-bubble-user .quote-block { background-color: rgba(0,0,0,0.05); border-left-color: #999; }
        
        .forward-title { font-size: 14px; font-weight: bold; color: #333; border-bottom: 1px solid #f5f5f5; padding-bottom: 4px; margin-bottom: 2px; }
        .forward-content { font-size: 12px; color: #666; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }

        .voice-transcription { font-size: 12px; color: #666; background: #ffffff; padding: 6px 10px; border-radius: 8px; margin-top: 4px; border: 1px solid #eee; }
        .voice-wave-container { display: flex; align-items: center; gap: 2px; height: 16px; }
        .voice-wave-bar { width: 3px; background-color: currentColor; border-radius: 2px; }
        .voice-wave-bar:nth-child(1) { height: 6px; } .voice-wave-bar:nth-child(2) { height: 12px; } .voice-wave-bar:nth-child(3) { height: 9px; }

        .system-recall-tip { text-align: center; font-size: 12px; color: #9ca3af; margin: 12px 0; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .recall-link { color: #576b95; cursor: pointer; font-weight: bold; }

        .chat-context-menu { position: fixed; background: #4c4c4c; color: white; border-radius: 12px; padding: 0; z-index: 99999; box-shadow: 0 8px 30px rgba(0,0,0,0.4); display: flex; flex-wrap: wrap; width: 260px; }
        .chat-context-menu::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #4c4c4c; }
        .context-item { width: 25%; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; gap: 4px; cursor: pointer; }
        .context-item:active { background: rgba(255,255,255,0.1); border-radius: 8px; }

        .top-notification-banner { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 380px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 16px; padding: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 100000; display: flex; align-items: center; gap: 12px; cursor: pointer; animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* 开关按钮 */
        .switch-checkbox { display: none; }
        .switch-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; width: 50px; height: 30px; background: #d1d5db; border-radius: 100px; position: relative; transition: background-color .2s; }
        .switch-label .switch-button { content: ''; position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; border-radius: 45px; transition: 0.2s; background: #fff; box-shadow: 0 0 2px 0 rgba(10, 10, 10, 0.29); }
        .switch-checkbox:checked + .switch-label .switch-button { left: calc(100% - 2px); transform: translateX(-100%); }
        .switch-checkbox:checked + .switch-label { background-color: #000; }

        /* 小号开关 (世界书用) */
        .switch-checkbox-sm { display: none; }
        .switch-label-sm { display: flex; align-items: center; justify-content: space-between; cursor: pointer; width: 36px; height: 22px; background: #d1d5db; border-radius: 100px; position: relative; transition: background-color .2s; }
        .switch-label-sm .switch-button-sm { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; border-radius: 50%; transition: 0.2s; background: #fff; box-shadow: 0 0 2px 0 rgba(10, 10, 10, 0.29); }
        .switch-checkbox-sm:checked + .switch-label-sm .switch-button-sm { left: calc(100% - 2px); transform: translateX(-100%); }
        .switch-checkbox-sm:checked + .switch-label-sm { background-color: #07c160; }

        .ios-list-modal { position: absolute; bottom: 0; left: 0; width: 100%; background: #f2f2f2; border-top-left-radius: 20px; border-top-right-radius: 20px; max-height: 70vh; overflow: hidden; display: flex; flex-direction: column; }
        .ios-list-header { padding: 15px; text-align: center; font-weight: bold; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; }
        .ios-list-content { overflow-y: auto; padding: 10px; background: #f2f2f2; }
        .ios-list-item { background: white; padding: 15px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
        .ios-list-item:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .ios-list-item:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }
        .ios-list-item:active { background: #eee; }

        .red-packet-bg { background-color: #f3f4f6; }
        .rp-header { background: #d44d44; position: relative; height: 160px; border-bottom-left-radius: 50% 30px; border-bottom-right-radius: 50% 30px; }
        .rp-avatar-box { width: 70px; height: 70px; border-radius: 6px; overflow: hidden; position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 10px rgba(0,0,0,0.05); background: white; }

        .qinmi-detail-bg { background: #F5F5F5; color: #333; }
        .qinmi-card-detail { background: #fff; margin: 15px; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .qinmi-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f5f5f5; padding-bottom: 15px; }
        .qinmi-balance-big { font-size: 32px; font-weight: bold; color: #333; margin: 10px 0; }

        /* 朋友圈样式 */
        .moments-header { height: 300px; position: relative; background-color: #333; margin-bottom: 40px; cursor: pointer; }
        .moments-cover { width: 100%; height: 100%; object-fit: cover; }
        .moments-user { position: absolute; bottom: -20px; right: 20px; display: flex; align-items: flex-end; gap: 15px; }
        .moments-username { color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin-bottom: 30px; font-size: 18px; cursor: pointer; }
        .moments-avatar { width: 70px; height: 70px; border-radius: 12px; border: 2px solid white; overflow: hidden; background: white; cursor: pointer; }
        .moment-item { padding: 15px 15px 20px 15px; display: flex; gap: 12px; border-bottom: 1px solid #f5f5f5; }
        .moment-avatar { width: 42px; height: 42px; border-radius: 6px; background: #eee; overflow: hidden; shrink: 0; }
        .moment-content { flex: 1; }
        .moment-name { color: #576b95; font-weight: bold; font-size: 15px; margin-bottom: 6px; }
        .moment-text { font-size: 15px; color: #333; line-height: 1.5; margin-bottom: 8px; white-space: pre-wrap; }
        .moment-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; max-width: 260px; margin-bottom: 8px; }
        .moment-image { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #f0f0f0; }
        .moment-image.single { max-width: 180px; max-height: 180px; width: auto; aspect-ratio: auto; }
        .moment-meta { display: flex; justify-content: space-between; align-items: center; position: relative; height: 20px; }
        .moment-time { font-size: 12px; color: #999; }
        /* 朋友圈操作按钮 (三个点) */
        .moment-action-btn { background: #f7f7f7; padding: 0 8px; border-radius: 4px; color: #576b95; font-size: 16px; font-weight: bold; cursor: pointer; height: 20px; line-height: 16px; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; position: absolute; right: 0; z-index: 10; }
        
        /* 朋友圈菜单 (黑色) - 覆盖三个点 */
        .moment-menu { 
            position: absolute; 
            right: 0; top: 0; 
            height: 100%; 
            background: #4c4c4c; 
            border-radius: 4px; 
            display: flex; align-items: center; 
            color: white; 
            padding: 0; 
            overflow: hidden; 
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 20; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }
        .moment-menu-item { padding: 0 16px; height: 100%; display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; white-space: nowrap; border-right: 1px solid rgba(255,255,255,0.1); }
        .moment-menu-item:last-child { border-right: none; }
        .moment-menu-item:active { background: rgba(255,255,255,0.1); }
        @keyframes popIn { from { transform: scaleX(0); transform-origin: right center; opacity: 0; } to { transform: scaleX(1); opacity: 1; } }
        
        .moment-likes-comments { background: #f7f7f7; border-radius: 4px; margin-top: 8px; padding: 6px 10px; font-size: 13px; }
        .moment-likes { color: #576b95; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 4px; margin-bottom: 4px; display: flex; items-center; gap: 4px; line-height: 1.4; }
        .moment-comment-item { margin-bottom: 2px; line-height: 1.4; word-break: break-all; }
        .moment-comment-user { color: #576b95; font-weight: 500; cursor: pointer; }
        .moment-comment-input-box { display: flex; gap: 8px; margin-top: 8px; align-items: center; }
        .moment-input { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 4px 8px; font-size: 13px; outline: none; }

    </style>
    
    <!-- 动态美化样式 -->
    <style id="dynamic-beautify-style"></style>
</head>
<body>

<!-- Aovein 启动加载页 -->
<div id="loading-screen">
    <div class="loading-title">Aovein</div>
    <div class="progress-container"><div class="progress-bar"></div></div>
</div>

<!-- 激活界面 -->
<div id="activation-screen" class="hidden-screen">
    <div class="activation-header"><div class="activation-logo">Aovein OS</div><div class="activation-sub">设备激活</div></div>
    <div class="device-id-box"><span class="device-label">DEVICE ID</span><span id="device-id-display">...</span></div>
    <div class="code-input-group"><input type="text" id="activation-code" class="code-input" placeholder="XXX-XXXX-XXXX" maxlength="13"><div id="activation-error" class="error-msg">激活码错误</div></div>
    <div class="activate-btn" onclick="attemptActivate()">立即激活</div>
</div>

<div id="app" v-cloak class="max-w-md mx-auto h-screen bg-[#f3f4f6] flex flex-col relative overflow-hidden shadow-2xl border-x border-gray-200" style="display: none;" @click="closeAllMenus"
     :style="{ '--custom-font': themeConfig.fontFamily ? themeConfig.fontFamily : 'inherit', 'color': themeConfig.fontColor || '#000000', 'font-size': (themeConfig.fontSize || 1) + 'em' }">

    <!-- 全局弹窗 -->
    <transition name="fade"><div v-if="toast.show" class="fixed inset-0 z-[60000] flex items-center justify-center pointer-events-none"><div class="bg-black/70 text-white px-5 py-3 rounded-xl shadow-lg backdrop-blur-sm text-sm font-medium">{{ toast.message }}</div></div></transition>
    <transition name="scale">
        <div v-if="inputModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-white w-[80%] max-w-xs rounded-2xl overflow-hidden shadow-2xl transform transition-all">
                <div class="p-5">
                    <h3 class="text-lg font-bold text-gray-900 mb-1 text-center">{{ inputModal.title }}</h3>
                    <p v-if="inputModal.desc" class="text-xs text-gray-500 mb-2 text-center">{{ inputModal.desc }}</p>
                    <textarea v-if="inputModal.inputType === 'textarea'" v-model="inputModal.value" :placeholder="inputModal.placeholder" ref="globalInput" class="w-full h-32 bg-gray-100 px-3 py-2 rounded-lg border-none outline-none text-sm mt-3 focus:ring-2 focus:ring-blue-100 resize-none"></textarea>
                    <input v-else v-model="inputModal.value" :placeholder="inputModal.placeholder" ref="globalInput" class="w-full bg-gray-100 px-3 py-2 rounded-lg border-none outline-none text-sm text-center mt-3 focus:ring-2 focus:ring-blue-100" :type="inputModal.inputType || 'text'">
                </div>
                <div class="flex border-t border-gray-100">
                    <button @click="inputModal.show = false" class="flex-1 py-3 text-gray-600 font-medium active:bg-gray-50 text-sm">取消</button>
                    <div class="w-px bg-gray-100"></div>
                    <button @click="handleInputConfirm" class="flex-1 py-3 text-blue-600 font-bold active:bg-gray-50 text-sm">确定</button>
                </div>
            </div>
        </div>
    </transition>
    <transition name="scale"><div v-if="confirmModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[80%] max-w-xs rounded-2xl overflow-hidden shadow-2xl"><div class="p-6 text-center"><h3 class="text-lg font-bold text-gray-900 mb-2">提示</h3><p class="text-sm text-gray-500">{{ confirmModal.message }}</p></div><div class="flex border-t border-gray-100"><button @click="confirmModal.show = false" class="flex-1 py-3 text-gray-600 text-sm">取消</button><div class="w-px bg-gray-100"></div><button @click="handleConfirm" class="flex-1 py-3 text-blue-600 font-bold text-sm">确定</button></div></div></div></transition>

    <!-- 语音输入弹窗 -->
    <transition name="scale">
        <div v-if="voiceInputModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl p-6 flex flex-col items-center">
                <div class="w-16 h-16 rounded-full bg-green-50 flex items-center justify-center mb-4 text-green-600 text-2xl animate-pulse">
                    <i class="fas fa-microphone"></i>
                </div>
                <h3 class="text-lg font-bold mb-2">语音输入</h3>
                <textarea v-model="voiceInputModal.content" placeholder="输入文字模拟语音..." class="w-full h-24 bg-gray-50 p-3 rounded-xl text-sm border border-gray-100 outline-none resize-none mb-4"></textarea>
                <div class="flex gap-3 w-full">
                    <button @click="voiceInputModal.show = false" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold text-sm">取消</button>
                    <button @click="sendVoiceMessage" class="flex-1 py-3 bg-black text-white rounded-xl font-bold text-sm">发送语音</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- 聊天专属头像设置弹窗 -->
    <transition name="scale">
        <div v-if="avatarSettingModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl p-6 flex flex-col items-center">
                <h3 class="text-lg font-bold mb-6">设置本聊专属头像</h3>
                <div class="flex gap-8 mb-6">
                    <div class="flex flex-col items-center gap-2">
                         <div class="w-20 h-20 rounded-full bg-gray-100 overflow-hidden relative cursor-pointer border border-gray-200" @click="triggerAvatarUpload('self')">
                             <img v-if="avatarSettingModal.selfUrl" :src="avatarSettingModal.selfUrl" class="w-full h-full object-cover">
                             <div v-else class="w-full h-full flex items-center justify-center text-gray-400 flex-col">
                                 <i class="fas fa-user mb-1"></i><span class="text-[10px]">我</span>
                             </div>
                         </div>
                         <button class="text-xs text-blue-500" @click="avatarSettingModal.selfUrl=''">恢复默认</button>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                         <div class="w-20 h-20 rounded-full bg-gray-100 overflow-hidden relative cursor-pointer border border-gray-200" @click="triggerAvatarUpload('target')">
                             <img v-if="avatarSettingModal.targetUrl" :src="avatarSettingModal.targetUrl" class="w-full h-full object-cover">
                             <div v-else class="w-full h-full flex items-center justify-center text-gray-400 flex-col">
                                 <i class="fas fa-user-friends mb-1"></i><span class="text-[10px]">对方</span>
                             </div>
                         </div>
                         <button class="text-xs text-blue-500" @click="avatarSettingModal.targetUrl=''">恢复默认</button>
                    </div>
                </div>
                <div class="flex gap-3 w-full">
                    <button @click="avatarSettingModal.show = false" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold text-sm">取消</button>
                    <button @click="saveAvatarSetting" class="flex-1 py-3 bg-black text-white rounded-xl font-bold text-sm">保存</button>
                </div>
            </div>
            <input type="file" ref="avatarSettingInput" accept="image/*" class="hidden" @change="handleAvatarUpload">
        </div>
    </transition>

    <!-- 红包填写弹窗 -->
    <transition name="scale">
        <div v-if="redPacketModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-[#f3f4f6] w-[85%] rounded-[12px] overflow-hidden shadow-2xl flex flex-col items-center animate-scale-in">
                <div class="w-full bg-[#ea5f39] p-4 text-center text-[#fce8cd] font-medium text-lg relative">
                    发红包
                    <div class="absolute right-4 top-4 text-sm cursor-pointer" @click="redPacketModal.show = false">取消</div>
                </div>
                <div class="p-6 w-full space-y-4">
                    <div class="bg-white rounded-lg p-3 flex items-center">
                        <span class="text-gray-900 font-medium mr-2">金额</span>
                        <input type="number" v-model="redPacketModal.amount" placeholder="0.00" class="flex-1 bg-transparent text-right outline-none text-lg font-bold placeholder-gray-300">
                        <span class="text-gray-900 font-medium ml-2">元</span>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                         <input v-model="redPacketModal.note" placeholder="恭喜发财，大吉大利" class="w-full bg-transparent outline-none text-base">
                    </div>
                    <div class="text-center text-3xl font-bold my-4">¥{{ redPacketModal.amount || '0.00' }}</div>
                    <button @click="sendRedPacket" class="w-full py-3 bg-[#ea5f39] text-[#fce8cd] rounded-lg font-bold text-base shadow-sm active:bg-[#c24e38]">塞钱进红包</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- 转账填写弹窗 -->
    <transition name="scale">
        <div v-if="transferModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-white/100">
            <div class="w-full h-full flex flex-col bg-white">
                <div class="h-[44px] flex items-center px-4">
                     <i class="fas fa-chevron-left text-lg cursor-pointer" @click="transferModal.show = false"></i>
                </div>
                <div class="p-6 flex flex-col">
                    <div class="flex items-center gap-4 mb-8">
                         <div class="w-12 h-12 rounded-lg overflow-hidden bg-gray-100"><img :src="getChatAvatar({isSelf: false, targetId: wechatState.activeSession.targetId})" class="w-full h-full object-cover"></div>
                         <div>
                             <div class="font-bold text-lg">{{ wechatState.activeSession?.name }}</div>
                             <div class="text-gray-400 text-sm">微信号: {{ getCurrentSessionId() }}</div>
                         </div>
                    </div>
                    <div class="text-sm text-gray-500 mb-4">转账金额</div>
                    <div class="flex items-end gap-2 border-b border-gray-100 pb-2 mb-6">
                        <span class="text-4xl font-bold">¥</span>
                        <input type="number" v-model="transferModal.amount" placeholder="" class="flex-1 bg-transparent outline-none text-5xl font-bold h-16">
                    </div>
                    <div class="flex items-center justify-between mb-8">
                         <input v-model="transferModal.note" placeholder="添加转账说明" class="text-sm text-gray-500 bg-transparent outline-none w-full">
                    </div>
                    <button @click="sendTransfer" class="w-full py-3.5 bg-[#07c160] text-white rounded-lg font-bold text-base shadow-sm active:opacity-90">转账</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- 亲密付选择弹窗 (入口) -->
    <transition name="scale">
        <div v-if="qinmiSelectModal.show" class="fixed inset-0 z-[62000] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl p-6 flex flex-col items-center">
                <div class="w-16 h-16 rounded-full bg-red-50 flex items-center justify-center mb-4 text-[#d95556] text-3xl">
                    <i class="fas fa-heart"></i>
                </div>
                <h3 class="text-lg font-bold mb-6">亲密付</h3>
                <div class="flex gap-4 w-full">
                    <button @click="startQinmiProcess('give')" class="flex-1 flex flex-col items-center gap-2 p-4 bg-red-50 rounded-xl active:scale-95 transition">
                        <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#d95556] shadow-sm"><i class="fas fa-gift"></i></div>
                        <span class="font-bold text-sm text-[#d95556]">我给TA开通</span>
                        <span class="text-[10px] text-gray-400">我为TA买单</span>
                    </button>
                    <button @click="startQinmiProcess('ask')" class="flex-1 flex flex-col items-center gap-2 p-4 bg-blue-50 rounded-xl active:scale-95 transition">
                        <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-blue-500 shadow-sm"><i class="fas fa-hand-holding-heart"></i></div>
                        <span class="font-bold text-sm text-blue-600">求TA帮我开通</span>
                        <span class="text-[10px] text-gray-400">TA为我买单</span>
                    </button>
                </div>
                <div class="mt-4 text-xs text-gray-400 cursor-pointer" @click="qinmiSelectModal.show = false">取消</div>
            </div>
        </div>
    </transition>

    <!-- 支付方式选择弹窗 (消费模拟) -->
    <transition name="app-slide">
        <div v-if="paymentSelectModal.show" class="fixed inset-0 z-[70000]">
             <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="paymentSelectModal.show = false"></div>
             <div class="ios-list-modal bg-white">
                 <div class="p-4 text-center font-bold border-b border-gray-100 relative">
                     确认支付
                     <i class="fas fa-times absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer" @click="paymentSelectModal.show = false"></i>
                 </div>
                 <div class="p-8 text-center">
                     <div class="text-3xl font-bold">¥{{ paymentSelectModal.amount }}</div>
                     <div class="text-gray-400 text-sm mt-1">模拟消费</div>
                 </div>
                 <div class="px-4 pb-8 space-y-2">
                     <div class="text-xs text-gray-400 ml-2 mb-1">选择付款方式</div>
                     <div @click="confirmPayment('balance')" class="p-4 rounded-xl border border-gray-100 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                         <div class="flex items-center gap-3">
                             <i class="fas fa-wallet text-green-500 text-xl"></i>
                             <div>
                                 <div class="font-bold text-sm">零钱</div>
                                 <div class="text-xs text-gray-400">余额: ¥{{ wallet.balance }}</div>
                             </div>
                         </div>
                         <i class="fas fa-check text-green-500" v-if="wallet.balance >= paymentSelectModal.amount"></i>
                     </div>
                     <div v-for="pay in getAvailableQinmiSources()" :key="pay.id" @click="confirmPayment('qinmi', pay)" class="p-4 rounded-xl border border-gray-100 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                         <div class="flex items-center gap-3">
                             <i class="fas fa-heart text-[#d95556] text-xl"></i>
                             <div>
                                 <div class="font-bold text-sm">亲密付 ({{ getFriendName(pay.targetId) }})</div>
                                 <div class="text-xs text-gray-400">剩余额度: ¥{{ (pay.limit - pay.balanceUsed).toFixed(2) }}</div>
                             </div>
                         </div>
                         <i class="fas fa-chevron-right text-gray-300"></i>
                     </div>
                 </div>
             </div>
        </div>
    </transition>

    <!-- 消息弹窗 -->
    <transition name="app-slide">
        <div v-if="globalNotification.show" class="top-notification-banner" @click="jumpToChat(globalNotification.sessionId)">
            <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden shrink-0"><img :src="globalNotification.avatar" class="w-full h-full object-cover"></div>
            <div class="flex-1 min-w-0"><div class="font-bold text-sm truncate">{{ globalNotification.title }}</div><div class="text-xs text-gray-500 truncate">{{ globalNotification.content }}</div></div>
            <span class="text-xs text-gray-400">现在</span>
        </div>
    </transition>

    <!-- 长按菜单 遮罩层 -->
    <div v-if="chatContextMenu.show" class="fixed inset-0 z-[99998] bg-transparent" @click.stop="closeAllMenus"></div>
    <transition name="fade">
        <div v-if="chatContextMenu.show" class="chat-context-menu" :style="{top: chatContextMenu.y + 'px', left: chatContextMenu.x + 'px'}" @click.stop>
            <div class="context-item" @click="handleChatMenuAction('copy')"><i class="far fa-copy text-lg"></i><span>复制</span></div>
            <div class="context-item" @click="handleChatMenuAction('forward')"><i class="fas fa-share text-lg"></i><span>转发</span></div>
            <div class="context-item" @click="handleChatMenuAction('edit')"><i class="fas fa-pen text-lg"></i><span>编辑</span></div>
            <div class="context-item" @click="handleChatMenuAction('favorite')"><i class="fas fa-cube text-lg"></i><span>收藏</span></div>
            <div class="context-item" @click="handleChatMenuAction('delete')"><i class="far fa-trash-alt text-lg"></i><span>删除</span></div>
            <div class="context-item" @click="handleChatMenuAction('multi')"><i class="fas fa-list-check text-lg"></i><span>多选</span></div>
            <div class="context-item" @click="handleChatMenuAction('quote')"><i class="fas fa-quote-right text-lg"></i><span>引用</span></div>
            <div v-if="chatContextMenu.isSelf" class="context-item" @click="handleChatMenuAction('recall')"><i class="fas fa-undo text-lg"></i><span>撤回</span></div>
            <div v-if="!chatContextMenu.isSelf" class="context-item" @click="handleChatMenuAction('regenerate')"><i class="fas fa-sync-alt text-lg"></i><span>重回</span></div>
        </div>
    </transition>

    <!-- 弹窗组件 -->
    <transition name="scale"><div v-if="modelSelectModal.show" class="fixed inset-0 z-[65000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl flex flex-col max-h-[60vh]"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white"><h3 class="font-bold text-lg text-gray-900">选择模型</h3><button @click="modelSelectModal.show = false" class="text-gray-400 font-medium text-sm">关闭</button></div><div class="flex-1 overflow-y-auto p-2 space-y-1"><div v-if="availableModels.length===0" class="p-4 text-center text-xs text-gray-400">列表为空</div><div v-for="model in availableModels" :key="model" @click="selectModel(model)" class="p-3.5 rounded-xl flex items-center justify-between active:bg-gray-50 transition" :class="apiConfig.selectedModel === model ? 'bg-blue-50' : ''"><span class="font-bold text-sm text-gray-800">{{ model }}</span><i v-if="apiConfig.selectedModel === model" class="fas fa-check text-blue-500"></i></div></div></div></div></transition>

    <!-- 世界书绑定弹窗 -->
    <transition name="scale">
        <div v-if="worldBinderModal.show" class="fixed inset-0 z-[65000] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl flex flex-col max-h-[60vh]">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white"><h3 class="font-bold text-lg text-gray-900">绑定世界书 (多选)</h3><button @click="worldBinderModal.show = false" class="text-blue-500 font-bold text-sm">完成</button></div>
                <div class="flex-1 overflow-y-auto p-2 space-y-1">
                    <div @click="bindWorldFolder(null)" class="p-3.5 rounded-xl border border-dashed border-gray-200 text-center text-gray-400 text-xs active:bg-gray-50 mb-2">不绑定 (默认)</div>
                    <div v-for="folder in folders" :key="folder.id" @click="toggleWorldBinding(folder.id)" class="p-3.5 rounded-xl flex items-center justify-between active:bg-gray-50 transition border border-gray-50">
                        <div class="flex items-center gap-3"><i class="fas fa-folder text-yellow-400"></i><span class="font-bold text-sm text-gray-800">{{ folder.name }}</span></div>
                        <div class="w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center transition" :class="isFolderBound(folder.id) ? 'bg-black border-black' : ''">
                            <i v-if="isFolderBound(folder.id)" class="fas fa-check text-white text-xs"></i>
                        </div>
                    </div>
                    <div v-if="folders.length===0" class="text-center text-xs text-gray-400 py-8">暂无文件夹</div>
                </div>
            </div>
        </div>
    </transition>
    
    <!-- 文件夹选择弹窗 -->
    <transition name="app-slide">
        <div v-if="folderSelectModal.show" class="fixed inset-0 z-[66000]">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="folderSelectModal.show = false"></div>
            <div class="ios-list-modal">
                <div class="ios-list-header">选择文件夹 <button class="absolute right-4 text-blue-500 font-normal text-sm" @click="folderSelectModal.show = false">取消</button></div>
                <div class="ios-list-content">
                    <div class="ios-list-item" @click="selectWorldFolder(null)"><span class="text-gray-800 font-medium">根目录 (不归类)</span><i v-if="!worldModal.parentId" class="fas fa-check text-blue-500"></i></div>
                    <div v-for="folder in folders" :key="folder.id" class="ios-list-item" @click="selectWorldFolder(folder.id)">
                        <div class="flex items-center gap-2"><i class="fas fa-folder text-yellow-400"></i><span class="text-gray-800 font-medium">{{ folder.name }}</span></div>
                        <i v-if="worldModal.parentId === folder.id" class="fas fa-check text-blue-500"></i>
                    </div>
                    <div v-if="folders.length===0" class="p-4 text-center text-gray-400 text-xs">暂无文件夹</div>
                </div>
            </div>
        </div>
    </transition>

    <!-- 分组选择弹窗 -->
    <transition name="app-slide">
        <div v-if="groupSelectModal.show" class="fixed inset-0 z-[70000]">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="groupSelectModal.show = false"></div>
            <div class="ios-list-modal">
                <div class="ios-list-header">选择分组 <button class="absolute right-4 text-blue-500 font-normal text-sm" @click="groupSelectModal.show = false">取消</button></div>
                <div class="ios-list-content">
                    <div class="ios-list-item" @click="assignToGroup(null)"><span class="text-gray-800 font-medium">不分组 (默认)</span><i v-if="!wechatState.activeSession?.groupId" class="fas fa-check text-blue-500"></i></div>
                    <div v-for="group in wechatState.groups" :key="group.id" class="ios-list-item" @click="assignToGroup(group.id)"><div class="flex items-center gap-2"><i class="fas fa-folder text-yellow-400"></i><span class="text-gray-800 font-medium">{{ group.name }}</span></div><i v-if="wechatState.activeSession?.groupId === group.id" class="fas fa-check text-blue-500"></i></div>
                </div>
            </div>
        </div>
    </transition>

    <!-- 转发联系人选择弹窗 -->
    <transition name="app-slide">
        <div v-if="forwardModal.show" class="fixed inset-0 z-[70000]">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="forwardModal.show = false"></div>
            <div class="ios-list-modal h-[80vh]">
                <div class="ios-list-header">
                    {{ forwardModal.mode === 'qinmi' ? '选择好友开通亲密付' : (forwardModal.mode === 'moment' ? '发送给...' : '转发给...') }}
                    <button class="absolute right-4 text-gray-500 font-normal text-sm" @click="forwardModal.show = false">取消</button>
                </div>
                <div class="ios-list-content">
                    <div v-if="wechatState.friendList.length === 0" class="p-8 text-center text-gray-400">暂无联系人</div>
                    <div v-for="friend in wechatState.friendList" :key="friend.id" class="ios-list-item cursor-pointer" @click="handleFriendSelect(friend)">
                        <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden"><img :src="friend.avatar" class="w-full h-full object-cover"></div><span class="text-gray-900 font-bold">{{ friend.remark || friend.name }}</span></div>
                        <button class="bg-black text-white px-3 py-1 rounded text-xs font-bold">{{ forwardModal.mode === 'qinmi' ? '选择' : '发送' }}</button>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- 提醒谁看 弹窗 -->
    <transition name="app-slide">
        <div v-if="mentionModal.show" class="fixed inset-0 z-[71000] bg-gray-50 flex flex-col">
            <header class="h-[90px] pt-10 px-4 flex items-center justify-between bg-white border-b border-gray-100 sticky top-0 z-10">
                <button @click="mentionModal.show = false" class="text-gray-500 font-medium text-sm">取消</button>
                <h1 class="text-[17px] font-bold">提醒谁看</h1>
                <button @click="saveMentions" class="bg-[#07c160] text-white px-3 py-1.5 rounded text-sm font-bold">完成</button>
            </header>
            <div class="flex-1 overflow-y-auto p-4 bg-white">
                 <div v-if="wechatState.friendList.length === 0" class="p-8 text-center text-gray-400 text-sm">暂无联系人</div>
                 <div v-for="friend in wechatState.friendList" :key="friend.id" @click="toggleMention(friend.id)" class="flex items-center gap-3 p-3 border-b border-gray-50 last:border-0 cursor-pointer active:bg-gray-50">
                     <div class="w-5 h-5 rounded-full border flex items-center justify-center transition" :class="mentionModal.selectedIds.includes(friend.id) ? 'bg-[#07c160] border-[#07c160]' : 'border-gray-300'"><i v-if="mentionModal.selectedIds.includes(friend.id)" class="fas fa-check text-white text-xs"></i></div>
                     <div class="w-10 h-10 rounded bg-gray-100 overflow-hidden"><img :src="friend.avatar" class="w-full h-full object-cover"></div>
                     <span class="font-medium text-gray-900">{{ friend.remark || friend.name }}</span>
                 </div>
            </div>
        </div>
    </transition>

    <!-- 谁可以看 选项弹窗 -->
    <transition name="app-slide">
        <div v-if="visibilityModal.show" class="fixed inset-0 z-[71000]">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="visibilityModal.show = false"></div>
            <div class="ios-list-modal">
                <div class="ios-list-header">谁可以看 <button class="absolute right-4 text-blue-500 font-normal text-sm" @click="visibilityModal.show = false">取消</button></div>
                <div class="ios-list-content p-0 bg-white">
                    <div class="p-4 border-b border-gray-50 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="selectVisibility('public')">
                        <div><div class="font-bold text-gray-900">公开</div><div class="text-xs text-gray-500 mt-1">所有朋友可见</div></div>
                        <i v-if="newMoment.visibility === 'public'" class="fas fa-check text-[#07c160]"></i>
                    </div>
                    <div class="p-4 border-b border-gray-50 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="selectVisibility('private')">
                        <div><div class="font-bold text-gray-900">私密</div><div class="text-xs text-gray-500 mt-1">仅自己可见</div></div>
                        <i v-if="newMoment.visibility === 'private'" class="fas fa-check text-[#07c160]"></i>
                    </div>
                    <div class="p-4 border-b border-gray-50 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="selectVisibility('share_to')">
                        <div><div class="font-bold text-gray-900">部分可见</div><div class="text-xs text-gray-500 mt-1">选中的朋友可见</div></div>
                        <i class="fas fa-chevron-right text-gray-300 text-sm"></i>
                    </div>
                    <div class="p-4 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="selectVisibility('dont_share_to')">
                        <div><div class="font-bold text-gray-900">不给谁看</div><div class="text-xs text-gray-500 mt-1">选中的朋友不可见</div></div>
                        <i class="fas fa-chevron-right text-gray-300 text-sm"></i>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- 部分可见/不给谁看 选择目标弹窗 -->
    <transition name="app-slide">
        <div v-if="visibilityTargetModal.show" class="fixed inset-0 z-[72000] bg-gray-50 flex flex-col">
            <header class="h-[90px] pt-10 px-4 flex items-center justify-between bg-white border-b border-gray-100 sticky top-0 z-10">
                <button @click="visibilityTargetModal.show = false" class="text-gray-500 font-medium text-sm">取消</button>
                <h1 class="text-[17px] font-bold">{{ visibilityTargetModal.mode === 'share_to' ? '部分可见' : '不给谁看' }}</h1>
                <button @click="saveVisibilityTargets" class="bg-[#07c160] text-white px-3 py-1.5 rounded text-sm font-bold">完成</button>
            </header>
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4">
                <!-- 从分组选择 -->
                <div class="bg-white rounded-xl overflow-hidden border border-gray-100 shadow-sm">
                    <div class="p-3 bg-gray-50 border-b border-gray-100 text-xs font-bold text-gray-500">选择分组</div>
                    <div v-if="!wechatState.groups || wechatState.groups.length === 0" class="p-4 text-center text-xs text-gray-400">暂无分组</div>
                    <div v-for="group in wechatState.groups" :key="group.id" @click="toggleVisibilityGroup(group.id)" class="flex items-center gap-3 p-3 border-b border-gray-50 last:border-0 cursor-pointer active:bg-gray-50">
                        <div class="w-5 h-5 rounded-full border flex items-center justify-center transition" :class="visibilityTargetModal.selectedGroupIds.includes(group.id) ? 'bg-[#07c160] border-[#07c160]' : 'border-gray-300'"><i v-if="visibilityTargetModal.selectedGroupIds.includes(group.id)" class="fas fa-check text-white text-xs"></i></div>
                        <i class="fas fa-users text-blue-500 w-8 text-center text-lg"></i>
                        <span class="font-medium text-gray-900">{{ group.name }}</span>
                    </div>
                </div>
                <!-- 从好友选择 -->
                <div class="bg-white rounded-xl overflow-hidden border border-gray-100 shadow-sm">
                    <div class="p-3 bg-gray-50 border-b border-gray-100 text-xs font-bold text-gray-500">选择联系人</div>
                    <div v-if="wechatState.friendList.length === 0" class="p-4 text-center text-xs text-gray-400">暂无联系人</div>
                    <div v-for="friend in wechatState.friendList" :key="friend.id" @click="toggleVisibilityFriend(friend.id)" class="flex items-center gap-3 p-3 border-b border-gray-50 last:border-0 cursor-pointer active:bg-gray-50">
                        <div class="w-5 h-5 rounded-full border flex items-center justify-center transition" :class="visibilityTargetModal.selectedFriendIds.includes(friend.id) ? 'bg-[#07c160] border-[#07c160]' : 'border-gray-300'"><i v-if="visibilityTargetModal.selectedFriendIds.includes(friend.id)" class="fas fa-check text-white text-xs"></i></div>
                        <div class="w-8 h-8 rounded bg-gray-100 overflow-hidden"><img :src="friend.avatar" class="w-full h-full object-cover"></div>
                        <span class="font-medium text-gray-900">{{ friend.remark || friend.name }}</span>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- 生成朋友圈弹窗 (多选好友) -->
    <transition name="app-slide">
        <div v-if="momentGenerateModal.show" class="fixed inset-0 z-[71000] bg-gray-50 flex flex-col">
            <header class="h-[90px] pt-10 px-4 flex items-center justify-between bg-white border-b border-gray-100 sticky top-0 z-10">
                <button @click="momentGenerateModal.show = false" class="text-gray-500 font-medium text-sm">取消</button>
                <h1 class="text-[17px] font-bold">选择生成 (最多5个)</h1>
                <button @click="confirmGenerateMoments" class="bg-black text-white px-3 py-1.5 rounded text-sm font-bold">生成</button>
            </header>
            <div class="flex-1 overflow-y-auto p-4 bg-white">
                 <div v-if="wechatState.friendList.length === 0" class="p-8 text-center text-gray-400 text-sm">暂无联系人</div>
                 <div v-for="friend in wechatState.friendList" :key="friend.id" @click="toggleGenerateMomentFriend(friend.id)" class="flex items-center gap-3 p-3 border-b border-gray-50 last:border-0 cursor-pointer active:bg-gray-50">
                     <div class="w-5 h-5 rounded-full border flex items-center justify-center transition" :class="momentGenerateModal.selectedIds.includes(friend.id) ? 'bg-black border-black' : 'border-gray-300'"><i v-if="momentGenerateModal.selectedIds.includes(friend.id)" class="fas fa-check text-white text-xs"></i></div>
                     <div class="w-10 h-10 rounded bg-gray-100 overflow-hidden"><img :src="friend.avatar" class="w-full h-full object-cover"></div>
                     <span class="font-medium text-gray-900">{{ friend.remark || friend.name }}</span>
                 </div>
            </div>
        </div>
    </transition>

    <!-- AI 心声弹窗 -->
    <transition name="scale">
        <div v-if="statusModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm" @click="statusModal.show = false">
            <div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl p-6 relative" @click.stop>
                <div class="absolute top-4 right-4 text-gray-400 cursor-pointer" @click="openStatusHistory"><i class="far fa-clock text-xl"></i></div>
                <div class="text-center mb-6">
                    <div class="w-20 h-20 rounded-full bg-gray-100 mx-auto mb-3 overflow-hidden border-2 border-white shadow-lg"><img :src="getChatAvatar({isSelf: false, targetId: wechatState.activeSession.targetId})" class="w-full h-full object-cover"></div>
                    <h3 class="text-xl font-bold text-gray-900">{{ wechatState.activeSession?.name }}</h3>
                    <p class="text-xs text-gray-400 mt-1">Current State</p>
                </div>
                <div class="space-y-4 text-sm">
                    <div class="flex gap-3"><div class="w-8 shrink-0 text-gray-400 font-bold text-right">动作</div><div class="text-gray-800">{{ currentStatus.action || '无' }}</div></div>
                    <div class="flex gap-3"><div class="w-8 shrink-0 text-gray-400 font-bold text-right">心声</div><div class="text-gray-800 italic">"{{ currentStatus.thought || '...' }}"</div></div>
                    <div class="flex gap-3"><div class="w-8 shrink-0 text-gray-400 font-bold text-right">穿着</div><div class="text-gray-800">{{ currentStatus.outfit || '未知' }}</div></div>
                    <div class="flex gap-3"><div class="w-8 shrink-0 text-gray-400 font-bold text-right">随笔</div><div class="text-gray-600 bg-gray-50 p-2 rounded-lg text-xs leading-relaxed">{{ currentStatus.note || '无随笔' }}</div></div>
                </div>
            </div>
        </div>
    </transition>

    <!-- 心声历史记录 -->
    <transition name="app-slide">
        <div v-if="statusHistoryModal.show" class="fixed inset-0 z-[61000] bg-gray-50 flex flex-col">
            <div class="h-[60px] px-4 flex items-center justify-between bg-white border-b border-gray-100 pt-safe">
                <button @click="statusHistoryModal.show = false" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-chevron-left"></i></button>
                <h1 class="text-md font-bold">心声历史</h1>
                <!-- 多选按钮 -->
                <button @click="toggleStatusMultiSelect" class="text-sm font-bold text-black" style="width: auto; min-width: 32px;">
                    {{ isStatusMultiSelectMode ? '完成' : '多选' }}
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4 pb-20">
                <div v-if="!currentStatusHistory || currentStatusHistory.length===0" class="text-center text-gray-400 mt-20 text-xs">暂无历史记录</div>
                <div v-for="(rec, idx) in currentStatusHistory" :key="idx" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-3" @click="isStatusMultiSelectMode ? toggleSelectStatus(idx) : null">
                    <!-- 多选框 -->
                    <div v-if="isStatusMultiSelectMode" class="self-center">
                        <div class="w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center transition" :class="selectedStatusIndices.includes(idx) ? 'bg-black border-black' : 'bg-white'">
                            <i v-if="selectedStatusIndices.includes(idx)" class="fas fa-check text-white text-[10px]"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="text-xs text-gray-400 mb-2 border-b border-gray-50 pb-2">{{ formatChatTime(rec.time) }}</div>
                        <div class="space-y-2 text-xs">
                            <p><span class="font-bold text-gray-500">心声:</span> {{ rec.thought }}</p>
                            <p><span class="font-bold text-gray-500">随笔:</span> {{ rec.note }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 心声多选操作栏 -->
            <transition name="app-slide">
                <div v-if="isStatusMultiSelectMode" class="absolute bottom-0 left-0 w-full bg-white border-t border-gray-100 h-[60px] pb-safe flex items-center justify-around z-10 shadow-lg">
                    <button @click="deleteSelectedStatus" class="flex flex-col items-center text-gray-500"><i class="far fa-trash-alt text-lg"></i><span class="text-[10px]">删除</span></button>
                    <button @click="favoriteSelectedStatus" class="flex flex-col items-center text-gray-500"><i class="fas fa-cube text-lg"></i><span class="text-[10px]">收藏</span></button>
                </div>
            </transition>
        </div>
    </transition>
    
    <!-- 收藏夹弹窗 -->
    <transition name="app-slide">
        <div v-if="favoritesModal.show" class="fixed inset-0 z-[75000] bg-gray-50 flex flex-col">
            <header class="bg-white h-[60px] px-4 flex items-center justify-between border-b border-gray-100 pt-safe sticky top-0">
                <button @click="favoritesModal.show = false" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-chevron-left"></i></button>
                <h1 class="text-md font-bold">我的收藏</h1>
                <div class="w-8"></div>
            </header>
            <div class="flex-1 overflow-y-auto p-4 space-y-3">
                <div v-if="favorites.length === 0" class="text-center text-gray-400 mt-20 text-xs">暂无收藏内容</div>
                <div v-for="(item, idx) in favorites" :key="idx" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative group">
                     <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 font-bold">{{ item.type === 'status' ? '心声' : '聊天' }}</span>
                            <span class="text-xs font-bold text-gray-700">{{ item.source }}</span>
                        </div>
                        <span class="text-[10px] text-gray-300">{{ formatChatTime(item.time) }}</span>
                     </div>
                     <div class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">{{ item.content }}</div>
                     <button @click="deleteFavorite(idx)" class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center text-gray-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                </div>
            </div>
        </div>
    </transition>

    <!-- 表情包管理全屏弹窗 -->
    <transition name="app-slide">
        <div v-if="showStickerManager" class="fixed inset-0 z-[50000] bg-gray-50 flex flex-col">
            <header class="bg-white h-[90px] pt-10 px-4 flex items-center justify-between border-b border-gray-100 sticky top-0 z-10">
                <button @click="showStickerManager = false" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-chevron-left"></i></button>
                <h1 class="text-[17px] font-bold">表情管理</h1>
                <div class="flex items-center gap-3">
                    <button @click="triggerStickerUpload" class="text-black"><i class="fas fa-image text-lg"></i></button>
                    <button @click="openUrlImportModal" class="text-black"><i class="fas fa-link text-lg"></i></button>
                    <button @click="toggleStickerMultiSelect" :class="isStickerMultiSelect ? 'text-red-500' : 'text-black'"><i class="fas fa-check-square text-lg"></i></button>
                </div>
            </header>
            
            <!-- 分组 Tab -->
            <div class="bg-white px-2 py-2 flex gap-2 overflow-x-auto border-b border-gray-100 scrollbar-hide shrink-0">
                <div v-for="group in stickerGroups" :key="group.id" 
                     class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition cursor-pointer flex items-center gap-2"
                     :class="activeStickerGroupId === group.id ? 'bg-black text-white' : 'bg-gray-100 text-gray-500'"
                     @click="handleGroupClick(group)">
                    {{ group.name }}
                </div>
                <div @click="addStickerGroup" class="w-8 h-7 flex items-center justify-center rounded-full bg-gray-100 text-gray-400 cursor-pointer shrink-0"><i class="fas fa-plus text-xs"></i></div>
            </div>

            <!-- 表情列表 -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="grid grid-cols-4 gap-4">
                    <div v-for="sticker in filteredStickers" :key="sticker.id" 
                         class="aspect-square rounded-lg bg-white p-2 border border-gray-100 relative shadow-sm flex items-center justify-center"
                         @click="handleStickerClick(sticker)">
                        <img :src="sticker.url" class="w-full h-full object-contain">
                        <!-- 多选勾选框 -->
                        <div v-if="isStickerMultiSelect" class="absolute top-1 right-1 w-5 h-5 rounded-full border border-gray-300 bg-white flex items-center justify-center" :class="{'bg-black border-black': selectedStickerIds.includes(sticker.id)}">
                            <i v-if="selectedStickerIds.includes(sticker.id)" class="fas fa-check text-white text-[10px]"></i>
                        </div>
                    </div>
                </div>
                <div v-if="filteredStickers.length === 0" class="text-center text-gray-400 mt-20 text-xs">暂无表情</div>
            </div>

            <!-- 删除底部栏 -->
            <div v-if="isStickerMultiSelect" class="bg-white border-t border-gray-100 p-4 pb-safe shadow-lg">
                <button @click="deleteSelectedStickers" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold text-sm">删除所选 ({{selectedStickerIds.length}})</button>
            </div>

            <input type="file" ref="stickerUploadInput" accept="image/*" class="hidden" multiple @change="handleStickerUpload">
        </div>
    </transition>

    <transition name="scale"><div v-if="chatWizard.show" class="fixed inset-0 z-[55000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[90%] h-[70vh] rounded-2xl overflow-hidden shadow-2xl flex flex-col animate-scale-in"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white"><button @click="closeChatWizard" class="text-gray-500 font-medium text-sm">取消</button><h3 class="font-bold text-lg text-gray-900">{{ chatWizard.step === 1 ? '选择我的面具' : (chatWizard.type === 'single' ? '选择好友' : '选择群成员') }}</h3><button v-if="chatWizard.step === 2 && chatWizard.type === 'group'" @click="finishCreateChat" class="text-black font-bold text-sm bg-gray-100 px-3 py-1 rounded-lg">完成</button></div><div class="flex-1 overflow-y-auto p-4 space-y-3"><div v-if="chatWizard.step === 1"><div v-if="masks.length === 0" class="text-center text-gray-400 mt-20 text-xs">没有可用面具，请去"我-面具"添加</div><div v-for="mask in masks" :key="mask.id" @click="selectWizardMask(mask)" class="bg-white border border-gray-100 p-3 rounded-xl flex items-center gap-3 active:bg-gray-50 cursor-pointer"><div class="w-10 h-10 rounded-full bg-gray-100 overflow-hidden"><img v-if="mask.avatar" :src="mask.avatar" class="w-full h-full object-cover"></div><div class="flex-1"><h4 class="font-bold text-sm">{{ mask.name }}</h4><p class="text-xs text-gray-400">{{ mask.bio || '无介绍' }}</p></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div></div><div v-if="chatWizard.step === 2"><div v-if="wechatState.friendList.length === 0" class="text-center text-gray-400 mt-20 text-xs">通讯录暂无好友</div><div v-for="friend in wechatState.friendList" :key="friend.id" @click="selectWizardContact(friend)" class="bg-white border p-3 rounded-xl flex items-center gap-3 active:bg-gray-50 cursor-pointer transition" :class="chatWizard.selectedContacts.includes(friend.id) ? 'border-black bg-gray-50' : 'border-gray-100'"><div v-if="chatWizard.type === 'group'" class="w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center" :class="{'bg-black border-black': chatWizard.selectedContacts.includes(friend.id)}"><i v-if="chatWizard.selectedContacts.includes(friend.id)" class="fas fa-check text-white text-[10px]"></i></div><div class="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden"><img v-if="friend.avatar" :src="friend.avatar" class="w-full h-full object-cover"></div><span class="font-bold text-sm">{{ friend.remark || friend.name }}</span></div></div></div></div></div></transition>

    <!-- 世界书添加/编辑文件 Modal -->
    <transition name="scale"><div v-if="worldModal.show" class="fixed inset-0 z-[55000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl p-6 space-y-4"><h3 class="text-lg font-bold text-center text-gray-900">{{ worldModal.id ? '编辑文件' : (worldModal.type === 'folder' ? '新建文件夹' : '新建文件') }}</h3><input v-model="worldModal.name" placeholder="请输入名称" class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 outline-none"><div v-if="worldModal.type === 'file'" class="space-y-4"><div class="space-y-1"><label class="text-xs text-gray-500 ml-1">归类文件夹</label><div @click="folderSelectModal.show = true" class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 flex justify-between items-center cursor-pointer text-gray-700"><span :class="worldModal.parentId ? 'text-black' : 'text-gray-400'">{{ getFolderName(worldModal.parentId) }}</span><i class="fas fa-chevron-right text-xs text-gray-300"></i></div></div><textarea v-model="worldModal.content" placeholder="输入文件内容..." class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 outline-none h-32 resize-none"></textarea></div><div class="flex gap-3 pt-2"><button @click="worldModal.show = false" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold text-sm">取消</button><button @click="saveWorldItem" class="flex-1 bg-black text-white py-3 rounded-xl font-bold text-sm">保存</button></div></div></div></transition>
    <transition name="scale"><div v-if="addContactModal.show" class="fixed inset-0 z-[55000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[90%] max-h-[85vh] rounded-[24px] overflow-hidden shadow-2xl flex flex-col animate-scale-in"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10"><button @click="addContactModal.show = false" class="text-gray-500 font-medium text-sm">取消</button><h3 class="font-bold text-lg text-gray-900">{{ newContact.id ? '编辑朋友' : '添加朋友' }}</h3><button @click="saveNewContact" class="text-black font-bold text-sm bg-gray-100 px-3 py-1 rounded-lg">完成</button></div><div class="flex-1 overflow-y-auto p-6 space-y-5"><div class="flex flex-col items-center gap-2"><div class="w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative cursor-pointer active:opacity-70 transition" @click="triggerAddContactAvatar"><img v-if="newContact.avatar" :src="newContact.avatar" class="w-full h-full object-cover"><div v-else class="flex flex-col items-center text-gray-400"><i class="fas fa-camera text-2xl mb-1"></i><span class="text-[10px]">上传头像</span></div></div></div><div class="space-y-4"><div><label class="text-xs text-gray-500 ml-1 mb-1 block">姓名</label><input v-model="newContact.name" placeholder="输入姓名" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">备注</label><input v-model="newContact.remark" placeholder="输入备注名" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">网名 (ID)</label><input v-model="newContact.username" placeholder="输入网名/微信号" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">性别</label><div class="flex gap-3"><div @click="newContact.gender = '男'" class="flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 cursor-pointer transition" :class="newContact.gender==='男'?'bg-blue-50 border-blue-200 text-blue-600':'bg-white border-gray-200 text-gray-500'"><i class="fas fa-mars"></i> 男</div><div @click="newContact.gender = '女'" class="flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 cursor-pointer transition" :class="newContact.gender==='女'?'bg-pink-50 border-pink-200 text-pink-600':'bg-white border-gray-200 text-gray-500'"><i class="fas fa-venus"></i> 女</div></div></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">拍一拍</label><input v-model="newContact.nudge" placeholder="拍一拍后缀" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">个性签名</label><input v-model="newContact.signature" placeholder="输入个性签名" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">背景资料</label><textarea v-model="newContact.bio" placeholder="输入人设、背景故事..." class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none h-24 resize-none"></textarea></div></div></div><input type="file" ref="addContactAvatarInput" accept="image/*" class="hidden" @change="handleAddContactAvatar"></div></div></transition>

    <!-- 状态栏 -->
    <transition name="fade">
        <div v-if="!hideStatusBar" class="h-[44px] flex justify-between items-center px-6 pt-2 text-[15px] z-[5000] absolute top-0 w-full select-none pointer-events-none status-bar-text text-black">
            <span class="w-16 text-center font-semibold">{{ statusBar.time }}</span>
            <div class="flex items-center gap-1.5">
                <i class="fas fa-signal text-[13px]"></i><i class="fas fa-wifi text-[13px] ml-1"></i>
                <div class="relative w-[24px] h-[11.5px] border-[1px] border-current rounded-[3.5px] flex items-center p-[1px] ml-1">
                    <div class="h-full rounded-[1.5px] transition-all duration-500" :class="statusBar.isCharging ? 'bg-green-500' : 'bg-current'" :style="{ width: statusBar.batteryLevel + '%' }"></div>
                    <div class="absolute -right-[3.5px] top-1/2 -translate-y-1/2 w-[1.5px] h-[4px] bg-current rounded-r-[2px]"></div>
                    <i v-if="statusBar.isCharging" class="fas fa-bolt absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[8px] text-white drop-shadow-sm"></i>
                </div>
            </div>
        </div>
    </transition>

    <!-- 主界面 -->
    <div class="h-full w-full flex flex-col items-center pb-safe relative overflow-hidden overflow-y-auto scrollbar-hide transition-all duration-300 bg-center bg-cover" 
         :style="{ backgroundImage: themeConfig.wallpaper ? `url(${themeConfig.wallpaper})` : '', backgroundColor: themeConfig.wallpaper ? 'transparent' : '#f3f4f6' }"
         :class="[hideStatusBar ? 'pt-0' : 'pt-[44px]', {'scale-95 opacity-80': isAppOpen}]">
         <div class="w-full flex flex-col items-center skin-text-container">
            <div class="w-[90%] z-20 mt-2 mb-2 shrink-0"><div class="bg-white/90 backdrop-blur-sm rounded-[20px] p-4 shadow-[0_4px_20px_rgba(0,0,0,0.03)] relative"><div class="flex justify-between items-start mb-3"><div class="flex gap-3"><div class="w-[52px] h-[52px] border border-gray-100 rounded-lg p-0.5 flex flex-col items-center justify-between shrink-0 cursor-pointer active:scale-95 transition bg-white" @click="triggerCardAvatarUpload"><div class="w-full h-[70%] rounded-md overflow-hidden bg-gray-50 relative"><img v-if="cardProfile.avatar" :src="cardProfile.avatar" class="w-full h-full object-cover grayscale opacity-80"><i v-else class="fas fa-user text-gray-300 text-xl flex h-full items-center justify-center"></i></div><span class="text-[8px] opacity-60 scale-90 origin-bottom font-medium truncate w-full text-center" @click.stop="editCardProfile('status')">{{ cardProfile.status }}</span></div><div class="flex flex-col pt-0.5" style="font-size: var(--custom-font-size)"><h2 @click="editCardProfile('name')" class="text-[14px] font-bold tracking-wider mb-0.5 cursor-pointer active:opacity-50" :style="{color: themeConfig.fontColor}">{{ cardProfile.name }}</h2><p @click="editCardProfile('id')" class="text-[10px] opacity-60 font-mono tracking-wide cursor-pointer active:opacity-50" :style="{color: themeConfig.fontColor}">@ {{ cardProfile.id }}</p></div></div><div class="flex items-center gap-1 text-[10px] opacity-60 font-medium pt-1" :style="{color: themeConfig.fontColor}"><span>{{ displayDate.dateString }}</span><i class="fas fa-heart text-[8px]"></i><span>{{ displayDate.dayString }}</span></div></div><div @click="editCardProfile('bio')" class="text-[12px] leading-relaxed font-medium tracking-wide text-justify cursor-pointer active:opacity-50 border-t border-gray-50/20 pt-2" :style="{color: themeConfig.fontColor, fontSize: 'calc(var(--custom-font-size) * 0.9)'}">{{ cardProfile.bio }}</div></div></div>
            <div class="flex flex-col items-center w-full mb-3 z-10 shrink-0" style="font-size: var(--custom-font-size)"><div class="w-20 h-20 rounded-full p-1 bg-gradient-to-tr from-gray-200 to-white shadow-lg mb-2 cursor-pointer active:scale-95 transition" @click="triggerHomeAvatarUpload"><div class="w-full h-full rounded-full overflow-hidden bg-gray-100 relative"><img v-if="homeProfile.avatar" :src="homeProfile.avatar" class="w-full h-full object-cover"><i v-else class="fas fa-user text-gray-300 text-3xl flex h-full items-center justify-center"></i></div></div><h2 @click="editHomeProfile('name')" class="text-lg font-bold tracking-wide cursor-pointer active:opacity-50 transition" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ homeProfile.name }}</h2><p @click="editHomeProfile('id')" class="text-xs opacity-80 mt-1 font-mono tracking-wider cursor-pointer active:opacity-50 transition" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow': themeConfig.wallpaper}">@{{ homeProfile.id }}</p><p @click="editHomeProfile('bio')" class="text-[10px] opacity-80 mt-2 tracking-[0.1em] cursor-pointer active:opacity-50 transition px-8 text-center" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow': themeConfig.wallpaper}">{{ homeProfile.bio }}</p><div @click="editHomeProfile('location')" class="mt-3 flex items-center gap-1 text-xs opacity-80 cursor-pointer active:opacity-50 transition" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow': themeConfig.wallpaper}"><i class="fas fa-map-marker-alt"></i><span>{{ homeProfile.location }}</span></div></div>
            <div class="w-full px-8 grid grid-cols-2 gap-6 mb-auto z-10 items-start shrink-0" style="font-size: var(--custom-font-size)"><div class="flex flex-col items-center"><h3 @click="editHomeConfig('widgetTitle', '修改左侧标题')" class="text-sm font-bold mb-4 cursor-pointer active:opacity-50 transition self-start pl-2" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ homeConfig.widgetTitle }}</h3><div class="grid grid-cols-2 gap-x-5 gap-y-5 justify-items-center w-full"><div v-for="id in ['wechat', 'themes', 'worldbook', 'settings']" :key="id" class="flex flex-col items-center gap-1.5 home-icon cursor-pointer" :class="{'home-icon-custom': hasCustomIcon(id)}" @click="handleAppClick(id)"><div class="w-12 h-12 rounded-xl bg-white text-gray-400 flex items-center justify-center text-xl shadow-sm border border-gray-100 overflow-hidden"><img v-if="hasCustomIcon(id)" :src="getAppIcon(id)" class="w-full h-full object-cover"><i v-else :class="getDefaultIconClass(id)"></i></div><span class="text-[10px] font-bold" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow': themeConfig.wallpaper}">{{ getAppName(id) }}</span></div></div></div><div class="flex flex-col items-center"><div class="flex gap-3 justify-center items-end mt-4"><div class="flex flex-col items-center relative w-16"><div @click="editCustomWidget(0, 'bubble')" class="widget-bubble cursor-pointer active:scale-95 transition">{{ customWidgets[0].bubble }}</div><div class="w-14 h-14 rounded-full border-2 border-white shadow-md overflow-hidden bg-gray-100 cursor-pointer active:scale-95 transition" @click="triggerWidgetImageUpload(0)"><img v-if="customWidgets[0].image" :src="customWidgets[0].image" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-gray-300 text-xs">图</div></div><span @click="editCustomWidget(0, 'label')" class="text-[11px] font-bold mt-1 cursor-pointer active:opacity-50" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ customWidgets[0].label }}</span></div><div class="flex flex-col items-center relative w-16"><div @click="editCustomWidget(1, 'bubble')" class="widget-bubble cursor-pointer active:scale-95 transition">{{ customWidgets[1].bubble }}</div><div class="w-14 h-14 rounded-full border-2 border-white shadow-md overflow-hidden bg-gray-100 cursor-pointer active:scale-95 transition" @click="triggerWidgetImageUpload(1)"><img v-if="customWidgets[1].image" :src="customWidgets[1].image" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-gray-300 text-xs">图</div></div><span @click="editCustomWidget(1, 'label')" class="text-[11px] font-bold mt-1 cursor-pointer active:opacity-50" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ customWidgets[1].label }}</span></div></div><h3 @click="editHomeConfig('rightWidgetTitle', '修改右侧标题')" class="text-sm font-bold mt-6 cursor-pointer active:opacity-50 transition" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ homeConfig.rightWidgetTitle }}</h3></div></div>
        </div>
        <div class="dock-container w-full h-24 flex items-center justify-around px-4 mt-6 mb-4 absolute bottom-4 shrink-0"><div v-for="id in ['icity', 'forum', 'check', 'pinxixi']" :key="id" class="flex flex-col items-center gap-1 home-icon cursor-pointer" :class="{'home-icon-custom': hasCustomIcon(id)}" @click="showToast('仅作为展示')"><div class="w-12 h-12 rounded-xl bg-white shadow-sm flex items-center justify-center text-gray-400 text-lg overflow-hidden"><img v-if="hasCustomIcon(id)" :src="getAppIcon(id)" class="w-full h-full object-cover"><i v-else :class="getDefaultIconClass(id)"></i></div><span class="text-[10px] font-bold text-gray-600">{{ getAppName(id) }}</span></div></div>
        <input type="file" ref="homeAvatarInput" accept="image/*" class="hidden" @change="handleHomeAvatarChange"><input type="file" ref="cardAvatarInput" accept="image/*" class="hidden" @change="handleCardAvatarChange"><input type="file" ref="widgetImageInput" accept="image/*" class="hidden" @change="handleWidgetImageChange">
    </div>

    <!-- ================= 微信 (WeChat) App ================= -->
    <transition name="app-slide">
        <div v-if="currentApp === 'wechat'" class="absolute inset-0 z-[1000] bg-[#f7f7f7] flex flex-col overflow-hidden text-black" @click="closeChatMenus">
            
            <!-- 头部 -->
            <header v-if="wechatState.activeNav !== 'room' && wechatState.activeNav !== 'chat-details' && wechatState.activeNav !== 'chat-bg-settings' && wechatState.activeNav !== 'red-packet-detail' && wechatState.activeNav !== 'wallet' && wechatState.activeNav !== 'qinmi-manage' && wechatState.activeNav !== 'qinmi-specific-detail' && wechatState.activeNav !== 'moments'" class="h-[90px] pt-10 px-4 flex items-center justify-between sticky top-0 z-[60] bg-[#f7f7f7]">
                <button @click="closeApp" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-times text-lg"></i></button>
                <h1 class="text-[17px] font-medium">{{ wechatState.activeNav === 'contacts' ? '通讯录' : (wechatState.activeNav === 'discover' ? '发现' : (wechatState.activeNav === 'me' ? '' : '微信')) }}</h1>
                <div class="w-8 flex justify-end relative">
                    <i v-if="wechatState.activeNav === 'chat'" class="fas fa-plus text-lg cursor-pointer" @click.stop="wechatState.showPlusMenu = !wechatState.showPlusMenu"></i>
                    <i v-if="wechatState.activeNav === 'contacts'" class="fas fa-plus text-lg cursor-pointer" @click="openAddContactModal"></i>
                    
                    <div v-if="wechatState.showPlusMenu" class="wechat-dropdown">
                        <div @click="startChatWizard('single')" class="px-4 py-3 hover:bg-white/10 flex items-center gap-3 text-sm cursor-pointer border-b border-white/10"><i class="fas fa-comment-alt"></i> 发起单聊</div>
                        <div @click="startChatWizard('group')" class="px-4 py-3 hover:bg-white/10 flex items-center gap-3 text-sm cursor-pointer"><i class="fas fa-users"></i> 发起群聊</div>
                    </div>
                </div>
            </header>

            <!-- 钱包页面 -->
            <div v-if="wechatState.activeNav === 'wallet'" class="flex-1 flex flex-col bg-white absolute inset-0 z-50">
                <header class="h-[90px] pt-10 px-4 flex items-center bg-white"><button @click="wechatState.activeNav = 'me'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg text-black"></i></button><h1 class="font-bold text-[17px] ml-2">钱包</h1></header>
                <div class="flex-1 overflow-y-auto">
                    <div class="bg-gray-800 m-4 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-sm opacity-80 mb-2">总资产(元)</div>
                        <div class="text-4xl font-bold font-mono tracking-tight mb-8">¥ {{ formatMoney(wallet.balance) }}</div>
                        <div class="flex gap-4">
                            <button @click="triggerTopUp" class="flex-1 bg-white text-black py-3 rounded-xl font-bold text-sm">充值</button>
                            <button @click="triggerWithdraw" class="flex-1 bg-white/20 backdrop-blur-sm text-white py-3 rounded-xl font-bold text-sm">提现</button>
                        </div>
                    </div>
                    
                    <!-- 亲密付入口 -->
                    <div class="px-4 mb-4">
                        <div class="bg-[#d95556] rounded-xl p-4 text-white flex justify-between items-center cursor-pointer shadow-md" @click="openQinmiSelectModal">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-heart text-lg"></i></div>
                                <div><div class="font-bold">亲密付</div><div class="text-xs opacity-80">赠送与求助</div></div>
                            </div>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </div>
                    </div>

                    <div class="px-6 py-4">
                         <div @click="openQinmiManage" class="flex justify-between items-center bg-gray-50 p-4 rounded-xl mb-6 cursor-pointer">
                             <span class="font-bold">查看我的亲密付关系</span>
                             <i class="fas fa-chevron-right text-gray-300"></i>
                         </div>

                        <h3 class="font-bold text-lg mb-4 text-gray-900">账单明细</h3>
                        <div class="space-y-4">
                            <div v-if="wallet.transactions.length === 0" class="text-center text-gray-400 text-xs py-10">暂无交易记录</div>
                            <div v-for="(tx, idx) in wallet.transactions" :key="idx" class="flex justify-between items-center pb-4 border-b border-gray-50 last:border-0">
                                <div>
                                    <div class="font-bold text-gray-900 text-sm">{{ tx.desc }}</div>
                                    <div class="text-xs text-gray-400 mt-1">{{ formatChatTime(tx.time) }} · {{ tx.source }}</div>
                                </div>
                                <div class="font-bold text-sm font-mono" :class="tx.type === 'income' ? 'text-green-600' : 'text-black'">{{ tx.type === 'income' ? '+' : '-' }}{{ formatMoney(tx.amount) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 亲密付管理页 -->
            <div v-if="wechatState.activeNav === 'qinmi-manage'" class="flex-1 flex flex-col qinmi-detail-bg absolute inset-0 z-50">
                 <header class="h-[90px] pt-10 px-4 flex items-center bg-white"><button @click="wechatState.activeNav = 'wallet'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg text-black"></i></button><h1 class="font-bold text-[17px] ml-2 text-black">我的亲密付</h1></header>
                 <div class="flex-1 overflow-y-auto p-4">
                     <div v-if="wallet.intimatePays.length === 0" class="text-center text-gray-400 mt-10">暂无亲密付关系</div>
                     <div v-for="qp in wallet.intimatePays" :key="qp.id" @click="openQinmiSpecificDetail(qp)" class="qinmi-card bg-white p-4 rounded-xl mb-4 cursor-pointer shadow-sm relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-1 h-full" :class="qp.type === 'outcome' ? 'bg-[#d95556]' : 'bg-blue-500'"></div>
                         <div class="flex justify-between items-center">
                             <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-gray-100 overflow-hidden"><img :src="getChatAvatar({isSelf: false, targetId: qp.targetId})" class="w-full h-full object-cover"></div>
                                 <div>
                                     <div class="font-bold text-sm">{{ qp.type === 'outcome' ? '我为TA付' : 'TA为我付' }} <span class="text-gray-500 font-normal">({{ getFriendName(qp.targetId) }})</span></div>
                                     <div class="text-xs text-gray-400 mt-1">额度: ¥{{ qp.limit }}</div>
                                 </div>
                             </div>
                             <div class="text-xs px-2 py-1 rounded" :class="qp.status === 'active' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'">{{ qp.status === 'active' ? '使用中' : (qp.status === 'rejected' ? '已拒绝' : '待确认') }}</div>
                         </div>
                     </div>
                 </div>
            </div>

            <!-- 亲密付单详情页 -->
            <div v-if="wechatState.activeNav === 'qinmi-specific-detail'" class="flex-1 flex flex-col qinmi-detail-bg absolute inset-0 z-50">
                <header class="h-[90px] pt-10 px-4 flex items-center bg-white"><button @click="wechatState.activeNav = 'qinmi-manage'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg text-black"></i></button><h1 class="font-bold text-[17px] ml-2 text-black">详情</h1></header>
                <div class="flex-1 overflow-y-auto" v-if="activeQinmiDetail">
                    <div class="qinmi-card-detail">
                        <div class="qinmi-card-header">
                            <div>
                                <div class="text-sm text-gray-500">{{ activeQinmiDetail.type === 'outcome' ? '本月我已帮TA消费' : '本月TA已帮我消费' }}</div>
                                <div class="qinmi-balance-big">¥{{ activeQinmiDetail.balanceUsed }}</div>
                            </div>
                            <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-white shadow-md"><img :src="getChatAvatar({isSelf: false, targetId: activeQinmiDetail.targetId})" class="w-full h-full object-cover"></div>
                        </div>
                        <div class="flex justify-between text-sm mb-2"><span class="text-gray-500">每月限额</span><span class="font-bold">¥{{ activeQinmiDetail.limit }}</span></div>
                        <div class="flex justify-between text-sm"><span class="text-gray-500">剩余额度</span><span class="font-bold text-green-600">¥{{ (activeQinmiDetail.limit - activeQinmiDetail.balanceUsed).toFixed(2) }}</span></div>
                    </div>
                    
                    <div class="px-4 pb-4">
                        <div class="text-xs font-bold text-gray-400 mb-2 px-2">消费明细</div>
                        <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                            <div v-if="!activeQinmiDetail.history || activeQinmiDetail.history.length === 0" class="text-center text-gray-300 text-xs py-6">暂无消费</div>
                            <div v-for="(h, hi) in activeQinmiDetail.history" :key="hi" class="flex justify-between items-center p-4 border-b border-gray-50 last:border-0">
                                <div>
                                    <div class="text-sm font-bold">{{ h.item }}</div>
                                    <div class="text-xs text-gray-400 mt-1">{{ formatChatTime(h.time) }}</div>
                                </div>
                                <div class="font-bold text-sm">-{{ h.amount }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 朋友圈 (Moments) -->
            <div v-if="wechatState.activeNav === 'moments'" class="flex-1 flex flex-col bg-white absolute inset-0 z-50 overflow-y-auto" @click="activeMomentMenuId = null">
                <div class="absolute top-0 left-0 w-full h-[90px] pt-10 px-4 flex justify-between items-center z-10 text-white drop-shadow-md">
                    <button @click="wechatState.activeNav='discover'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg"></i></button>
                    <div class="flex gap-4">
                        <button @click="openMomentGenerateModal" class="w-8 h-8 flex items-center justify-center bg-black/20 rounded-full backdrop-blur-sm active:scale-95 transition"><i class="fas fa-sync-alt text-sm"></i></button>
                        <button @click="openPublishMoment" class="w-8 h-8 flex items-center justify-center bg-black/20 rounded-full backdrop-blur-sm active:scale-95 transition"><i class="fas fa-camera text-lg"></i></button>
                    </div>
                </div>
                
                <div class="moments-header" @click="triggerMomentsCoverUpload">
                    <img v-if="momentsBackground" :src="momentsBackground" class="moments-cover">
                    <div v-else class="w-full h-full bg-gray-800 flex items-center justify-center text-white/30 text-sm">点击更换封面</div>
                    <div class="moments-user" @click.stop>
                        <div class="moments-username" @click.stop="editHomeProfile('name')">{{ homeProfile.name }}</div>
                        <div class="moments-avatar" @click.stop="triggerHomeAvatarUpload"><img v-if="homeProfile.avatar" :src="homeProfile.avatar" class="w-full h-full object-cover"></div>
                    </div>
                </div>
                <!-- 隐藏的封面上传 -->
                <input type="file" ref="momentsCoverInput" accept="image/*" class="hidden" @change="handleMomentsCoverUpload">

                <div class="pb-20">
                    <div v-if="moments.length === 0" class="text-center text-gray-400 text-sm mt-10">暂无动态，点击右上角发布</div>
                    <div v-for="moment in moments" :key="moment.id" class="moment-item">
                        <div class="moment-avatar"><img :src="moment.avatar" class="w-full h-full object-cover"></div>
                        <div class="moment-content">
                            <div class="moment-name">{{ moment.name }}</div>
                            <div class="moment-text">
                                {{ moment.content }}
                                <!-- 艾特高亮显示 -->
                                <span v-if="moment.mentions && moment.mentions.length > 0" class="text-[#576b95]"> @{{ getMentionNamesForMoment(moment) }}</span>
                            </div>
                            <div v-if="moment.images && moment.images.length > 0" class="moment-images">
                                <img v-for="(img, idx) in moment.images" :key="idx" :src="img" class="moment-image" :class="moment.images.length===1?'single':''">
                            </div>
                            <!-- 定位显示 -->
                            <div v-if="moment.location" class="text-[11px] text-[#576b95] mt-1">{{ moment.location }}</div>
                            
                            <div class="moment-meta mt-1">
                                <div class="moment-time flex items-center gap-2">
                                    {{ formatChatTime(moment.time) }}
                                    <!-- 仅自己可见/分组可见 图标提示 -->
                                    <i v-if="moment.visibility === 'private'" class="fas fa-lock text-gray-300"></i>
                                    <i v-else-if="moment.visibility === 'share_to' || moment.visibility === 'dont_share_to'" class="fas fa-user-friends text-gray-300"></i>
                                </div>
                                <div class="moment-action-btn bg-[#f7f7f7] rounded text-[#576b95] cursor-pointer" @click.stop="toggleMomentMenu(moment)">
                                    <i class="fas fa-ellipsis-h text-sm"></i>
                                </div>
                                <!-- Popover Menu -->
                                <transition name="scale">
                                    <div v-if="activeMomentMenuId === moment.id" class="moment-menu" @click.stop>
                                        <div class="moment-menu-item" @click="handleMomentAction('like', moment)"><i class="far fa-heart"></i><span>{{ moment.isLiked ? '取消' : '赞' }}</span></div>
                                        <div class="moment-menu-item" @click="handleMomentAction('comment', moment)"><i class="far fa-comment"></i><span>评论</span></div>
                                        <div class="moment-menu-item" @click="handleMomentAction('forward', moment)"><i class="fas fa-share"></i><span>转发</span></div>
                                        <div v-if="moment.name === homeProfile.name" class="moment-menu-item" @click="handleMomentAction('generate', moment)"><i class="fas fa-magic"></i><span>生成</span></div>
                                        <div class="moment-menu-item text-red-400" @click="handleMomentAction('delete', moment)"><i class="far fa-trash-alt"></i><span>删除</span></div>
                                    </div>
                                </transition>
                            </div>
                            
                            <div v-if="moment.likes.length > 0 || moment.comments.length > 0" class="moment-likes-comments">
                                <div v-if="moment.likes.length > 0" class="moment-likes"><i class="far fa-heart text-xs mt-1"></i> <span class="flex-1 ml-1">{{ moment.likes.join(', ') }}</span></div>
                                <div v-for="(cmt, cidx) in moment.comments" :key="cidx" class="moment-comment-item" @click="setReplyTarget(moment, cmt)">
                                    <span class="moment-comment-user">{{ cmt.user }}</span>
                                    <span v-if="cmt.replyTo" class="text-gray-600 mx-1">回复</span>
                                    <span v-if="cmt.replyTo" class="moment-comment-user">{{ cmt.replyTo }}</span>: 
                                    <span class="text-gray-600">{{ cmt.text }}</span>
                                </div>
                            </div>

                            <div v-if="activeCommentMomentId === moment.id" class="moment-comment-input-box">
                                <input v-model="commentInput" ref="commentInputRef" class="moment-input" :placeholder="replyTarget ? `回复 ${replyTarget.user}:` : '评论'" @keyup.enter="submitComment(moment)">
                                <button @click="submitComment(moment)" class="text-[#576b95] font-bold text-sm px-2">发送</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 发布朋友圈弹窗 -->
            <transition name="app-slide">
                <div v-if="showPublishMoment" class="fixed inset-0 z-[70000] bg-white flex flex-col">
                    <div class="h-[90px] pt-10 px-4 flex justify-between items-center border-b border-gray-100">
                        <button @click="showPublishMoment = false" class="text-sm font-bold text-gray-800">取消</button>
                        <button @click="publishMoment" class="px-4 py-1.5 bg-[#07c160] text-white rounded-md text-sm font-bold" :disabled="!newMoment.content && newMoment.images.length===0" :class="(!newMoment.content && newMoment.images.length===0)?'opacity-50':''">发表</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-5">
                        <textarea v-model="newMoment.content" placeholder="这一刻的想法..." class="w-full h-24 text-base outline-none resize-none mb-4"></textarea>
                        
                        <div class="grid grid-cols-3 gap-2 mb-6">
                            <div v-for="(img, idx) in newMoment.images" :key="idx" class="aspect-square bg-gray-100 relative rounded-lg overflow-hidden">
                                <img :src="img" class="w-full h-full object-cover">
                                <div class="absolute top-1 right-1 w-5 h-5 bg-black/50 rounded-full flex items-center justify-center text-white text-xs cursor-pointer" @click="newMoment.images.splice(idx,1)"><i class="fas fa-times"></i></div>
                            </div>
                            <div v-if="newMoment.images.length < 9" class="aspect-square bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 cursor-pointer active:bg-gray-200" @click="$refs.momentImgInput.click()">
                                <i class="fas fa-plus text-2xl"></i>
                            </div>
                        </div>
                        <input type="file" ref="momentImgInput" accept="image/*" class="hidden" multiple @change="handleMomentImgUpload">

                        <!-- 新增属性配置栏 -->
                        <div class="border-t border-gray-100 divide-y divide-gray-100 mt-2">
                            <div @click="openLocationInput" class="py-3.5 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                                <div class="flex items-center gap-3"><i class="fas fa-map-marker-alt w-5 text-center text-gray-500 text-lg"></i><span class="text-[15px] text-gray-800">所在位置</span></div>
                                <div class="flex items-center gap-1 max-w-[50%]"><span class="text-sm text-gray-400 truncate">{{ newMoment.location || '' }}</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>
                            </div>
                            <div @click="openMentionModal" class="py-3.5 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                                <div class="flex items-center gap-3"><i class="fas fa-at w-5 text-center text-gray-500 text-lg"></i><span class="text-[15px] text-gray-800">提醒谁看</span></div>
                                <div class="flex items-center gap-1 max-w-[50%]"><span class="text-sm text-gray-400 truncate">{{ getMentionNames() || '' }}</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>
                            </div>
                            <div @click="visibilityModal.show = true" class="py-3.5 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                                <div class="flex items-center gap-3"><i class="fas fa-user w-5 text-center text-gray-500 text-lg"></i><span class="text-[15px] text-gray-800">谁可以看</span></div>
                                <div class="flex items-center gap-1 max-w-[50%]"><span class="text-sm text-gray-400 truncate">{{ getVisibilityName() }}</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 聊天房间 (Chat Room) -->
            <div v-if="wechatState.activeNav === 'room'" class="flex-1 flex flex-col bg-[#fdfdfd] absolute inset-0 z-20">
                <header class="h-[90px] pt-10 px-4 flex items-center justify-between bg-white/95 backdrop-blur border-b border-gray-100 z-30">
                    <button @click="wechatState.activeNav = 'chat'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg text-gray-800"></i></button>
                    <!-- 点击标题显示心声 -->
                    <div class="flex flex-col items-center cursor-pointer active:opacity-50" @click="openStatusModal">
                        <h1 class="font-medium text-[16px] text-gray-900 flex items-center gap-1">
                            <span v-if="isTyping">对方正在输入中<span class="typing-dot">.</span><span class="typing-dot">.</span><span class="typing-dot">.</span></span>
                            <span v-else>{{ wechatState.activeSession.name }}</span>
                        </h1>
                        <span class="text-[10px] text-gray-300 tracking-wider">Only You.</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button class="w-8 h-8 flex items-center justify-center text-gray-800" @click="groupSelectModal.show = true"><i class="fas fa-folder-open"></i></button>
                        <button class="w-8 h-8 flex items-center justify-center text-gray-800" @click="goToChatDetails"><i class="fas fa-ellipsis-h"></i></button>
                    </div>
                </header>
                
                <!-- 聊天容器：支持自定义背景图 -->
                <div class="flex-1 overflow-y-auto p-4 space-y-5 bg-[#fdfdfd] bg-cover bg-center" ref="chatContainer" @click="closeChatMenus"
                     :style="{ backgroundImage: wechatState.activeSession.wallpaper ? 'url(' + wechatState.activeSession.wallpaper + ')' : '' }">
                    <div v-if="wechatState.activeSession.messages.length === 0" class="text-center text-xs text-gray-300 py-4">星期日 13:42</div>
                    
                    <div v-for="(msg, i) in wechatState.activeSession.messages" :key="i">
                        <!-- 正常消息 -->
                        <div v-if="!msg.isRecalled" class="flex w-full gap-3 mb-2" :class="msg.isSelf ? 'flex-row-reverse' : 'flex-row'" @contextmenu.prevent="showChatContextMenu($event, msg, i)" @touchstart="longPressStart($event, msg, i)" @touchend="longPressEnd">
                            <!-- 复选框 -->
                            <div v-if="isMultiSelectMode" class="self-center" @click.stop="toggleSelectMessage(msg)">
                                <div class="w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center transition" :class="selectedMessageIds.includes(msg) ? 'bg-black border-black' : 'bg-white'">
                                    <i v-if="selectedMessageIds.includes(msg)" class="fas fa-check text-white text-[10px]"></i>
                                </div>
                            </div>
                            
                            <div class="w-10 h-10 rounded-full overflow-hidden shrink-0 border border-gray-100" @touchstart="longPressStart($event, msg, i)" @touchend="longPressEnd" @contextmenu.prevent="showChatContextMenu($event, msg, i)">
                                <!-- Dynamic Avatar Logic -->
                                <img :src="getChatAvatar(msg)" class="w-full h-full object-cover">
                            </div>
                            <div class="flex flex-col max-w-[70%]" :class="msg.isSelf ? 'items-end' : 'items-start'">
                                <!-- 语音气泡：动态宽度 -->
                                <div class="chat-bubble" :class="[msg.isSelf ? 'chat-bubble-user' : 'chat-bubble-ai', msg.type === 'voice' ? 'chat-bubble-voice' : '', msg.type === 'image' || msg.type === 'fake_image' ? 'chat-bubble-image' : '', msg.type === 'red_packet' || msg.type === 'transfer' ? 'chat-bubble-finance' : '', msg.type === 'transfer' ? 'chat-bubble-transfer' : '', msg.type === 'red_packet' ? 'chat-bubble-redpacket' : '', msg.type === 'qinmi_invite' ? 'chat-bubble-qinmi' : '', msg.type === 'moment' ? 'chat-bubble-moment' : '', msg.isReceived ? 'received' : '']" 
                                     :style="msg.type === 'voice' ? { width: (60 + Math.min(msg.duration, 60) * 4) + 'px' } : {}"
                                     @click="handleChatBubbleClick(msg)"
                                     @touchstart="longPressStart($event, msg, i)" @touchend="longPressEnd" @contextmenu.prevent="showChatContextMenu($event, msg, i)">
                                    <div v-if="msg.quote" class="quote-block"><span class="font-bold mr-1">{{ msg.quote.name }}:</span>{{ msg.quote.content }}</div>
                                    
                                    <!-- 语音消息 (改进版：声波竖条) -->
                                    <div v-if="msg.type === 'voice'" class="flex items-center justify-between w-full">
                                        <div class="voice-wave-container" :class="msg.isSelf ? 'order-last' : ''">
                                            <div class="voice-wave-bar"></div>
                                            <div class="voice-wave-bar"></div>
                                            <div class="voice-wave-bar"></div>
                                        </div>
                                        <span class="font-bold text-xs whitespace-nowrap">{{ msg.duration }}"</span>
                                        <div v-if="!msg.isSelf && !msg.isRead" class="w-2 h-2 rounded-full bg-red-500 ml-1"></div>
                                    </div>
                                    <!-- 图片消息 (Vision Support) -->
                                    <img v-else-if="msg.type === 'image'" :src="msg.content" class="block">
                                    <!-- 灰色图片 (Fake Image - Click to Reveal) -->
                                    <div v-else-if="msg.type === 'fake_image'" class="chat-bubble-fake-image">
                                        <transition name="fade">
                                            <div v-if="msg.isRevealed" class="fake-image-text">{{ msg.content }}</div>
                                        </transition>
                                    </div>
                                    <!-- 红包消息 (Updated UI) -->
                                    <div v-else-if="msg.type === 'red_packet'" class="finance-content-wrapper">
                                        <div class="finance-content">
                                            <div class="redpacket-icon-box finance-icon-box"><i class="fas fa-wallet"></i></div>
                                            <div class="finance-text"><div class="finance-title">{{ msg.note || '恭喜发财，大吉大利' }}</div><div class="finance-desc" v-if="msg.isSelf">查看红包</div></div>
                                        </div>
                                        <div class="finance-footer">微信红包</div>
                                    </div>
                                    <!-- 转账消息 (Updated UI) -->
                                    <div v-else-if="msg.type === 'transfer'" class="finance-content-wrapper">
                                        <div class="finance-content">
                                            <div class="finance-icon-box"><i class="fas fa-exchange-alt"></i></div>
                                            <div class="finance-text"><div class="finance-title">¥{{ msg.amount }}</div><div class="finance-desc">{{ msg.isReceived ? '已收款' : (msg.isSelf ? '等待对方收款' : '转账给你') }}</div></div>
                                        </div>
                                        <div class="finance-footer">微信转账</div>
                                    </div>
                                    <!-- 亲密付邀请 (Updated UI) -->
                                    <div v-else-if="msg.type === 'qinmi_invite'" class="qinmi-content-wrapper">
                                        <div class="qinmi-header">
                                            <i class="fas fa-heart qinmi-icon"></i>
                                            <span class="font-bold">{{ msg.inviteType === 'give' ? '亲密付' : '亲密付求助' }}</span>
                                        </div>
                                        <div class="qinmi-body">
                                            {{ msg.inviteType === 'give' ? '我想为你开通亲密付' : '能帮我开通亲密付吗？' }}
                                        </div>
                                        <div class="qinmi-footer">
                                            <span>微信亲密付</span>
                                            <i class="fas fa-chevron-right text-xs"></i>
                                        </div>
                                    </div>
                                    <!-- 转发卡片 -->
                                    <div v-else-if="msg.type === 'forward'" class="forward-card">
                                        <div class="forward-title">聊天记录</div>
                                        <div class="forward-content">{{ msg.content }}</div>
                                    </div>
                                    <!-- 朋友圈转发卡片 (NEW) -->
                                    <div v-else-if="msg.type === 'moment'" class="moment-card-wrapper">
                                        <div class="moment-card-header">
                                            <img :src="msg.momentData.avatar" class="w-4 h-4 rounded-sm">
                                            <span>{{ msg.momentData.name }}</span>
                                        </div>
                                        <div class="moment-card-content mt-2">
                                            <div v-if="msg.momentData.images && msg.momentData.images.length>0" class="moment-card-thumb"><img :src="msg.momentData.images[0]" class="w-full h-full object-cover"></div>
                                            <div class="moment-card-text">{{ msg.momentData.content || '[图片动态]' }}</div>
                                        </div>
                                    </div>
                                    <!-- 文本消息 -->
                                    <span v-else>{{ msg.content }}</span>
                                </div>
                                <!-- 语音转文字展开 -->
                                <div v-if="msg.type === 'voice' && msg.isExpanded" class="voice-transcription">{{ msg.content }}</div>
                                <span class="chat-timestamp-small" :class="wechatState.activeSession.wallpaper ? 'text-white/60 drop-shadow-sm' : 'text-gray-300'">{{ formatChatTime(msg.time) }} Read</span>
                            </div>
                        </div>
                        <!-- 撤回提示 (旁白弹窗) -->
                        <div v-else class="system-recall-tip">
                            <div class="bg-gray-100/80 backdrop-blur-sm px-3 py-1 rounded-full text-xs text-gray-500 shadow-sm flex items-center gap-2">
                                <span>{{ msg.isSelf ? '你' : wechatState.activeSession.name }} 撤回了一条消息</span>
                                <span v-if="!msg.isSelf" class="text-blue-600 font-bold cursor-pointer hover:underline" @click="viewRecalled(msg)">查看</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 聊天输入区域 -->
                <div class="bg-white border-t border-gray-100 pb-safe relative chat-input-area">
                    <!-- 附件菜单 (全新网格布局) -->
                    <transition name="app-slide">
                        <div v-if="wechatState.showAttachMenu" class="chat-attach-menu">
                            <!-- 功能图标项 (全部灰色) -->
                            <!-- 相册 (支持 Vision) -->
                            <div class="attach-item" @click="triggerImageUpload"><div class="attach-icon-box"><i class="fas fa-images text-gray-600"></i></div><span class="attach-label">相册</span></div>
                            <!-- 拍摄 (文字转灰色图) -->
                            <div class="attach-item" @click="openFakeImageInput"><div class="attach-icon-box"><i class="fas fa-camera text-gray-600"></i></div><span class="attach-label">拍摄</span></div>
                            <div class="attach-item" @click="showToast('功能开发中')"><div class="attach-icon-box"><i class="fas fa-video text-gray-600"></i></div><span class="attach-label">视频通话</span></div>
                            <div class="attach-item" @click="showToast('功能开发中')"><div class="attach-icon-box"><i class="fas fa-map-marker-alt text-gray-600"></i></div><span class="attach-label">位置</span></div>
                            <div class="attach-item" @click="showToast('功能开发中')"><div class="attach-icon-box"><i class="fas fa-phone text-gray-600"></i></div><span class="attach-label">语音通话</span></div>
                            <!-- 自定义灰色红包图标 (Cute Rounded - Swapped Colors) -->
                            <div class="attach-item" @click="openRedPacketModal"><div class="attach-icon-box !bg-white border border-gray-200 text-gray-600 !rounded-2xl">
                                <i class="fas fa-wallet text-lg"></i>
                            </div><span class="attach-label">红包</span></div>
                            <div class="attach-item" @click="showToast('功能开发中')"><div class="attach-icon-box"><i class="fas fa-gift text-gray-600"></i></div><span class="attach-label">礼物</span></div>
                            <div class="attach-item" @click="openTransferModal"><div class="attach-icon-box"><i class="fas fa-money-bill-wave text-gray-600"></i></div><span class="attach-label">转账</span></div>
                            <div class="attach-item" @click="showToast('功能开发中')"><div class="attach-icon-box"><i class="fas fa-cube text-gray-600"></i></div><span class="attach-label">收藏</span></div>
                            <div class="attach-item" @click="showToast('功能开发中')"><div class="attach-icon-box"><i class="fas fa-music text-gray-600"></i></div><span class="attach-label">一起听</span></div>
                            <div class="attach-item" @click="showToast('功能开发中')"><div class="attach-icon-box"><i class="fas fa-book-open text-gray-600"></i></div><span class="attach-label">一起读</span></div>
                            <!-- 线下模式 (灰色咖啡杯) -->
                            <div class="attach-item" @click="showToast('功能开发中')"><div class="attach-icon-box"><i class="fas fa-coffee text-gray-600"></i></div><span class="attach-label">线下模式</span></div>
                        </div>
                    </transition>

                    <!-- 表情面板 -->
                    <transition name="app-slide">
                        <div v-if="showStickerPanel" class="h-64 bg-gray-50 border-t border-gray-200 flex flex-col absolute bottom-full w-full z-20 shadow-xl rounded-t-2xl overflow-hidden">
                            <!-- 分组栏 -->
                            <div class="bg-white px-2 py-2 flex gap-2 overflow-x-auto border-b border-gray-100 scrollbar-hide shrink-0">
                                <div v-for="group in stickerGroups" :key="group.id" 
                                     class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition cursor-pointer flex items-center gap-2"
                                     :class="activeStickerGroupId === group.id ? 'bg-black text-white' : 'bg-gray-100 text-gray-500'"
                                     @click="activeStickerGroupId = group.id">
                                    {{ group.name }}
                                </div>
                            </div>
                            <!-- 表情列表 -->
                            <div class="flex-1 overflow-y-auto p-4 grid grid-cols-4 gap-4 content-start">
                                <div v-for="sticker in getStickersForPanel()" :key="sticker.id" class="aspect-square flex items-center justify-center active:scale-90 transition cursor-pointer" @click="sendSticker(sticker)">
                                    <img :src="sticker.url" class="w-full h-full object-contain">
                                </div>
                                <div v-if="getStickersForPanel().length === 0" class="col-span-4 text-center text-gray-400 text-xs mt-10">暂无表情，请去"我-表情"添加</div>
                            </div>
                        </div>
                    </transition>

                    <!-- 多选操作栏 -->
                    <div v-if="isMultiSelectMode" class="flex items-center justify-around h-[50px]">
                        <button @click="deleteSelectedMessages" class="flex flex-col items-center text-gray-500"><i class="far fa-trash-alt text-lg"></i><span class="text-[10px]">删除</span></button>
                        <button @click="favoriteSelectedMessages" class="flex flex-col items-center text-gray-500"><i class="fas fa-cube text-lg"></i><span class="text-[10px]">收藏</span></button>
                        <button @click="openForwardModal" class="flex flex-col items-center text-gray-500"><i class="fas fa-share text-lg"></i><span class="text-[10px]">转发</span></button>
                        <button @click="isMultiSelectMode = false" class="flex flex-col items-center text-gray-500"><i class="fas fa-times text-lg"></i><span class="text-[10px]">取消</span></button>
                    </div>
                    <!-- 正常输入栏 (优化布局) -->
                    <div v-else class="flex items-center gap-2 px-2 py-2">
                        <transition name="fade"><div v-if="replyingTo" class="absolute bottom-full left-0 w-full bg-gray-100 p-2 text-xs text-gray-500 border-t border-gray-200 flex justify-between items-center z-10"><span>引用: {{ replyingTo.content }}</span><button @click="replyingTo=null"><i class="fas fa-times"></i></button></div></transition>
                        
                        <button @click.stop="wechatState.showAttachMenu = !wechatState.showAttachMenu" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-800 transition shrink-0"><i class="fas fa-paperclip text-xl"></i></button>
                        <button @click="openVoiceInput" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-black transition active:scale-95 shrink-0"><i class="fas fa-microphone text-xl"></i></button>
                        
                        <input v-model="inputMsg" @keyup.enter="sendMessage" class="flex-1 bg-gray-100 rounded-full py-2 px-3 text-sm border-none outline-none min-w-0" placeholder="Aa...">
                        
                        <button @click="showStickerPanel = !showStickerPanel" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-yellow-500 transition shrink-0" :class="showStickerPanel ? 'text-yellow-500' : ''"><i class="far fa-smile text-xl"></i></button>
                        
                        <button v-if="inputMsg.trim().length > 0" @click="sendMessage" class="w-8 h-8 flex items-center justify-center text-gray-500 active:text-green-500 transition shrink-0"><i class="fas fa-check-circle text-2xl"></i></button>
                        <!-- 接收按钮：灰色外观 (外圈+三点) 尺寸调小 -->
                        <button v-else @click="triggerReceive" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-gray-600 transition shrink-0 active:scale-95"><i class="far fa-comment-dots text-xl"></i></button>
                    </div>
                </div>
            </div>

            <!-- 聊天详情页 -->
            <div v-if="wechatState.activeNav === 'chat-details'" class="flex-1 flex flex-col bg-white absolute inset-0 z-30">
                <header class="h-[90px] pt-10 px-4 flex items-center bg-white border-b border-gray-100"><button @click="wechatState.activeNav = 'room'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg text-black"></i></button><h1 class="font-bold text-[17px] ml-2">聊天详情</h1></header><div class="flex-1 overflow-y-auto p-5"><div class="bg-gray-50 rounded-2xl p-4 flex items-center gap-4 mb-6 cursor-pointer active:bg-gray-100 transition" @click="editCurrentSessionFriend"><div class="w-16 h-16 rounded-full bg-white overflow-hidden shadow-sm shrink-0"><img :src="getCurrentSessionAvatar()" class="w-full h-full object-cover"></div><div class="flex-1 min-w-0"><h3 class="font-bold text-lg text-gray-900 truncate">{{ wechatState.activeSession.name }}</h3><p class="text-xs text-gray-500 mt-1 truncate">ID: {{ getCurrentSessionId() }}</p><p class="text-xs text-gray-400 mt-1 truncate">{{ getCurrentSessionBio() }}</p></div><i class="fas fa-chevron-right text-gray-300"></i></div>
                <div class="space-y-6">
                    <div class="flex justify-between items-center"><span class="text-sm">查找聊天记录</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>
                    <!-- 本聊专属头像入口 (NEW) -->
                    <div class="flex justify-between items-center cursor-pointer active:bg-gray-50 p-2 -mx-2 rounded-lg" @click="openAvatarSetting">
                        <span class="text-sm">设置本聊专属头像</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400" v-if="wechatState.activeSession.customAvatarSelf || wechatState.activeSession.customAvatarTarget">已设置</span>
                            <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>
                    <!-- 聊天背景入口 -->
                    <div class="flex justify-between items-center cursor-pointer active:bg-gray-50 p-2 -mx-2 rounded-lg" @click="navigateToChatBgSettings"><span class="text-sm">设置当前聊天背景</span><div class="flex items-center gap-2"><span class="text-xs text-gray-400">{{ wechatState.activeSession.wallpaper ? '已设置' : '默认' }}</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div></div>
                    <div class="flex justify-between items-center"><span class="text-sm">消息免打扰</span><div class="w-10 h-6 bg-gray-200 rounded-full relative"><div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 shadow-sm"></div></div></div>
                    <div class="flex justify-between items-center"><span class="text-sm">置顶聊天</span><input type="checkbox" class="switch-checkbox" id="pin-chat-toggle" :checked="wechatState.activeSession?.isPinned" @change="togglePin"><label for="pin-chat-toggle" class="switch-label"><div class="switch-button"></div></label></div>
                    <div class="flex justify-between items-center cursor-pointer active:opacity-50" @click="worldBinderModal.show = true"><div class="flex flex-col"><span class="text-sm">绑定世界书 (可多选)</span><span class="text-xs text-gray-400 mt-0.5">{{ getWorldbookStatus() }}</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>
                    <button @click="clearChatHistory" class="w-full text-red-500 font-bold text-sm py-2">清空聊天记录</button>
                </div>
                </div>
            </div>

            <!-- 聊天背景设置页 -->
            <div v-if="wechatState.activeNav === 'chat-bg-settings'" class="flex-1 flex flex-col bg-gray-50 absolute inset-0 z-40">
                <header class="h-[90px] pt-10 px-4 flex items-center bg-white border-b border-gray-100"><button @click="wechatState.activeNav = 'chat-details'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg text-black"></i></button><h1 class="font-bold text-[17px] ml-2">聊天背景</h1></header>
                <div class="flex-1 p-6 flex flex-col items-center">
                    <div class="w-48 h-80 bg-gray-200 rounded-lg overflow-hidden shadow-md mb-8 border-4 border-white relative">
                        <img v-if="wechatState.activeSession.wallpaper" :src="wechatState.activeSession.wallpaper" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-gray-400 flex-col"><i class="fas fa-image text-3xl mb-2"></i><span class="text-xs">默认</span></div>
                    </div>
                    <button @click="triggerChatBgUpload" class="w-full bg-black text-white py-3 rounded-xl font-bold text-sm mb-3">从相册选择</button>
                    <button @click="resetChatBg" class="w-full bg-white text-red-500 border border-gray-200 py-3 rounded-xl font-bold text-sm">恢复默认</button>
                </div>
                <input type="file" ref="chatBgInput" accept="image/*" class="hidden" @change="handleChatBgChange">
            </div>

            <!-- 红包详情页 (新) -->
            <div v-if="wechatState.activeNav === 'red-packet-detail'" class="flex-1 flex flex-col red-packet-bg absolute inset-0 z-50">
                <div class="rp-header">
                     <div class="pt-10 px-4 flex justify-between items-center text-white/90">
                         <button @click="wechatState.activeNav = 'room'" class="flex items-center gap-1"><i class="fas fa-chevron-left"></i><span>返回</span></button>
                         <span class="text-sm font-bold">红包</span>
                         <span class="text-sm">红包记录</span>
                     </div>
                     <div class="rp-avatar-box">
                         <img :src="currentRedPacketData.isSelf ? getChatAvatar({isSelf: true}) : getChatAvatar({isSelf: false, targetId: wechatState.activeSession.targetId})" class="w-full h-full object-cover">
                     </div>
                </div>
                <div class="flex-1 pt-12 flex flex-col items-center">
                    <h3 class="font-bold text-lg mb-1">{{ currentRedPacketData.isSelf ? getMaskById(wechatState.activeSession.maskId).name : wechatState.activeSession.name }}发送的红包</h3>
                    <p class="text-xs text-gray-400 mb-6">{{ currentRedPacketData.note }}</p>
                    
                    <h1 class="text-4xl font-bold text-[#d44d44] mb-8">{{ currentRedPacketData.amount }} <span class="text-sm text-black font-normal">元</span></h1>

                    <div class="w-full bg-white flex-1 p-4 border-t border-gray-100">
                        <div class="text-xs text-gray-400 mb-4 border-b border-gray-50 pb-2">1个红包，已领完</div>
                        <div class="flex items-center justify-between">
                             <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded bg-gray-100 overflow-hidden"><img :src="!currentRedPacketData.isSelf ? getChatAvatar({isSelf: true}) : getChatAvatar({isSelf: false, targetId: wechatState.activeSession.targetId})" class="w-full h-full object-cover"></div>
                                 <div>
                                     <div class="font-bold text-sm">{{ !currentRedPacketData.isSelf ? getMaskById(wechatState.activeSession.maskId).name : wechatState.activeSession.name }}</div>
                                     <div class="text-xs text-gray-400">{{ formatChatTime(currentRedPacketData.time) }}</div>
                                 </div>
                             </div>
                             <div class="font-bold text-sm">{{ currentRedPacketData.amount }} 元</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 消息列表 -->
            <main v-if="wechatState.activeNav === 'chat'" class="flex-1 overflow-y-auto px-3 pb-24 z-0">
                <div class="bg-white rounded-lg py-2 flex items-center justify-center text-gray-400 text-sm mb-4"><i class="fas fa-search mr-1.5"></i><input v-model="wechatState.searchQuery" class="bg-transparent outline-none text-sm text-center wechat-search-input w-full" placeholder="i miss...(T u T)o"></div>
                <!-- 筛选 Tabs -->
                <div class="bg-white rounded-[20px] p-1 flex justify-between items-center mb-4 sticky top-0 z-0 shadow-sm overflow-x-auto scrollbar-hide"><div v-for="filter in ['Chats', 'Group', 'Likes', 'All']" :key="filter" @click="wechatState.activeFilter = filter" class="wechat-pill-tab cursor-pointer flex-1 text-center" :class="wechatState.activeFilter === filter ? 'wechat-pill-active' : 'wechat-pill-inactive'">{{ filter }}</div></div>
                
                <div class="bg-white rounded-[18px] h-fit overflow-hidden mb-8">
                    <!-- 分组视图模式 -->
                    <div v-if="wechatState.activeFilter === 'Group'">
                        <div class="p-4 border-b border-gray-50 flex items-center gap-3 active:bg-gray-50 cursor-pointer" @click="createNewGroup"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-plus"></i></div><span class="font-bold text-gray-800">新建分组</span></div>
                        <div class="border-b border-gray-50"><div class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer" @click="toggleGroup('all')"><span class="font-bold text-gray-800">全部 ({{ wechatState.sessions.length }})</span><i class="fas fa-chevron-right text-gray-300 transition-transform" :class="{'rotate-90': expandedGroups.includes('all')}"></i></div><div v-show="expandedGroups.includes('all')" class="bg-gray-50/30"><div v-for="session in filteredWechatContacts" :key="session.id" @click="enterChatRoom(session)" class="flex items-center p-4 active:bg-gray-50 transition border-b border-gray-50 last:border-0 relative" :class="{'bg-gray-50': session.isPinned}"><div class="relative shrink-0 mr-3"><div class="w-[50px] h-[50px] rounded-full overflow-hidden wechat-avatar-ring"><div class="w-full h-full rounded-full bg-gray-100 overflow-hidden"><img :src="session.customAvatarTarget || session.avatar" class="w-full h-full object-cover"></div></div></div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline mb-1"><h3 class="text-[16px] font-semibold text-gray-900 truncate flex items-center gap-1">{{ session.name }} <i v-if="session.isPinned" class="fas fa-thumbtack text-[10px] text-gray-400 rotate-45"></i></h3><span class="text-[11px] text-gray-400 font-normal">刚刚</span></div><div class="flex justify-between items-center"><p class="text-[13px] text-gray-500 truncate max-w-[80%]">{{ session.lastMessage || '...' }}</p></div></div></div></div></div>
                        <div v-for="group in wechatState.groups" :key="group.id" class="border-b border-gray-50"><div class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer" @click="toggleGroup(group.id)"><span class="font-bold text-gray-800">{{ group.name }} ({{ getGroupSessions(group.id).length }})</span><div class="flex items-center gap-3"><button @click.stop="deleteGroup(group.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button><i class="fas fa-chevron-right text-gray-300 transition-transform" :class="{'rotate-90': expandedGroups.includes(group.id)}"></i></div></div><div v-show="expandedGroups.includes(group.id)" class="bg-gray-50/30"><div v-if="getGroupSessions(group.id).length === 0" class="p-4 text-center text-xs text-gray-400">该分组暂无好友</div><div v-for="session in getGroupSessions(group.id)" :key="session.id" @click="enterChatRoom(session)" class="flex items-center p-4 active:bg-gray-50 transition border-b border-gray-50 last:border-0 relative" :class="{'bg-gray-50': session.isPinned}"><div class="relative shrink-0 mr-3"><div class="w-[50px] h-[50px] rounded-full overflow-hidden wechat-avatar-ring"><div class="w-full h-full rounded-full bg-gray-100 overflow-hidden"><img :src="session.customAvatarTarget || session.avatar" class="w-full h-full object-cover"></div></div></div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline mb-1"><h3 class="text-[16px] font-semibold text-gray-900 truncate flex items-center gap-1">{{ session.name }} <i v-if="session.isPinned" class="fas fa-thumbtack text-[10px] text-gray-400 rotate-45"></i></h3><span class="text-[11px] text-gray-400 font-normal">刚刚</span></div><div class="flex justify-between items-center"><p class="text-[13px] text-gray-500 truncate max-w-[80%]">{{ session.lastMessage || '...' }}</p></div></div></div></div></div>
                    </div>
                    <!-- 正常视图模式 -->
                    <div v-else>
                        <div v-if="wechatState.sessions.length === 0" class="flex flex-col items-center justify-center h-40 text-gray-300 mt-10"><i class="far fa-comment-dots text-4xl mb-3 opacity-20"></i><p class="text-xs">暂无会话</p></div>
                        <div v-else><div v-for="session in filteredWechatContacts" :key="session.id" @click="enterChatRoom(session)" class="flex items-center p-4 active:bg-gray-50 transition border-b border-gray-50 last:border-0 relative" :class="{'bg-gray-50': session.isPinned}"><div class="relative shrink-0 mr-3"><div class="w-[50px] h-[50px] rounded-full overflow-hidden wechat-avatar-ring"><div class="w-full h-full rounded-full bg-gray-100 overflow-hidden"><img :src="session.customAvatarTarget || session.avatar" class="w-full h-full object-cover"></div></div></div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline mb-1"><h3 class="text-[16px] font-semibold text-gray-900 truncate flex items-center gap-1">{{ session.name }} <i v-if="session.isPinned" class="fas fa-thumbtack text-[10px] text-gray-400 rotate-45"></i></h3><span class="text-[11px] text-gray-400 font-normal">刚刚</span></div><div class="flex justify-between items-center"><p class="text-[13px] text-gray-500 truncate max-w-[80%]">{{ session.lastMessage || '...' }}</p></div></div></div></div>
                    </div>
                </div>
            </main>

            <!-- 通讯录 -->
            <main v-if="wechatState.activeNav === 'contacts'" class="flex-1 overflow-y-auto px-3 pb-24">
                <div class="bg-white rounded-[18px] mt-4 overflow-hidden shadow-sm">
                    <div class="p-3 bg-gray-50 border-b border-gray-100 text-xs font-bold text-gray-400 sticky top-0">朋友</div>
                    <div v-if="wechatState.friendList.length === 0" class="flex flex-col items-center justify-center h-40 text-gray-300"><i class="fas fa-user-plus text-3xl mb-2 opacity-30"></i><p class="text-xs">暂无朋友，点击右上角添加</p></div>
                    <div v-else class="divide-y divide-gray-50"><div v-for="(friend, index) in wechatState.friendList" :key="index" @click="editFriend(friend)" class="flex items-center p-3 hover:bg-gray-50 transition cursor-pointer"><div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden mr-3 shrink-0"><img v-if="friend.avatar" :src="friend.avatar" class="w-full h-full object-cover"><i v-else class="fas fa-user flex h-full items-center justify-center text-gray-300"></i></div><div class="flex-1 min-w-0"><h4 class="font-bold text-gray-900 text-[15px] truncate">{{ friend.remark || friend.name }}</h4><p class="text-xs text-gray-400 truncate" v-if="friend.bio">{{ friend.bio }}</p></div></div></div>
                </div>
            </main>

            <!-- 发现 (Discover - with Moments) -->
            <main v-if="wechatState.activeNav === 'discover'" class="flex-1 overflow-y-auto bg-[#f3f4f6]">
                <div class="mt-4 bg-white">
                    <div @click="wechatState.activeNav = 'moments'" class="flex items-center p-4 active:bg-gray-50 cursor-pointer justify-between">
                        <div class="flex-1 text-base font-medium text-black">朋友圈</div>
                        <div class="flex items-center gap-2">
                            <div v-if="moments.length > 0" class="w-8 h-8 rounded-md overflow-hidden bg-gray-100 relative">
                                <img :src="moments[0].avatar" class="w-full h-full object-cover">
                                <div class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 bg-white divide-y divide-gray-100">
                    <!-- Removed Scan/Search Items as requested -->
                </div>
            </main>

            <!-- 我 -->
            <main v-if="wechatState.activeNav === 'me'" class="flex-1 overflow-y-auto bg-white">
                <div class="pt-20 px-6 pb-6">
                    <div class="flex items-center gap-4 mb-8"><div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100"><img v-if="homeProfile.avatar" :src="homeProfile.avatar" class="w-full h-full object-cover"></div><div><h2 class="text-xl font-bold">{{ homeProfile.name }}</h2><p class="text-xs text-gray-400 mt-1">微信号: {{ homeProfile.id }}</p></div><i class="fas fa-qrcode ml-auto text-gray-400"></i><i class="fas fa-chevron-right ml-4 text-gray-300 text-xs"></i></div>
                    <div class="space-y-1 border-t border-gray-100"><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="openMaskManager"><div class="flex items-center gap-3"><i class="fas fa-mask text-purple-500 w-6"></i><span>面具</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="wechatState.activeNav='wallet'"><div class="flex items-center gap-3"><i class="fas fa-wallet text-green-600 w-6"></i><span>钱包</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="openFavorites"><div class="flex items-center gap-3"><i class="fas fa-cube text-orange-500 w-6"></i><span>收藏</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="openStickerManager"><div class="flex items-center gap-3"><i class="fas fa-smile text-yellow-500 w-6"></i><span>表情</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50"><div class="flex items-center gap-3"><i class="fas fa-cog text-blue-600 w-6"></i><span>设置</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div></div>
                </div>
            </main>

            <!-- 底部悬浮导航 (聊天房间和聊天详情不显示) -->
            <div v-if="wechatState.activeNav !== 'room' && wechatState.activeNav !== 'chat-details' && wechatState.activeNav !== 'chat-bg-settings' && wechatState.activeNav !== 'red-packet-detail' && wechatState.activeNav !== 'wallet' && wechatState.activeNav !== 'qinmi-manage' && wechatState.activeNav !== 'qinmi-specific-detail' && wechatState.activeNav !== 'moments'" class="absolute bottom-6 left-1/2 -translate-x-1/2 wechat-bottom-nav flex items-center justify-around px-4 z-20">
                <div @click="wechatState.activeNav='chat'" class="flex items-center justify-center w-10 h-full cursor-pointer transition text-xl" :class="wechatState.activeNav==='chat' ? 'text-black' : 'text-gray-400'"><i class="fas fa-comment"></i></div>
                <div @click="wechatState.activeNav='contacts'" class="flex items-center justify-center w-10 h-full cursor-pointer transition text-xl" :class="wechatState.activeNav==='contacts' ? 'text-black' : 'text-gray-400'"><i class="fas fa-address-book"></i></div>
                <div @click="wechatState.activeNav='discover'" class="flex items-center justify-center w-10 h-full cursor-pointer transition text-xl" :class="wechatState.activeNav==='discover' ? 'text-black' : 'text-gray-400'"><i class="far fa-compass"></i></div>
                <div @click="wechatState.activeNav='me'" class="flex items-center justify-center w-10 h-full cursor-pointer transition text-xl" :class="wechatState.activeNav==='me' ? 'text-black' : 'text-gray-400'"><i class="far fa-user"></i></div>
            </div>

            <!-- 面具管理 View -->
            <transition name="page-slide"><div v-if="showMaskManager" class="absolute inset-0 z-[2000] bg-gray-50 flex flex-col"><div class="h-[90px] pt-10 px-4 flex items-center justify-between bg-white border-b border-gray-100 relative z-50"><button @click.stop="showMaskManager = false" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-chevron-left text-lg"></i></button><h1 class="text-[17px] font-bold">我的面具</h1><button @click="openMaskEditor(null)" class="w-8 h-8 flex items-center justify-center text-black pointer-events-auto"><i class="fas fa-plus text-lg"></i></button></div><div class="flex-1 overflow-y-auto p-4 space-y-3"><div v-if="masks.length === 0" class="text-center text-gray-400 mt-20 text-xs">暂无面具，请点击右上角添加</div><div v-for="mask in masks" :key="mask.id" @click="openMaskEditor(mask)" class="bg-white p-4 rounded-xl flex items-center gap-4 shadow-sm border border-gray-100 cursor-pointer active:bg-gray-50"><div class="w-12 h-12 rounded-full bg-gray-100 overflow-hidden shrink-0"><img v-if="mask.avatar" :src="mask.avatar" class="w-full h-full object-cover"><i v-else class="fas fa-mask flex h-full items-center justify-center text-purple-300 text-xl"></i></div><div><h3 class="font-bold text-gray-900">{{ mask.name }}</h3><p class="text-xs text-gray-400 line-clamp-1">{{ mask.bio || '暂无介绍' }}</p></div></div></div></div></transition>
        </div>
    </transition>

    <!-- 设置 App -->
    <transition name="app-slide"><div v-if="currentApp === 'settings'" class="absolute inset-0 z-[1000] bg-gray-50 flex flex-col overflow-hidden"><header class="bg-white/80 backdrop-blur h-[90px] pt-10 flex items-center justify-between px-4 border-b border-gray-200 sticky top-0 z-10"><button @click="navigateSettings('back')" class="w-8 h-8 flex items-center justify-center text-gray-800 bg-gray-100 rounded-full active:bg-gray-200 transition"><i v-if="settingsPage !== 'main'" class="fas fa-chevron-left text-sm"></i><i v-else class="fas fa-times text-sm"></i></button><h1 class="font-bold text-gray-900 text-[17px]">{{ settingsTitle }}</h1><div class="w-8"></div></header><main class="flex-1 overflow-y-auto relative"><transition name="page-slide"><div v-if="settingsPage === 'main'" class="absolute inset-0 p-4"><div class="space-y-4"><div class="bg-white rounded-2xl p-4 flex items-center gap-4 shadow-sm border border-gray-100"><div class="w-14 h-14 rounded-full bg-gray-100 overflow-hidden"><img v-if="homeProfile.avatar" :src="homeProfile.avatar" class="w-full h-full object-cover"></div><div><div class="font-bold text-lg">{{ homeProfile.name }}</div><div class="text-xs text-gray-400">@{{ homeProfile.id }}</div></div></div><div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 divide-y divide-gray-50"><div @click="navigateSettings('api-config')" class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-blue-500 text-white flex items-center justify-center"><i class="fas fa-robot"></i></div><span class="font-medium text-gray-800">API 配置</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div @click="navigateSettings('notification')" class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-green-500 text-white flex items-center justify-center"><i class="fas fa-bell"></i></div><span class="font-medium text-gray-800">消息提示音</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div @click="navigateSettings('data-manage')" class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-orange-500 text-white flex items-center justify-center"><i class="fas fa-database"></i></div><span class="font-medium text-gray-800">数据管理</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="p-4 flex items-center justify-between active:bg-gray-50"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-purple-500 text-white flex items-center justify-center"><i class="fas fa-expand"></i></div><span class="font-medium text-gray-800">全屏模式</span></div><input type="checkbox" id="toggle-fs" class="switch-checkbox" v-model="isFullScreen" @change="toggleFullScreen"><label for="toggle-fs" class="switch-label"><div class="switch-button"></div></label></div><div class="p-4 flex items-center justify-between active:bg-gray-50"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-gray-500 text-white flex items-center justify-center"><i class="fas fa-eye-slash"></i></div><span class="font-medium text-gray-800">隐藏状态栏</span></div><input type="checkbox" id="toggle-sb" class="switch-checkbox" v-model="hideStatusBar" @change="saveData"><label for="toggle-sb" class="switch-label"><div class="switch-button"></div></label></div></div></div></div></transition><transition name="page-slide"><div v-if="settingsPage === 'api-config'" class="absolute inset-0 p-4"><div class="space-y-5 pb-10"><div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 space-y-4"><div><label class="text-xs font-bold text-gray-500 ml-1 mb-1 block">反代地址</label><input v-model="apiConfig.baseUrl" placeholder="https://..." class="w-full bg-gray-50 p-3 rounded-xl text-sm font-mono border border-gray-200 outline-none"></div><div><label class="text-xs font-bold text-gray-500 ml-1 mb-1 block">API 密钥</label><input v-model="apiConfig.apiKey" type="password" placeholder="sk-..." class="w-full bg-gray-50 p-3 rounded-xl text-sm font-mono border border-gray-200 outline-none"></div><div class="flex items-center gap-2"><button @click="fetchModels" :disabled="isLoading" class="flex-1 bg-gray-900 text-white py-2.5 rounded-xl text-sm font-bold active:scale-95 transition flex items-center justify-center gap-2"><i v-if="isLoading" class="fas fa-spinner fa-spin"></i><span v-else>拉取模型</span></button></div><div v-if="availableModels.length > 0" class="animate-fade-in"><label class="text-xs font-bold text-gray-500 ml-1 mb-1 block">选择模型</label><div @click="modelSelectModal.show = true" class="w-full bg-gray-50 p-3 rounded-xl text-sm font-medium border border-gray-200 flex justify-between items-center cursor-pointer"><span>{{ apiConfig.selectedModel || '点击选择' }}</span><i class="fas fa-chevron-down text-gray-400 text-xs"></i></div></div></div><div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100"><div class="p-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50"><span class="font-bold text-gray-800 text-sm">API 预设</span><button @click="savePreset" class="text-blue-600 text-xs font-bold px-3 py-1 bg-blue-50 rounded-lg active:bg-blue-100">保存</button></div><div v-if="apiPresets.length === 0" class="p-8 text-center text-gray-400 text-xs">暂无预设</div><div v-else class="divide-y divide-gray-50"><div v-for="(preset, idx) in apiPresets" :key="idx" class="p-4 flex items-center justify-between"><div class="flex-1 min-w-0 mr-4"><div class="font-bold text-gray-800 text-sm truncate">{{ preset.name }}</div><div class="text-[10px] text-gray-400 truncate">{{ preset.baseUrl }}</div></div><div class="flex items-center gap-2"><button @click="applyPreset(preset)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-green-100 hover:text-green-600 transition"><i class="fas fa-check text-xs"></i></button><button @click="deletePreset(idx)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-red-100 hover:text-red-600 transition"><i class="fas fa-trash text-xs"></i></button></div></div></div></div><button @click="saveSettings" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-200 active:scale-95 transition">保存配置</button></div></div></transition><transition name="page-slide"><div v-if="settingsPage === 'data-manage'" class="absolute inset-0 p-4"><div class="space-y-4"><div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center"><div class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-database"></i></div><h3 class="font-bold text-gray-900 text-lg">数据管理</h3><p class="text-xs text-gray-400 mt-2 px-4">备份恢复所有设置。</p></div><div class="grid grid-cols-2 gap-4"><button @click="exportData" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition"><div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-file-export"></i></div><span class="text-sm font-bold text-gray-700">导出</span></button><button @click="triggerImport" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition"><div class="w-10 h-10 rounded-full bg-green-50 text-green-500 flex items-center justify-center"><i class="fas fa-file-import"></i></div><span class="text-sm font-bold text-gray-700">导入</span></button></div><input type="file" ref="importInput" accept=".json" class="hidden" @change="handleImport"></div></div></transition><transition name="page-slide"><div v-if="settingsPage === 'notification'" class="absolute inset-0 p-4"><div class="space-y-4"><div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100"><div class="flex items-center justify-between mb-4"><span class="text-sm font-bold text-gray-700">当前提示音</span><span class="text-xs text-gray-400">{{ notificationConfig.currentName || '系统默认' }}</span></div><div class="flex gap-2"><button @click="triggerAudioUpload" class="flex-1 bg-gray-50 py-2.5 rounded-xl text-xs font-bold text-gray-700 active:bg-gray-100 transition border border-gray-100 flex items-center justify-center gap-2"><i class="fas fa-upload"></i> 导入</button><button @click="playCurrentSound" class="w-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center border border-green-100 active:scale-95 transition"><i class="fas fa-play"></i></button></div><input type="file" ref="audioInput" accept="audio/*" class="hidden" @change="handleAudioUpload"><button @click="simulateAiMessage" class="w-full mt-3 bg-gray-800 text-white py-2.5 rounded-xl text-xs font-bold active:bg-black transition">测试音效</button></div><div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100"><div class="p-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50"><span class="font-bold text-gray-800 text-sm">音频预设</span><button @click="saveSoundPreset" class="text-blue-600 text-xs font-bold px-3 py-1 bg-blue-50 rounded-lg active:bg-blue-100">保存</button></div><div v-if="soundPresets.length === 0" class="p-6 text-center text-gray-400 text-xs">暂无预设</div><div v-else class="divide-y divide-gray-50"><div v-for="(sound, idx) in soundPresets" :key="idx" class="p-4 flex items-center justify-between"><span class="font-bold text-gray-700 text-sm truncate max-w-[50%]">{{ sound.name }}</span><div class="flex items-center gap-2"><button @click="playPresetSound(sound)" class="w-7 h-7 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center"><i class="fas fa-play text-[10px]"></i></button><button @click="applySoundPreset(sound)" class="w-7 h-7 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-check text-[10px]"></i></button><button @click="deleteSoundPreset(idx)" class="w-7 h-7 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button></div></div></div></div></div></div></transition></main></div></transition>
    
    <!-- 主题 App -->
    <transition name="app-slide"><div v-if="currentApp === 'themes'" class="absolute inset-0 z-[1000] bg-gray-50 flex flex-col overflow-hidden"><header class="bg-white/80 backdrop-blur h-[90px] pt-10 flex items-center justify-between px-4 border-b border-gray-200 sticky top-0 z-10"><button @click="navigateThemes('back')" class="w-8 h-8 flex items-center justify-center text-gray-800 bg-gray-100 rounded-full active:bg-gray-200 transition"><i v-if="themesPage !== 'main'" class="fas fa-chevron-left text-sm"></i><i v-else class="fas fa-times text-sm"></i></button><h1 class="font-bold text-gray-900 text-[17px]">{{ themesTitle }}</h1><div class="w-8"></div></header><main class="flex-1 overflow-y-auto relative">
    <transition name="page-slide"><div v-if="themesPage === 'main'" class="absolute inset-0 p-4"><div class="grid grid-cols-1 gap-4">
        <div @click="navigateThemes('beautify')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer active:bg-gray-50 transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center text-xl"><i class="fas fa-magic"></i></div><div><div class="font-bold text-gray-800">美化设置</div><div class="text-xs text-gray-400 mt-0.5">气泡、聊天背景、UI 定制</div></div></div><i class="fas fa-chevron-right text-gray-300"></i></div>
        <div @click="navigateThemes('wallpaper')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer active:bg-gray-50 transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-xl"><i class="fas fa-image"></i></div><div><div class="font-bold text-gray-800">壁纸设置</div><div class="text-xs text-gray-400 mt-0.5">更换主屏幕背景</div></div></div><i class="fas fa-chevron-right text-gray-300"></i></div><div @click="navigateThemes('font')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer active:bg-gray-50 transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-pink-100 text-pink-600 flex items-center justify-center text-xl"><i class="fas fa-font"></i></div><div><div class="font-bold text-gray-800">字体设置</div><div class="text-xs text-gray-400 mt-0.5">自定义字体、大小和颜色</div></div></div><i class="fas fa-chevron-right text-gray-300"></i></div><div @click="navigateThemes('icons')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer active:bg-gray-50 transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center text-xl"><i class="fas fa-icons"></i></div><div><div class="font-bold text-gray-800">图标设置</div><div class="text-xs text-gray-400 mt-0.5">自定义 App 图标与名称</div></div></div><i class="fas fa-chevron-right text-gray-300"></i></div></div></div></transition>
    
    <!-- 美化设置页面 -->
    <transition name="page-slide">
        <div v-if="themesPage === 'beautify'" class="absolute inset-0 p-4 pb-20 flex flex-col">
            <!-- Tab切换 -->
            <div class="flex bg-gray-200 p-1 rounded-xl mb-4 shrink-0">
                <button @click="beautifyConfig.currentTab='bubble'" class="flex-1 py-1.5 text-xs font-bold rounded-lg transition" :class="beautifyConfig.currentTab==='bubble'?'bg-white shadow-sm text-black':'text-gray-500'">气泡美化</button>
                <button @click="beautifyConfig.currentTab='theme'" class="flex-1 py-1.5 text-xs font-bold rounded-lg transition" :class="beautifyConfig.currentTab==='theme'?'bg-white shadow-sm text-black':'text-gray-500'">主题美化</button>
            </div>

            <!-- 气泡美化 Tab -->
            <div v-if="beautifyConfig.currentTab === 'bubble'" class="flex-1 flex flex-col gap-4 overflow-hidden">
                <!-- 预览区域 -->
                <div class="bg-gray-100 rounded-2xl p-4 border border-gray-200 shrink-0">
                    <div class="text-xs text-gray-400 mb-2 text-center font-bold">效果预览</div>
                    <div class="flex flex-col gap-3">
                        <div class="flex gap-2">
                            <div class="w-8 h-8 rounded-lg bg-white shrink-0"></div>
                            <div class="chat-bubble chat-bubble-ai max-w-[80%] text-sm">你好，这是对方的气泡。</div>
                        </div>
                        <div class="flex gap-2 flex-row-reverse">
                            <div class="w-8 h-8 rounded-lg bg-green-500 shrink-0"></div>
                            <div class="chat-bubble chat-bubble-user max-w-[80%] text-sm">这是我发送的消息气泡。</div>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-gray-500 ml-1">CSS 代码</span>
                        <div class="flex gap-2">
                            <button @click="resetBeautify('bubble')" class="text-xs text-red-500 font-bold active:opacity-50">恢复默认</button>
                            <button @click="copyDefaultCode('bubble')" class="text-xs text-blue-500 font-bold active:opacity-50">复制源代码</button>
                        </div>
                    </div>
                    <textarea v-model="beautifyConfig.tempCode" placeholder="输入 CSS 代码..." class="flex-1 bg-gray-50 p-3 rounded-xl text-xs font-mono border border-gray-200 outline-none resize-none mb-2"></textarea>
                    <div class="flex gap-2 mb-4 shrink-0">
                        <button @click="applyBeautifyCode('bubble')" class="flex-1 bg-black text-white py-2.5 rounded-xl text-xs font-bold active:scale-95 transition">应用更改</button>
                        <button @click="saveBeautifyPreset('bubble')" class="w-20 bg-gray-200 text-gray-700 py-2.5 rounded-xl text-xs font-bold active:scale-95 transition">保存预设</button>
                    </div>
                    
                    <div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 flex-1 overflow-y-auto">
                        <div class="p-3 border-b border-gray-50 bg-gray-50/50 text-xs font-bold text-gray-500">我的预设</div>
                        <div v-if="beautifyConfig.bubblePresets.length === 0" class="p-6 text-center text-gray-400 text-xs">暂无预设</div>
                        <div v-else class="divide-y divide-gray-50">
                            <div v-for="(preset, idx) in beautifyConfig.bubblePresets" :key="idx" class="p-3 flex items-center justify-between">
                                <span class="font-bold text-gray-700 text-xs truncate">{{ preset.name }}</span>
                                <div class="flex items-center gap-2">
                                    <button @click="loadBeautifyPreset('bubble', preset)" class="w-6 h-6 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-check text-[10px]"></i></button>
                                    <button @click="deleteBeautifyPreset('bubble', idx)" class="w-6 h-6 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主题美化 Tab -->
            <div v-if="beautifyConfig.currentTab === 'theme'" class="flex-1 flex flex-col gap-4 overflow-hidden">
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-gray-500 ml-1">CSS 代码 (聊天界面整体)</span>
                        <div class="flex gap-2">
                            <button @click="resetBeautify('theme')" class="text-xs text-red-500 font-bold active:opacity-50">恢复默认</button>
                            <button @click="copyDefaultCode('theme')" class="text-xs text-blue-500 font-bold active:opacity-50">复制源代码</button>
                        </div>
                    </div>
                    <textarea v-model="beautifyConfig.tempCode" placeholder="输入 CSS 代码..." class="flex-1 bg-gray-50 p-3 rounded-xl text-xs font-mono border border-gray-200 outline-none resize-none mb-2"></textarea>
                    <div class="flex gap-2 mb-4 shrink-0">
                        <button @click="applyBeautifyCode('theme')" class="flex-1 bg-black text-white py-2.5 rounded-xl text-xs font-bold active:scale-95 transition">应用更改</button>
                        <button @click="saveBeautifyPreset('theme')" class="w-20 bg-gray-200 text-gray-700 py-2.5 rounded-xl text-xs font-bold active:scale-95 transition">保存预设</button>
                    </div>
                    
                    <div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 flex-1 overflow-y-auto">
                        <div class="p-3 border-b border-gray-50 bg-gray-50/50 text-xs font-bold text-gray-500">我的预设</div>
                        <div v-if="beautifyConfig.themePresets.length === 0" class="p-6 text-center text-gray-400 text-xs">暂无预设</div>
                        <div v-else class="divide-y divide-gray-50">
                            <div v-for="(preset, idx) in beautifyConfig.themePresets" :key="idx" class="p-3 flex items-center justify-between">
                                <span class="font-bold text-gray-700 text-xs truncate">{{ preset.name }}</span>
                                <div class="flex items-center gap-2">
                                    <button @click="loadBeautifyPreset('theme', preset)" class="w-6 h-6 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-check text-[10px]"></i></button>
                                    <button @click="deleteBeautifyPreset('theme', idx)" class="w-6 h-6 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="page-slide"><div v-if="themesPage === 'wallpaper'" class="absolute inset-0 p-4 space-y-6"><div class="w-full aspect-[9/16] bg-gray-200 rounded-3xl overflow-hidden shadow-lg relative mx-auto max-w-[240px] border-4 border-white"><img v-if="themeConfig.wallpaper" :src="themeConfig.wallpaper" class="w-full h-full object-cover"><div v-else class="w-full h-full flex flex-col items-center justify-center text-gray-400 bg-gray-100"><i class="fas fa-image text-3xl mb-2"></i><span class="text-xs">默认壁纸</span></div></div><div class="flex flex-col gap-3"><button @click="triggerWallpaperUpload" class="w-full bg-gray-900 text-white py-3.5 rounded-2xl font-bold active:scale-95 transition shadow-lg">从相册选择</button><button @click="resetWallpaper" class="w-full bg-white text-gray-600 py-3.5 rounded-2xl font-bold border border-gray-200 active:bg-gray-50 transition">恢复默认</button></div><input type="file" ref="wallpaperInput" accept="image/*" class="hidden" @change="handleWallpaperUpload"></div></transition><transition name="page-slide"><div v-if="themesPage === 'font'" class="absolute inset-0 p-4 pb-20"><div class="space-y-6"><div class="bg-gray-100 rounded-2xl p-6 text-center border border-gray-200" :style="{fontFamily: previewFontFamily || themeConfig.fontFamily}"><div class="text-2xl font-bold mb-2" :style="{color: themeConfig.fontColor}">12:30</div><div class="text-lg" :style="{color: themeConfig.fontColor}">Hello World</div><div class="text-sm opacity-60" :style="{color: themeConfig.fontColor}">预览字体效果</div></div><div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-3"><label class="text-xs font-bold text-gray-500 ml-1">字体 URL</label><div class="flex gap-2"><input v-model="fontInputUrl" placeholder="https://..." class="w-2/3 bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 outline-none"><button @click="previewFontFromUrl" :disabled="isLoading" class="flex-1 bg-gray-100 text-gray-600 px-2 rounded-xl font-bold text-xs active:scale-95 transition"><span v-if="!isLoading">预览</span><i v-else class="fas fa-spinner fa-spin"></i></button><button @click="applyFontFromUrl" class="flex-1 bg-black text-white px-2 rounded-xl font-bold text-xs active:scale-95 transition">应用</button></div><button @click="resetFont" class="w-full bg-white text-red-500 py-2 rounded-xl font-bold text-xs border border-gray-100 active:bg-gray-50">恢复默认字体</button></div><div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-4"><div><div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-500">大小</span><span class="text-xs text-gray-400">{{ (themeConfig.fontSize * 100).toFixed(0) }}%</span></div><input type="range" min="0.8" max="1.2" step="0.05" v-model.number="themeConfig.fontSize" @change="saveData" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-500">色号</span></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full border border-gray-200 shadow-sm shrink-0" :style="{backgroundColor: themeConfig.fontColor}"></div><input type="text" v-model="themeConfig.fontColor" @change="saveData" placeholder="#000000" class="flex-1 bg-gray-50 px-3 py-2 rounded-xl text-sm border border-gray-200 font-mono outline-none uppercase"></div></div></div><div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100"><div class="p-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50"><span class="font-bold text-gray-800 text-sm">预设</span><button @click="saveFontPreset" class="text-blue-600 text-xs font-bold px-3 py-1 bg-blue-50 rounded-lg active:bg-blue-100">保存</button></div><div v-if="fontPresets.length === 0" class="p-6 text-center text-gray-400 text-xs">无预设</div><div v-else class="divide-y divide-gray-50"><div v-for="(fp, idx) in fontPresets" :key="idx" class="p-4 flex items-center justify-between"><div class="flex-1 min-w-0 mr-2"><div class="font-bold text-gray-800 text-sm truncate" :style="{fontFamily: fp.fontFamily}">{{ fp.name }}</div></div><div class="flex items-center gap-2"><button @click="applyFontPreset(fp)" class="w-7 h-7 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-check text-[10px]"></i></button><button @click="deleteFontPreset(idx)" class="w-7 h-7 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button></div></div></div></div></div></div></transition><transition name="page-slide"><div v-if="themesPage === 'icons'" class="absolute inset-0 p-4 pb-20"><div class="space-y-4"><div class="flex justify-end"><button @click="resetAllIcons" class="text-xs text-red-500 font-bold px-3 py-1 bg-red-50 rounded-lg active:bg-red-100">重置所有</button></div><div class="space-y-3"><div v-for="appId in appList" :key="appId" class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex flex-col gap-3"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl border border-gray-100 overflow-hidden flex items-center justify-center bg-gray-50 shrink-0 home-icon-custom"><img v-if="hasCustomIcon(appId)" :src="getAppIcon(appId)" class="w-full h-full object-cover"><i v-else :class="getDefaultIconClass(appId) + ' text-gray-400 text-xl'"></i></div><div class="flex-1"><label class="text-[10px] font-bold text-gray-400 mb-1 block">应用名称</label><input :value="getAppName(appId)" @input="(e)=>setAppName(appId, e.target.value)" class="w-full bg-gray-50 px-2 py-1.5 rounded-lg text-sm border border-gray-200 outline-none"></div></div><div class="flex gap-2"><input v-model="tempIconUrls[appId]" placeholder="图标 URL" class="flex-1 bg-gray-50 px-3 py-2 rounded-lg text-xs border border-gray-200 outline-none"><button @click="setAppIcon(appId, tempIconUrls[appId])" class="px-3 bg-black text-white rounded-lg text-xs font-bold">确定</button><button @click="triggerIconUpload(appId)" class="px-3 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold active:bg-gray-200"><i class="fas fa-image"></i></button><button @click="resetApp(appId)" class="px-3 bg-red-50 text-red-500 rounded-lg text-xs active:bg-red-100"><i class="fas fa-undo"></i></button></div></div></div><input type="file" ref="iconUploadInput" accept="image/*" class="hidden" @change="handleIconFile"></div></div></transition></main></div></transition>
    
    <!-- 世界书 App -->
    <transition name="app-slide"><div v-if="currentApp === 'worldbook'" class="absolute inset-0 z-[1000] bg-gray-50 flex flex-col overflow-hidden"><header class="bg-white/80 backdrop-blur h-[90px] pt-10 flex items-center justify-between px-4 border-b border-gray-200 sticky top-0 z-10"><button @click="closeApp" class="w-8 h-8 flex items-center justify-center text-gray-800 bg-gray-100 rounded-full active:bg-gray-200 transition"><i class="fas fa-times text-sm"></i></button><h1 class="font-bold text-gray-900 text-[17px]">世界书</h1><div class="flex gap-2"><button @click="openWorldModal('folder')" class="w-8 h-8 flex items-center justify-center text-yellow-600 bg-yellow-50 rounded-full"><i class="fas fa-folder-plus text-xs"></i></button><button @click="openWorldModal('file')" class="w-8 h-8 flex items-center justify-center text-blue-600 bg-blue-50 rounded-full"><i class="fas fa-file-circle-plus text-xs"></i></button></div></header><main class="flex-1 overflow-y-auto p-4 space-y-2"><div v-if="folders.length === 0 && rootFiles.length === 0" class="text-center text-gray-400 mt-20 text-xs">暂无内容，请点击右上角添加</div><div v-for="folder in folders" :key="folder.id" class="bg-white rounded-xl border border-gray-100 overflow-hidden shadow-sm"><div @click="toggleFolder(folder.id)" class="p-4 flex items-center justify-between active:bg-gray-50 transition cursor-pointer"><div class="flex items-center gap-3"><i class="fas fa-folder text-yellow-400 text-lg"></i><span class="font-bold text-gray-800 text-sm">{{ folder.name }}</span></div><div class="flex items-center gap-3"><button @click.stop="deleteWorldItem(folder.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button><i class="fas fa-chevron-right text-gray-300 text-xs transition-transform duration-200" :class="{'rotate-90': expandedFolders.includes(folder.id)}"></i></div></div><transition name="expand"><div v-if="expandedFolders.includes(folder.id)" class="bg-gray-50 border-t border-gray-100"><div v-if="getFiles(folder.id).length===0" class="p-3 text-center text-xs text-gray-400">空文件夹</div><div v-for="file in getFiles(folder.id)" :key="file.id" @click="viewFile(file)" class="p-3 pl-10 border-b border-gray-100 last:border-0 flex items-center justify-between active:bg-gray-100 cursor-pointer"><div class="flex items-center gap-3"><i class="fas fa-file-alt text-blue-400 text-sm"></i><span class="text-sm text-gray-700">{{ file.name }}</span></div><div class="flex items-center gap-3"><div @click.stop class="flex items-center"><input type="checkbox" class="switch-checkbox-sm" :id="'wf-'+file.id" :checked="file.isActive !== false" @change="toggleFileActive(file)"><label :for="'wf-'+file.id" class="switch-label-sm"><div class="switch-button-sm"></div></label></div><button @click.stop="deleteWorldItem(file.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button></div></div></div></transition></div><div v-for="file in rootFiles" :key="file.id" @click="viewFile(file)" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between active:scale-[0.98] transition cursor-pointer"><div class="flex items-center gap-3"><i class="fas fa-file-alt text-gray-400 text-lg"></i><span class="font-bold text-gray-800 text-sm">{{ file.name }}</span></div><div class="flex items-center gap-3"><div @click.stop class="flex items-center"><input type="checkbox" class="switch-checkbox-sm" :id="'wf-'+file.id" :checked="file.isActive !== false" @change="toggleFileActive(file)"><label :for="'wf-'+file.id" class="switch-label-sm"><div class="switch-button-sm"></div></label></div><button @click.stop="deleteWorldItem(file.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button></div></div></main></div></transition>
    <transition name="scale"><div v-if="viewFileModal.show" class="fixed inset-0 z-[9000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[85%] max-h-[70%] rounded-3xl overflow-hidden shadow-2xl flex flex-col"><div class="p-4 border-b border-gray-100 flex justify-between items-center"><h3 class="font-bold text-lg">{{ viewFileModal.data.name }}</h3><button @click="saveFileContent" class="text-blue-600 font-bold text-sm">保存</button></div><textarea v-model="viewFileModal.data.content" class="flex-1 p-4 text-sm leading-relaxed outline-none resize-none"></textarea><button @click="viewFileModal.show=false" class="p-4 bg-gray-50 text-gray-500 font-bold text-sm">关闭</button></div></div></transition>

</div>

<script>
const { createApp } = Vue;

const compressImage = (file, maxWidth = 800, quality = 0.8) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = reject;
        };
        reader.onerror = reject;
    });
};

const DEFAULT_APPS = {
    'wechat': { name: '微信', iconClass: 'fas fa-comment' },
    'themes': { name: '主题', iconClass: 'fas fa-palette' },
    'worldbook': { name: '世界书', iconClass: 'fas fa-book-atlas' },
    'settings': { name: '设置', iconClass: 'fas fa-cog' },
    'icity': { name: 'icity', iconClass: 'fas fa-city' },
    'forum': { name: '论坛', iconClass: 'fas fa-users' },
    'check': { name: '查岗', iconClass: 'fas fa-magnifying-glass-location' },
    'pinxixi': { name: '拼夕夕', iconClass: 'fas fa-bag-shopping' }
};

// 默认源代码 - 气泡
const DEFAULT_BUBBLE_CODE = `/* AI 气泡 (左) */
.chat-bubble-ai { 
    background-color: #ffffff; 
    color: #333; 
    border-radius: 18px; 
    border-top-left-radius: 4px; 
}
/* 用户 气泡 (右) */
.chat-bubble-user { 
    background-color: #f2f2f2; 
    color: #333; 
    border-radius: 18px; 
    border-top-right-radius: 4px; 
}`;

// 默认源代码 - 主题
const DEFAULT_THEME_CODE = `/* 顶部导航栏背景 */
header { background-color: rgba(255,255,255,0.95); }
/* 返回键 */
.fa-chevron-left { color: #000; }
/* 更多菜单(三个点) */
.fa-ellipsis-h { color: #000; }
/* 输入栏背景 */
.chat-input-area { background-color: #fff; }
/* 功能键图标颜色 (回形针, 话筒, 笑脸) */
.fa-paperclip, .fa-microphone, .fa-smile { color: #6b7280; }
/* 发送按钮 */
.fa-check-circle { color: #6b7280; }
/* 接收按钮 */
.fa-comment-dots { color: #9ca3af; }
/* 红包卡片 */
.chat-bubble-redpacket { background: #ea5f39 !important; }
/* 转账卡片 */
.chat-bubble-transfer { background: #fa9d3b !important; }`;

createApp({
    data() {
        return {
            isActivated: false,
            isAppOpen: false, currentApp: null, settingsPage: 'main', themesPage: 'main', isLoading: false, isFullScreen: false, hideStatusBar: false,
            apiConfig: { baseUrl: '', apiKey: '', selectedModel: 'gpt-3.5-turbo' }, availableModels: [], apiPresets: [], 
            notificationConfig: { currentSound: null, currentName: '默认提示音' }, soundPresets: [],
            themeConfig: { wallpaper: '', fontFamily: '', fontUrl: '', fontSize: 1.0, fontColor: '#000000' }, fontPresets: [], fontInputUrl: '',
            
            // 美化配置
            beautifyConfig: {
                activeBubbleCSS: '',
                activeThemeCSS: '',
                bubblePresets: [],
                themePresets: [],
                currentTab: 'bubble', // 'bubble' or 'theme'
                tempCode: ''
            },

            previewFontFamily: '', 
            appList: Object.keys(DEFAULT_APPS), appCustomization: {}, tempIconUrls: {}, uploadingAppId: null,
            wechatState: { activeFilter: 'Chats', activeNav: 'chat', contacts: [], searchQuery: '', friendList: [], sessions: [], activeSession: null, showPlusMenu: false, showChatFunctions: false, showAttachMenu: false, groups: [] },
            expandedGroups: ['all'],
            groupSelectModal: { show: false },
            addContactModal: { show: false }, chatWizard: { show: false, step: 1, type: 'single', selectedContacts: [], selectedMask: null },
            newContact: { name: '', remark: '', username: '', gender: '男', bio: '', nudge: '', signature: '', avatar: '' },
            masks: [], showMaskManager: false, maskModal: { show: false }, maskForm: { id: null, name: '', remark: '', username: '', gender: '女', bio: '', nudge: '', signature: '', avatar: '' },
            worldData: [], expandedFolders: [], worldModal: { show: false, type: 'folder', name: '', content: '', parentId: '' }, viewFileModal: { show: false, data: {} },
            worldBinderModal: { show: false },
            modelSelectModal: { show: false }, 
            chatContextMenu: { show: false, x: 0, y: 0, msg: null, index: -1, isSelf: false },
            folderSelectModal: { show: false }, 
            
            // Global Notifications & Status
            globalNotification: { show: false, title: '', content: '', avatar: '', sessionId: '' },
            statusModal: { show: false }, statusHistoryModal: { show: false },
            currentStatus: { action: '', thought: '', outfit: '', note: '' },
            currentStatusHistory: [], 
            
            // Favorites & History Selection
            favorites: [], 
            favoritesModal: { show: false },
            isStatusMultiSelectMode: false,
            selectedStatusIndices: [],

            // Forward Modal (Reused for Qinmi Friend Select)
            forwardModal: { show: false, mode: 'forward' }, forwardingMsg: null, isMultiSelectMode: false, selectedMessageIds: [],
            
            // Voice Input
            voiceInputModal: { show: false, content: '' },

            // Sticker System
            showStickerManager: false,
            showStickerPanel: false,
            isStickerMultiSelect: false,
            selectedStickerIds: [],
            activeStickerGroupId: 'all',
            stickerGroups: [ {id: 'all', name: '全部'} ],
            stickers: [], 
            
            imageUploadInput: null, 

            // Red Packet & Transfer & Wallet & Intimate Pay
            redPacketModal: { show: false, amount: '', note: '' },
            transferModal: { show: false, amount: '', note: '' },
            currentRedPacketData: null,
            wallet: { balance: 0.00, transactions: [], intimatePays: [] },
            qinmiSelectModal: { show: false },
            paymentSelectModal: { show: false, amount: 0 },
            activeQinmiDetail: null,

            // Moments
            moments: [],
            showPublishMoment: false,
            newMoment: { content: '', images: [], location: '', mentions: [], visibility: 'public', visibilityGroups: [], visibilityFriends: [] },
            momentsBackground: '',
            mentionModal: { show: false, selectedIds: [] },
            visibilityModal: { show: false },
            visibilityTargetModal: { show: false, mode: '', selectedGroupIds: [], selectedFriendIds: [] },
            
            // AI Moments Generation
            momentGenerateModal: { show: false, selectedIds: [] },
            
            activeMomentMenuId: null,
            activeCommentMomentId: null,
            commentInput: '',
            replyTarget: null, 

            // Chat Avatar Override
            avatarSettingModal: { show: false, selfUrl: '', targetUrl: '' },

            cardProfile: { name: '输入文字', id: '输入文字', bio: '你對我來說是宇宙，但我對你來說只是一顆星嗎？', status: '该用户已注销', avatar: '' },
            homeProfile: { name: '点击修改名字', id: 'username', bio: '点击修改个性签名', location: '未知星系', avatar: '' },
            homeConfig: { widgetTitle: '输入文字', rightWidgetTitle: '输入文字' },
            customWidgets: [ { id: 1, bubble: '状态', image: '', label: '组件A' }, { id: 2, bubble: '心情', image: '', label: '组件B' } ],
            editingWidgetId: null,
            statusBar: { time: '', batteryLevel: 100, isCharging: false },
            displayDate: { dateString: '', dayString: '' },
            timer: null, toast: { show: false, message: '' }, 
            inputModal: { show: false, title: '', value: '', placeholder: '', callback: null, desc: '', inputType: 'text' }, 
            confirmModal: { show: false, message: '', callback: null },
            inputMsg: '', deviceId: '', isTyping: false, replyingTo: null
        }
    },
    computed: {
        settingsTitle() { if (this.settingsPage === 'api-config') return 'API 配置'; if (this.settingsPage === 'data-manage') return '数据管理'; if (this.settingsPage === 'notification') return '消息提示音'; return '系统设置'; },
        themesTitle() { if (this.themesPage === 'wallpaper') return '壁纸设置'; if (this.themesPage === 'font') return '字体设置'; if (this.themesPage === 'icons') return '图标设置'; if (this.themesPage === 'beautify') return '美化设置'; return '主题商店'; },
        folders() { return this.worldData.filter(i => i.type === 'folder'); },
        rootFiles() { return this.worldData.filter(i => i.type === 'file' && !i.parentId); },
        filteredWechatContacts() {
            let sessions = [...this.wechatState.sessions];
            sessions.sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                return b.time - a.time;
            });
            if (!this.wechatState.searchQuery) return sessions;
            const query = this.wechatState.searchQuery.toLowerCase();
            return sessions.filter(c => c.name.toLowerCase().includes(query));
        },
        filteredStickers() {
            if(this.activeStickerGroupId === 'all') return this.stickers;
            return this.stickers.filter(s => s.groupId === this.activeStickerGroupId);
        }
    },
    mounted() { 
        this.initDevice();
        this.loadData();
        // 初始应用样式
        this.updateDynamicStyles();
        
        this.imageUploadInput = document.createElement('input');
        this.imageUploadInput.type = 'file';
        this.imageUploadInput.accept = 'image/*';
        this.imageUploadInput.onchange = this.handleImageUploadForChat;
        
        setTimeout(() => {
            const loader = document.getElementById('loading-screen');
            if(loader) loader.style.opacity = '0';
            setTimeout(()=> { if(loader)loader.style.visibility='hidden'; }, 800);
            if(this.isActivated) {
                document.getElementById('app').style.display = 'flex';
                document.getElementById('activation-screen').classList.add('hidden-screen');
            } else {
                document.getElementById('activation-screen').classList.remove('hidden-screen');
            }
        }, 2000);

        this.updateTime(); this.timer = setInterval(this.updateTime, 1000); this.initBattery();
        document.addEventListener("fullscreenchange", () => { this.isFullScreen = !!document.fullscreenElement; });
        if(this.themeConfig.fontUrl && this.themeConfig.fontFamily) { 
            this.loadFont(this.themeConfig.fontUrl, this.themeConfig.fontFamily); 
            document.body.style.fontFamily = this.themeConfig.fontFamily;
        }
        window.attemptActivate = this.attemptActivate; 
    },
    unmounted() { clearInterval(this.timer); },
    watch: {
        'wechatState.activeNav'(newVal) {
            if (newVal === 'room') {
                this.scrollToBottom();
            }
        },
        'wechatState.activeSession': {
            handler(newVal) {
                if (newVal) {
                    this.currentStatus = newVal.status || {};
                    this.currentStatusHistory = newVal.statusHistory || [];
                }
            }, deep: true
        },
        'beautifyConfig.activeBubbleCSS'() { this.updateDynamicStyles(); },
        'beautifyConfig.activeThemeCSS'() { this.updateDynamicStyles(); },
        'themesPage'(newVal) {
            // 当进入美化页面时，清空临时代码框
            if(newVal === 'beautify') {
                this.beautifyConfig.tempCode = '';
            }
        },
        'beautifyConfig.currentTab'() {
            this.beautifyConfig.tempCode = '';
        }
    },
    methods: {
        // 美化功能相关逻辑
        updateDynamicStyles() {
            const styleTag = document.getElementById('dynamic-beautify-style');
            if (styleTag) {
                const bubbleCss = this.beautifyConfig.activeBubbleCSS || '';
                const themeCss = this.beautifyConfig.activeThemeCSS || '';
                styleTag.innerHTML = bubbleCss + '\n' + themeCss;
            }
        },
        resetBeautify(type) {
            if(type === 'bubble') {
                this.beautifyConfig.activeBubbleCSS = '';
                this.beautifyConfig.tempCode = '';
            } else {
                this.beautifyConfig.activeThemeCSS = '';
                this.beautifyConfig.tempCode = '';
            }
            this.updateDynamicStyles();
            this.saveData();
            this.showToast('已恢复默认');
        },
        copyDefaultCode(type) {
            if(type === 'bubble') {
                this.beautifyConfig.tempCode = DEFAULT_BUBBLE_CODE;
                this.copyToClipboard(DEFAULT_BUBBLE_CODE);
            } else {
                this.beautifyConfig.tempCode = DEFAULT_THEME_CODE;
                this.copyToClipboard(DEFAULT_THEME_CODE);
            }
            this.showToast('默认源码已复制到输入框和剪切板');
        },
        applyBeautifyCode(type) {
            if (type === 'bubble') {
                this.beautifyConfig.activeBubbleCSS = this.beautifyConfig.tempCode;
            } else {
                this.beautifyConfig.activeThemeCSS = this.beautifyConfig.tempCode;
            }
            this.saveData();
            this.showToast('样式已应用');
        },
        saveBeautifyPreset(type) {
            if(!this.beautifyConfig.tempCode) return this.showToast('代码为空');
            this.showInput('预设名称', '', '请输入备注名', (name) => {
                if(name) {
                    if (type === 'bubble') {
                        this.beautifyConfig.bubblePresets.push({ name: name, css: this.beautifyConfig.tempCode });
                    } else {
                        this.beautifyConfig.themePresets.push({ name: name, css: this.beautifyConfig.tempCode });
                    }
                    this.saveData();
                    this.showToast('预设已保存');
                }
            });
        },
        loadBeautifyPreset(type, preset) {
            this.beautifyConfig.tempCode = preset.css;
            if(type === 'bubble') this.beautifyConfig.activeBubbleCSS = preset.css;
            else this.beautifyConfig.activeThemeCSS = preset.css;
            this.saveData();
            this.showToast(`已应用预设: ${preset.name}`);
        },
        deleteBeautifyPreset(type, idx) {
            this.showConfirm('删除此预设？', () => {
                if (type === 'bubble') {
                    this.beautifyConfig.bubblePresets.splice(idx, 1);
                } else {
                    this.beautifyConfig.themePresets.splice(idx, 1);
                }
                this.saveData();
            });
        },
        copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        },

        initDevice() {
            let did = localStorage.getItem('onyunx_device_id');
            if(!did) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                const rand = (l) => Array.from({length:l}, ()=>chars[Math.floor(Math.random()*chars.length)]).join('');
                did = `${rand(3)}-${rand(4)}-${rand(4)}`;
                localStorage.setItem('onyunx_device_id', did);
            }
            this.deviceId = did;
            document.getElementById('device-id-display').innerText = did;
            const clean = did.replace(/-/g, '').toUpperCase();
            const map = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'; 
            let res = '';
            for(let i = 0; i < clean.length; i++) {
                let code = clean.charCodeAt(i);
                let mixed = (code * 7 + i * 13 + 99) % 36;
                res += map[mixed];
            }
            const validCode = `${res.substring(0,3)}-${res.substring(3,7)}-${res.substring(7,11)}`;
            console.log(`%c 🔑 [ADMIN] 当前设备激活码: ${validCode} `, 'background: #222; color: #bada55; font-size: 16px; padding: 10px;');
            this.validCode = validCode;
        },
        attemptActivate() {
            if (localStorage.getItem('onyunx_is_activated') === 'true') {
                this.isActivated = true; return;
            }
            const input = document.getElementById('activation-code');
            const err = document.getElementById('activation-error');
            const val = input.value.trim().toUpperCase();
            if(val === this.validCode) {
                this.isActivated = true;
                localStorage.setItem('onyunx_is_activated', 'true');
                this.saveData();
                const screen = document.getElementById('activation-screen');
                screen.style.transform = 'scale(1.1)'; screen.style.opacity = '0';
                setTimeout(() => { screen.classList.add('hidden-screen'); document.getElementById('app').style.display = 'flex'; }, 600);
            } else {
                input.classList.add('error'); err.classList.add('show');
                setTimeout(() => { input.classList.remove('error'); err.classList.remove('show'); }, 1000);
            }
        },

        openApp(name) { this.currentApp = name; this.isAppOpen = true; this.settingsPage = 'main'; this.themesPage = 'main'; },
        closeApp() { 
            this.isAppOpen = false; 
            setTimeout(() => { 
                this.currentApp = null; 
                this.showMaskManager = false; 
                this.showStickerManager = false;
                this.maskModal.show = false;
                this.addContactModal.show = false;
                this.chatWizard.show = false;
                this.statusModal.show = false;
                this.favoritesModal.show = false;
                this.qinmiSelectModal.show = false;
            }, 300); 
        },
        navigateSettings(t) { if (t === 'back') { if (this.settingsPage === 'main') this.closeApp(); else this.settingsPage = 'main'; } else { this.settingsPage = t; } },
        navigateThemes(t) { if (t === 'back') { if (this.themesPage === 'main') this.closeApp(); else this.themesPage = 'main'; } else { this.themesPage = t; } },
        toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e => { this.showToast("全屏失败: " + e.message); this.isFullScreen = false; }); } else { if (document.exitFullscreen) document.exitFullscreen(); } },

        // 分组功能相关逻辑
        createNewGroup() {
            this.showInput('新建分组', '', '请输入分组名称', (name) => {
                if (name && name.trim()) {
                    if (!this.wechatState.groups) this.wechatState.groups = [];
                    this.wechatState.groups.push({ id: 'group_' + Date.now(), name: name.trim() });
                    this.saveData();
                    this.showToast('分组创建成功');
                }
            });
        },
        toggleGroup(id) {
            if (!this.expandedGroups) this.expandedGroups = [];
            const idx = this.expandedGroups.indexOf(id);
            if (idx > -1) this.expandedGroups.splice(idx, 1);
            else this.expandedGroups.push(id);
        },
        deleteGroup(id) {
            this.showConfirm('确定删除该分组吗？（该分组下的好友不会被删除）', () => {
                this.wechatState.groups = this.wechatState.groups.filter(g => g.id !== id);
                this.wechatState.sessions.forEach(s => {
                    if (s.groupId === id) s.groupId = null;
                });
                this.saveData();
                this.showToast('分组已删除');
            });
        },
        assignToGroup(groupId) {
            if (this.wechatState.activeSession) {
                this.wechatState.activeSession.groupId = groupId;
                this.saveData();
                this.showToast(groupId ? '已移至分组' : '已移出分组');
            }
            this.groupSelectModal.show = false;
        },
        getGroupSessions(groupId) {
            return this.filteredWechatContacts.filter(s => s.groupId === groupId);
        },

        startChatWizard(type) { this.wechatState.showPlusMenu = false; this.chatWizard = { show: true, step: 1, type: type, selectedContacts: [], selectedMask: null }; },
        closeChatWizard() { this.chatWizard.show = false; },
        selectWizardMask(mask) { this.chatWizard.selectedMask = mask; this.chatWizard.step = 2; },
        selectWizardContact(friend) {
            if (this.chatWizard.type === 'single') { this.createSession(friend, this.chatWizard.selectedMask); this.chatWizard.show = false; }
            else { const idx = this.chatWizard.selectedContacts.indexOf(friend.id); if(idx > -1) this.chatWizard.selectedContacts.splice(idx, 1); else this.chatWizard.selectedContacts.push(friend.id); }
        },
        finishCreateChat() {
            if (this.chatWizard.selectedContacts.length === 0) return this.showToast('请选择成员');
            const groupFakeFriend = { id: Date.now().toString(), name: `群聊(${this.chatWizard.selectedContacts.length})`, avatar: '' }; 
            this.createSession(groupFakeFriend, this.chatWizard.selectedMask); this.chatWizard.show = false;
        },
        createSession(target, mask) {
            let session = this.wechatState.sessions.find(s => s.targetId === target.id);
            if (!session) {
                session = { 
                    id: Date.now().toString(), targetId: target.id, name: target.remark || target.name, 
                    avatar: target.avatar, maskId: mask.id, messages: [], lastMessage: '', time: Date.now(),
                    isPinned: false, boundWorldbookFolderId: null, boundWorldbookFolderIds: [],
                    status: {}, statusHistory: [], wallpaper: '', 
                    groupId: null, 
                    customAvatarSelf: '',
                    customAvatarTarget: ''
                };
                this.wechatState.sessions.unshift(session);
            }
            this.enterChatRoom(session); this.saveData();
        },
        enterChatRoom(session) { 
            this.wechatState.activeSession = session; 
            this.wechatState.activeNav = 'room'; 
            this.inputMsg = ''; 
            this.showStickerPanel = false;
            
            this.$nextTick(() => {
                setTimeout(() => {
                    const c = this.$refs.chatContainer;
                    if (c) c.scrollTop = c.scrollHeight;
                }, 50);
            });

            this.currentStatus = session.status || {};
            this.currentStatusHistory = session.statusHistory || [];
        },
        goToChatDetails() { this.wechatState.activeNav = 'chat-details'; },
        scrollToBottom() { 
            this.$nextTick(() => { 
                const c = this.$refs.chatContainer; 
                if (c) c.scrollTop = c.scrollHeight; 
            }); 
        },
        
        sendMessage() {
            if(!this.inputMsg.trim()) return;
            const msg = { content: this.inputMsg, isSelf: true, time: Date.now(), avatar: this.getMaskById(this.wechatState.activeSession.maskId).avatar };
            if(this.replyingTo) { msg.quote = { name: this.replyingTo.isSelf ? '我' : this.wechatState.activeSession.name, content: this.replyingTo.content }; this.replyingTo = null; }
            this.wechatState.activeSession.messages.push(msg);
            this.wechatState.activeSession.lastMessage = this.inputMsg;
            this.inputMsg = ''; this.scrollToBottom(); this.saveData();
        },
        triggerReceive() {
            if (!this.apiConfig.apiKey) { this.showToast('请先配置 API Key'); return; }
            this.isTyping = true; 
            this.generateAiReply();
        },
        async generateAiReply() {
            const session = this.wechatState.activeSession;
            const friend = this.wechatState.friendList.find(f => f.id === session.targetId);
            const mask = this.getMaskById(session.maskId);
            
            let worldContext = "";
            let folderIds = session.boundWorldbookFolderIds || [];
            if (session.boundWorldbookFolderId) folderIds.push(session.boundWorldbookFolderId);
            folderIds = [...new Set(folderIds)];

            if (folderIds.length > 0) {
                // Filter files: must be file type, in bound folder, AND isActive is true (or undefined)
                const files = this.worldData.filter(i => i.type === 'file' && folderIds.includes(i.parentId) && i.isActive !== false);
                if (files.length > 0) {
                    worldContext = "\n[World Info]:\n" + files.map(f => `(${f.name}): ${f.content}`).join("\n");
                }
            }
            
            const recentMoments = this.moments.slice(0, 5).map(m => `[Moment by ${m.name}]: ${m.content}`).join("\n");
            const momentContext = recentMoments ? `\n[Recent Social Media Moments]:\n${recentMoments}\n` : "";

            let contextMessages = [];
            let systemPrompt = `Roleplay Game. 
            You: ${friend ? friend.name : session.name}. Bio: ${friend ? friend.bio : 'None'}. 
            User: ${mask.name}. Bio: ${mask.bio}. 
            ${worldContext}
            ${momentContext}
            
            IMPORTANT: You must output ONLY a valid JSON object. No Markdown. No other text.
            Structure:
            {
              "reply": ["message 1", "message 2"], 
              "action": "current action description",
              "thought": "internal thoughts",
              "outfit": "current clothing",
              "note": "short diary note (0-100 words)",
              "fake_image": "OPTIONAL: description of a photo you want to send",
              "red_packet": { "amount": "8.88", "note": "Happy Day" },
              "transfer": { "amount": "52.00", "note": "For you" },
              "qinmi_reply": "accept" OR "reject" (Optional, use only if responding to Intimate Pay request)
            }
            "reply" is an array of strings. Split long text into natural short messages.`;
            
            contextMessages.push({ role: 'system', content: systemPrompt });
            const recentMsgs = session.messages.slice(-10); 
            
            recentMsgs.forEach(m => {
                if(!m.isRecalled) {
                    if (m.type === 'image') {
                         contextMessages.push({ 
                             role: m.isSelf ? 'user' : 'assistant', 
                             content: [
                                 { type: "text", text: "[Image sent]" },
                                 { type: "image_url", image_url: { url: m.content } }
                             ] 
                         });
                    } else if (m.type === 'moment') { 
                        contextMessages.push({ role: m.isSelf ? 'user' : 'assistant', content: `[Shared a moment: ${m.momentData.content}]` });
                    } else if (m.type === 'fake_image') {
                        contextMessages.push({ role: m.isSelf ? 'user' : 'assistant', content: `[Sent a fake photo with description: ${m.content}]` });
                    } else if (m.type === 'red_packet') {
                        contextMessages.push({ role: m.isSelf ? 'user' : 'assistant', content: `[Red Packet: ${m.note}]` });
                    } else if (m.type === 'transfer') {
                        contextMessages.push({ role: m.isSelf ? 'user' : 'assistant', content: `[Transfer: ${m.amount}]` });
                    } else if (m.type === 'qinmi_invite') {
                         contextMessages.push({ role: m.isSelf ? 'user' : 'assistant', content: m.inviteType === 'give' ? '[User wants to give Intimate Pay]' : '[User asks for Intimate Pay]' });
                    } else {
                        contextMessages.push({ role: m.isSelf ? 'user' : 'assistant', content: m.content });
                    }
                }
            });

            try {
                let url = this.apiConfig.baseUrl.trim().replace(/\/+$/, '');
                if (!url.endsWith('/v1')) url += '/v1';
                
                const res = await fetch(`${url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiConfig.apiKey.trim()}` },
                    body: JSON.stringify({ model: this.apiConfig.selectedModel, messages: contextMessages })
                });

                if (!res.ok) throw new Error(`API Request Failed: ${res.status}`);
                const data = await res.json();
                let rawContent = data.choices[0].message.content;
                
                let parsed = {};
                try {
                    rawContent = rawContent.replace(/```json/g, '').replace(/```/g, '').trim();
                    parsed = JSON.parse(rawContent);
                } catch (e) {
                    parsed = { reply: [rawContent], action: '', thought: '', outfit: '', note: '' };
                }

                const segments = Array.isArray(parsed.reply) ? parsed.reply : [parsed.reply || ""];
                
                if (parsed.thought || parsed.action) {
                    const statusObj = { time: Date.now(), action: parsed.action, thought: parsed.thought, outfit: parsed.outfit, note: parsed.note };
                    session.status = statusObj;
                    if(!session.statusHistory) session.statusHistory = [];
                    session.statusHistory.unshift(statusObj); 
                    this.currentStatus = statusObj; 
                }
                
                this.handleAiQinmiResponse(session, parsed.qinmi_reply);

                if (parsed.fake_image) {
                     const fiMsg = { type: 'fake_image', content: parsed.fake_image, isRevealed: false, isSelf: false, time: Date.now(), avatar: session.avatar };
                    session.messages.push(fiMsg); session.lastMessage = '[图片]';
                }

                if (parsed.red_packet || Math.random() < 0.05) {
                    const amount = parsed.red_packet ? parsed.red_packet.amount : (Math.random() * 100).toFixed(2);
                    const note = parsed.red_packet ? parsed.red_packet.note : "恭喜发财";
                    const rpMsg = { type: 'red_packet', amount: amount, note: note, isSelf: false, time: Date.now(), avatar: session.avatar };
                    session.messages.push(rpMsg); session.lastMessage = '[微信红包]';
                }

                if (parsed.transfer || Math.random() < 0.02) {
                    const amount = parsed.transfer ? parsed.transfer.amount : "520.00";
                    const note = parsed.transfer ? parsed.transfer.note : "转账给你";
                    const tfMsg = { type: 'transfer', amount: amount, note: note, isSelf: false, time: Date.now(), avatar: session.avatar };
                    session.messages.push(tfMsg); session.lastMessage = '[微信转账]';
                }

                this.isTyping = false; 
                this.handleAiIntimatePayConsumption(session);

                let delay = 0;
                segments.forEach((seg, index) => {
                    setTimeout(() => {
                         if (this.currentApp !== 'wechat' || this.wechatState.activeNav !== 'room' || this.wechatState.activeSession.id !== session.id) {
                             this.showGlobalNotification(session, seg);
                         }

                         let msgType = 'text';
                         let msgDuration = 0;
                         if (seg.trim().length > 0 && Math.random() < 0.15) {
                             msgType = 'voice';
                             msgDuration = Math.max(1, Math.min(60, Math.ceil(seg.length / 3)));
                         }

                         const aiMsg = { 
                             content: seg.trim(), 
                             isSelf: false, 
                             time: Date.now(), 
                             avatar: session.avatar,
                             type: msgType,
                             duration: msgDuration,
                             isExpanded: false
                         };
                         session.messages.push(aiMsg);
                         this.scrollToBottom();
                         
                         // 最后一条消息更新会话列表预览
                         if (index === segments.length - 1) {
                             session.lastMessage = msgType === 'voice' ? '[语音]' : seg.trim();
                             
                             // 随机撤回逻辑
                             if (Math.random() < 0.1) {
                                 setTimeout(() => {
                                     const targetIdx = session.messages.indexOf(aiMsg);
                                     if (targetIdx > -1) {
                                         session.messages[targetIdx].isRecalled = true; 
                                         this.saveData();
                                     }
                                 }, 3000);
                             }
                             this.saveData();
                         }
                         
                         if(this.notificationConfig.currentSound) new Audio(this.notificationConfig.currentSound).play();
                         
                         // 聊天内容触发 AI 发朋友圈 (概率)
                         if (Math.random() < 0.2) {
                             setTimeout(() => {
                                 this.generateAIMomentFromChat(session, seg);
                             }, 5000);
                         }
                    }, delay);
                    delay += 1000 + Math.random() * 800; 
                });

            } catch(e) {
                this.isTyping = false;
                this.showToast('AI 回复失败: ' + e.message);
            }
        },
        
        // 撤回弹窗只显示内容
        viewRecalled(msg) { this.showConfirm(msg.content, null); },
        
        showGlobalNotification(session, content) {
            this.globalNotification = { show: true, title: session.name, content: content, avatar: session.avatar, sessionId: session.id };
            setTimeout(() => { this.globalNotification.show = false; }, 3000);
        },
        jumpToChat(sessionId) {
            const session = this.wechatState.sessions.find(s => s.id === sessionId);
            if (session) { this.openApp('wechat'); this.enterChatRoom(session); this.globalNotification.show = false; }
        },
        showChatContextMenu(e, msg, index) {
            const rect = e.target.closest('.flex').getBoundingClientRect();
            this.chatContextMenu = { show: true, x: 20, y: rect.bottom + 5, msg, index, isSelf: msg.isSelf };
        },
        handleChatMenuAction(action) {
            const { msg, index } = this.chatContextMenu;
            const session = this.wechatState.activeSession;
            
            if (action === 'copy') { navigator.clipboard.writeText(msg.content); this.showToast('已复制'); }
            else if (action === 'delete') { session.messages.splice(index, 1); this.saveData(); }
            else if (action === 'recall') { session.messages[index].isRecalled = true; this.saveData(); this.showToast('已撤回'); }
            else if (action === 'quote') { this.replyingTo = msg; }
            else if (action === 'multi') { this.isMultiSelectMode = true; this.selectedMessageIds.push(msg); }
            else if (action === 'edit') { this.showInput("编辑", msg.content, "", (v) => { if(v){msg.content=v; this.saveData();} }); }
            else if (action === 'favorite') { this.addToFavorites(msg.content, 'message', session.name); this.showToast('已收藏'); }
            else if (action === 'regenerate') {
                let i = session.messages.length - 1;
                while (i >= 0) {
                    const m = session.messages[i];
                    if (!m.isSelf) { session.messages.splice(i, 1); } else { break; } 
                    i--;
                }
                this.saveData();
                this.triggerReceive(); 
            }
            else { this.showToast('功能开发中'); }
            this.chatContextMenu.show = false;
        },
        closeAllMenus() {
            this.chatContextMenu.show = false;
            this.wechatState.showPlusMenu = false;
            this.wechatState.showChatFunctions = false;
            this.wechatState.showAttachMenu = false;
            this.statusModal.show = false;
            this.showStickerPanel = false;
            this.groupSelectModal.show = false;
            this.activeMomentMenuId = null;
        },
        openStatusModal() {
            if(!this.wechatState.activeSession) return;
            this.currentStatus = this.wechatState.activeSession.status || { action: '无', thought: '...', outfit: '未知', note: '无' };
            this.currentStatusHistory = this.wechatState.activeSession.statusHistory || [];
            this.statusModal.show = true;
        },
        openStatusHistory() { 
            this.isStatusMultiSelectMode = false;
            this.selectedStatusIndices = [];
            this.statusHistoryModal.show = true; 
        },
        togglePin() { if (this.wechatState.activeSession) { this.wechatState.activeSession.isPinned = !this.wechatState.activeSession.isPinned; this.saveData(); } },
        
        // 世界书相关
        bindWorldFolder(folderId) {
            const session = this.wechatState.activeSession;
            if (!session) return;
            if (!session.boundWorldbookFolderIds) session.boundWorldbookFolderIds = [];
            if (folderId === null) { session.boundWorldbookFolderIds = []; session.boundWorldbookFolderId = null; } 
            else {
                const idx = session.boundWorldbookFolderIds.indexOf(folderId);
                if (idx > -1) session.boundWorldbookFolderIds.splice(idx, 1);
                else session.boundWorldbookFolderIds.push(folderId);
            }
            this.saveData();
        },
        toggleWorldBinding(fid) { this.bindWorldFolder(fid); }, 
        isFolderBound(fid) {
            const session = this.wechatState.activeSession;
            if (!session) return false;
            if (session.boundWorldbookFolderId === fid) return true; 
            return session.boundWorldbookFolderIds && session.boundWorldbookFolderIds.includes(fid);
        },
        getWorldbookStatus() {
            const session = this.wechatState.activeSession;
            if (!session) return '未绑定';
            let count = (session.boundWorldbookFolderIds?.length || 0) + (session.boundWorldbookFolderId ? 1 : 0);
            if (session.boundWorldbookFolderId && session.boundWorldbookFolderIds?.includes(session.boundWorldbookFolderId)) count--; 
            return count > 0 ? `已绑定 ${count} 个` : '未绑定';
        },
        selectModel(model) { this.apiConfig.selectedModel = model; this.saveData(); this.modelSelectModal.show = false; },
        getMaskById(id) { return this.masks.find(m => m.id === id) || { avatar: '' }; },
        formatChatTime(ts) { const d = new Date(ts); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; },
        editCurrentSessionFriend() { const session = this.wechatState.activeSession; if(!session) return; const friend = this.wechatState.friendList.find(f => f.id === session.targetId); if(friend) { this.editFriend(friend); } else { this.showToast('当前会话对象未在通讯录中'); } },
        getCurrentSessionAvatar() { 
             const session = this.wechatState.activeSession;
             if (!session) return '';
             return session.customAvatarTarget || session.avatar;
        },
        getCurrentSessionId() { const friend = this.wechatState.friendList.find(f => f.id === this.wechatState.activeSession?.targetId); return friend ? (friend.username || friend.id) : 'unknown'; },
        getCurrentSessionBio() { const friend = this.wechatState.friendList.find(f => f.id === this.wechatState.activeSession?.targetId); return friend ? (friend.signature || '暂无个性签名') : ''; },
        openAddContactModal() { this.newContact = { name: '', remark: '', username: '', gender: '男', bio: '', nudge: '', signature: '', avatar: '' }; this.addContactModal.show = true; },
        editFriend(friend) { this.newContact = { ...friend }; this.addContactModal.show = true; },
        triggerAddContactAvatar() { this.$refs.addContactAvatarInput.click(); },
        async handleAddContactAvatar(e) { const f = e.target.files[0]; if(!f) return; try { this.newContact.avatar = await compressImage(f, 300); } catch(e){} },
        saveNewContact() {
            if(!this.newContact.name) return this.showToast('请输入姓名');
            if (this.newContact.id) { const idx = this.wechatState.friendList.findIndex(f => f.id === this.newContact.id); if (idx !== -1) { this.wechatState.friendList[idx] = { ...this.newContact }; this.showToast('修改成功'); } } 
            else { this.wechatState.friendList.push({ ...this.newContact, id: Date.now().toString() }); this.showToast('已添加朋友'); }
            this.addContactModal.show = false; this.saveData();
        },
        openMaskManager() { this.showMaskManager = true; },
        openMaskEditor(mask) { 
            if (mask) { 
                this.maskForm = { ...mask }; 
            } else { 
                this.maskForm = { 
                    id: null, name: '', remark: '', username: '', gender: '女', bio: '', nudge: '', signature: '', avatar: '' 
                }; 
            } 
            this.maskModal.show = true; 
        },
        triggerMaskAvatar() { this.$refs.maskAvatarInput.click(); },
        async handleMaskAvatar(e) { const f=e.target.files[0]; if(!f)return; try { this.maskForm.avatar = await compressImage(f, 300); } catch(e){} },
        saveMask() {
            if(!this.maskForm.name) return this.showToast('请输入姓名');
            if(this.maskForm.id) { const idx = this.masks.findIndex(m => m.id === this.maskForm.id); if(idx !== -1) this.masks[idx] = { ...this.maskForm }; } 
            else { this.masks.push({ ...this.maskForm, id: Date.now().toString() }); }
            this.saveData(); this.maskModal.show = false; this.showToast('面具已保存');
        },
        deleteMask(id) { this.showConfirm('删除此面具？', () => { this.masks = this.masks.filter(m => m.id !== id); this.saveData(); this.maskModal.show = false; }); },
        async fetchModels() { if (!this.apiConfig.baseUrl) return this.showToast('请输入反代地址'); if (this.apiConfig.baseUrl.includes('api520.pro')) return this.showToast('该反代地址不稳定，已被屏蔽'); if (!this.apiConfig.apiKey) return this.showToast('请输入 API 密钥'); this.isLoading = true; try { let url = this.apiConfig.baseUrl.trim().replace(/\/+$/, ''); if (!url.endsWith('/v1')) url += '/v1'; const res = await fetch(`${url}/models`, { method: 'GET', headers: { 'Authorization': `Bearer ${this.apiConfig.apiKey.trim()}` } }); if (!res.ok) throw new Error(`HTTP ${res.status}`); const data = await res.json(); if (data && Array.isArray(data.data)) { this.availableModels = data.data.map(m => m.id); this.showToast(`获取成功: ${this.availableModels.length}个`); if (!this.apiConfig.selectedModel && this.availableModels.length > 0) this.apiConfig.selectedModel = this.availableModels[0]; this.modelSelectModal.show = true; } else throw new Error('数据格式错误'); } catch (e) { console.error(e); this.showToast('拉取失败: ' + e.message); if(this.availableModels.length===0) this.availableModels = ['gpt-3.5-turbo', 'gpt-4', 'claude-3-opus']; } finally { this.isLoading = false; } },
        openWorldModal(type) { this.worldModal = { show: true, type, name: '', content: '', parentId: '' }; },
        editWorldItem(item) { this.worldModal = { ...item, show: true }; this.worldModal.show = true; },
        saveWorldItem() { 
            if(!this.worldModal.name) return this.showToast('请输入名称'); 
            if (this.worldModal.id) { 
                const idx = this.worldData.findIndex(i => i.id === this.worldModal.id); 
                if (idx !== -1) { 
                    this.worldData[idx] = { ...this.worldData[idx], name: this.worldModal.name, content: this.worldModal.content, parentId: this.worldModal.parentId }; 
                } 
            } else { 
                const item = { 
                    id: Date.now().toString(), type: this.worldModal.type, name: this.worldModal.name, parentId: this.worldModal.parentId || null, isActive: true
                }; 
                if(this.worldModal.type === 'file') item.content = this.worldModal.content; 
                this.worldData.push(item); 
            } 
            this.saveData(); this.worldModal.show = false; 
        },
        deleteWorldItem(id) { this.showConfirm('确定删除？', () => { this.worldData = this.worldData.filter(i => i.id !== id && i.parentId !== id); this.saveData(); }); },
        toggleFolder(id) { const i = this.expandedFolders.indexOf(id); if (i > -1) this.expandedFolders.splice(i, 1); else this.expandedFolders.push(id); },
        getFiles(fid) { return this.worldData.filter(i => i.type === 'file' && i.parentId === fid); },
        viewFile(file) { this.editWorldItem(file); }, 
        getFolderName(id) { if(!id) return '未归类'; const f=this.folders.find(x=>x.id===id); return f?f.name:'未归类'; },
        selectWorldFolder(id) { this.worldModal.parentId = id; this.folderSelectModal.show = false; },
        saveFileContent() { this.saveData(); this.showToast('已保存'); },
        
        // 世界书开关逻辑
        toggleFileActive(file) {
            file.isActive = file.isActive === false ? true : false;
            this.saveData();
        },

        handleAppClick(id) { if(id==='themes'||id==='worldbook'||id==='settings'||id==='wechat')this.openApp(id); else this.showToast('仅作为展示'); },
        getAppName(id) { return (this.appCustomization[id] && this.appCustomization[id].name) ? this.appCustomization[id].name : DEFAULT_APPS[id].name; },
        hasCustomIcon(id) { return this.appCustomization[id] && this.appCustomization[id].icon; },
        getAppIcon(id) { return this.appCustomization[id] ? this.appCustomization[id].icon : ''; },
        getDefaultIconClass(id) { return DEFAULT_APPS[id].iconClass; },
        setAppName(id, name) { if(!this.appCustomization[id]) this.appCustomization[id] = {}; this.appCustomization[id].name = name; this.saveData(); },
        setAppIcon(id, url) { if(!url)return; if(!this.appCustomization[id]) this.appCustomization[id] = {}; this.appCustomization[id].icon = url; this.tempIconUrls[id] = ''; this.saveData(); this.showToast('图标已更新'); },
        triggerIconUpload(id) { this.uploadingAppId = id; this.$refs.iconUploadInput.click(); },
        async handleIconFile(e) { const f = e.target.files[0]; if(f && this.uploadingAppId) { try { const url = await compressImage(f, 200); this.setAppIcon(this.uploadingAppId, url); } catch(e){} } e.target.value = ''; },
        resetApp(id) { if(this.appCustomization[id]) { delete this.appCustomization[id]; this.saveData(); this.showToast('已重置'); } },
        resetAllIcons() { this.showConfirm("重置所有？", () => { this.appCustomization = {}; this.saveData(); }); },
        
        previewFontFromUrl() {
            if(!this.fontInputUrl) return this.showToast('请输入URL');
            const n = 'PreviewFont_' + Date.now();
            const font = new FontFace(n, `url(${this.fontInputUrl})`);
            font.load().then(f => {
                document.fonts.add(f);
                this.previewFontFamily = n;
                this.showToast('预览已更新');
            }).catch(e => this.showToast('加载失败'));
        },
        applyFontFromUrl() {
            if(this.previewFontFamily) {
                this.themeConfig.fontFamily = this.previewFontFamily;
                this.themeConfig.fontUrl = this.fontInputUrl;
                this.saveData();
                document.body.style.fontFamily = this.themeConfig.fontFamily;
                this.showToast('字体已应用');
            } else { this.showToast('请先预览字体'); }
        },
        async loadFont(u, n) { 
            try { const f = new FontFace(n, `url(${u})`); await f.load(); document.fonts.add(f); document.body.style.fontFamily = n; } catch(e){} 
        },
        resetFont() {
            this.themeConfig.fontFamily = '';
            this.themeConfig.fontUrl = '';
            document.body.style.fontFamily = '';
            this.saveData();
            this.showToast('已恢复默认字体');
        },

        saveFontPreset() { this.showInput("预设名称", "", "", (n) => { if(n) { this.fontPresets.push({ name:n, fontFamily:this.themeConfig.fontFamily, fontUrl:this.themeConfig.fontUrl, fontSize:this.themeConfig.fontSize, fontColor:this.themeConfig.fontColor }); this.saveData(); } }); },
        applyFontPreset(p) { if(p.fontUrl) this.loadFont(p.fontUrl, p.fontFamily); this.themeConfig.fontFamily=p.fontFamily; this.themeConfig.fontUrl=p.fontUrl; this.themeConfig.fontSize=p.fontSize; this.themeConfig.fontColor=p.fontColor; document.body.style.fontFamily=p.fontFamily; this.saveData(); },
        deleteFontPreset(i) { this.showConfirm("删除？",()=>{this.fontPresets.splice(i,1);this.saveData();}); },
        triggerWallpaperUpload() { this.$refs.wallpaperInput.click(); },
        async handleWallpaperUpload(e) { const f=e.target.files[0]; if(!f)return; try { this.themeConfig.wallpaper = await compressImage(f, 1080); this.saveData(); } catch(e){} },
        resetWallpaper() { this.themeConfig.wallpaper=''; this.saveData(); },
        triggerAudioUpload() { this.$refs.audioInput.click(); },
        handleAudioUpload(e) { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{this.notificationConfig.currentSound=ev.target.result; this.notificationConfig.currentName=f.name; this.saveData();}; r.readAsDataURL(f); },
        playCurrentSound() { if(this.notificationConfig.currentSound) new Audio(this.notificationConfig.currentSound).play(); },
        simulateAiMessage() { setTimeout(()=>{this.playCurrentSound(); this.showToast('收到消息');},2000); },
        saveSoundPreset() { this.showInput("名称", "", "", (n)=>{ if(n) { this.soundPresets.push({name:n, data:this.notificationConfig.currentSound}); this.saveData(); } }); },
        playPresetSound(s) { new Audio(s.data).play(); },
        applySoundPreset(s) { this.notificationConfig.currentSound=s.data; this.notificationConfig.currentName=s.name; this.saveData(); },
        deleteSoundPreset(i) { this.showConfirm("删除？",()=>{this.soundPresets.splice(i,1);this.saveData();}); },
        
        exportData() { const d={...this.$data}; delete d.isAppOpen; delete d.currentApp; delete d.showMaskManager; delete d.showStickerManager; delete d.maskModal.show; delete d.addContactModal.show; delete d.chatWizard.show; delete d.chatContextMenu.show; delete d.statusModal.show; delete d.statusHistoryModal.show; delete d.forwardModal.show; delete d.folderSelectModal.show; delete d.modelSelectModal.show; delete d.worldBinderModal.show; delete d.viewFileModal.show; delete d.worldModal.show; delete d.favoritesModal.show; delete d.voiceInputModal.show; delete d.redPacketModal.show; delete d.transferModal.show; delete d.qinmiSelectModal.show; delete d.paymentSelectModal.show; delete d.showPublishMoment; delete d.avatarSettingModal.show; delete d.groupSelectModal.show; delete d.mentionModal.show; delete d.visibilityModal.show; delete d.visibilityTargetModal.show; delete d.momentGenerateModal.show; const b=new Blob([JSON.stringify(d)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='backup.json'; a.click(); },
        triggerImport() { this.$refs.importInput.click(); },
        handleImport(e) { 
            const f=e.target.files[0]; if(!f)return; 
            const r=new FileReader(); 
            r.onload=(ev)=>{ 
                try { 
                    const d=JSON.parse(ev.target.result); 
                    Object.keys(d).forEach(k => {
                        if (this.$data.hasOwnProperty(k) && k !== 'isActivated' && k !== 'deviceId') {
                            this[k] = d[k];
                        }
                    });
                    this.saveData(); 
                    if(localStorage.getItem('onyunx_is_activated')) this.isActivated = true;
                    this.showToast('导入成功，即将刷新'); 
                    setTimeout(() => location.reload(), 1000); 
                } catch(e){ this.showToast('导入失败'); } 
            }; 
            r.readAsText(f); e.target.value = ''; 
        },
        
        triggerCardAvatarUpload() { if(this.$refs.cardAvatarInput) this.$refs.cardAvatarInput.click(); },
        async handleCardAvatarChange(e) { const f=e.target.files[0]; if(!f)return; try { this.cardProfile.avatar = await compressImage(f); this.saveData(); } catch(e){} },
        editCardProfile(f) { let m = { 'name': '卡片名字', 'id': '卡片ID', 'bio': '卡片签名', 'status': '卡片状态' }; this.showInput(m[f], this.cardProfile[f], "请输入...", (v) => { if(v){ this.cardProfile[f]=v; this.saveData(); } }); },
        triggerHomeAvatarUpload() { if(this.$refs.homeAvatarInput) this.$refs.homeAvatarInput.click(); },
        async handleHomeAvatarChange(e) { const f=e.target.files[0]; if(!f)return; try { this.homeProfile.avatar = await compressImage(f); this.saveData(); } catch(e){} },
        editHomeProfile(f) { let m = { 'name': '主页名字', 'id': '主页ID', 'bio': '主页签名', 'location': '主页定位' }; this.showInput(m[f], this.homeProfile[f], "请输入...", (v) => { if(v){ this.homeProfile[f]=v; this.saveData(); } }); },
        editHomeConfig(k, t) { this.showInput(t, this.homeConfig[k], "", (v) => { if(v){ this.homeConfig[k]=v; this.saveData(); } }); },
        editCustomWidget(i, f) { let t = f==='bubble'?'气泡文字':'下方文字'; this.showInput(t, this.customWidgets[i][f], "", (v) => { if(v){ this.customWidgets[i][f]=v; this.saveData(); } }); },
        triggerWidgetImageUpload(i) { this.editingWidgetId=i; if(this.$refs.widgetImageInput)this.$refs.widgetImageInput.click(); },
        async handleWidgetImageChange(e) { const f=e.target.files[0]; if(!f)return; try { this.customWidgets[this.editingWidgetId].image = await compressImage(f); this.saveData(); } catch(e){} },
        saveData() { try { localStorage.setItem('onyunx_hybrid_v40', JSON.stringify(this.$data)); } catch(e){} },
        loadData() { 
            const s=localStorage.getItem('onyunx_hybrid_v40'); 
            if(s) { try { const d=JSON.parse(s); Object.assign(this.$data, d); } catch(e){} }
            if (localStorage.getItem('onyunx_is_activated') === 'true') { this.isActivated = true; }
        },
        showToast(m) { this.toast.message=m; this.toast.show=true; setTimeout(()=>{this.toast.show=false},2000); },
        showInput(t,v,p,cb, inputType = 'text') { 
            this.inputModal = {
                show: true,
                title: t,
                value: v,
                placeholder: p,
                callback: cb,
                desc: '',
                inputType: inputType
            }; 
        },
        showConfirm(m, cb) { this.confirmModal={show:true, message:m, callback:cb}; },
        handleInputConfirm() { if(this.inputModal.callback)this.inputModal.callback(this.inputModal.value); this.inputModal.show=false; },
        handleConfirm() { if(this.confirmModal.callback)this.confirmModal.callback(); this.confirmModal.show=false; },
        updateTime() { const now=new Date(); this.statusBar.time=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; const m=now.getMonth()+1; const d=now.getDate(); const ds=['星期日','星期一','星期二','星期三','星期四','星期五','星期六']; this.displayDate={dateString:`${m}月${d}日`,dayString:ds[now.getDay()]}; },
        async initBattery() { try{const b=await navigator.getBattery();this.statusBar.batteryLevel=Math.round(b.level*100);this.statusBar.isCharging=b.charging;}catch(e){} },
        savePreset() { if (!this.apiConfig.baseUrl) return this.showToast('配置为空'); this.showInput("预设名称", "", "例如: DeepSeek", (name) => { if (name) { this.apiPresets.push({ name, baseUrl: this.apiConfig.baseUrl, apiKey: this.apiConfig.apiKey, selectedModel: this.apiConfig.selectedModel }); this.saveData(); this.showToast('预设已保存'); } }); },
        applyPreset(p) { this.apiConfig.baseUrl = p.baseUrl; this.apiConfig.apiKey = p.apiKey; this.apiConfig.selectedModel = p.selectedModel; this.showToast(`已应用: ${p.name}`); },
        deletePreset(i) { this.showConfirm("确定删除该预设吗？", () => { this.apiPresets.splice(i, 1); this.saveData(); this.showToast('已删除'); }); },
        saveSettings() { this.saveData(); this.showToast('配置已保存'); this.navigateSettings('back'); },
        
        toggleSelectMessage(msg) { const idx = this.selectedMessageIds.indexOf(msg); if (idx > -1) this.selectedMessageIds.splice(idx, 1); else this.selectedMessageIds.push(msg); },
        deleteSelectedMessages() { const session = this.wechatState.activeSession; session.messages = session.messages.filter(m => !this.selectedMessageIds.includes(m)); this.selectedMessageIds = []; this.isMultiSelectMode = false; this.saveData(); },
        openForwardModal() { if(this.selectedMessageIds.length === 0) return this.showToast('未选择消息'); this.forwardModal.mode = 'forward'; this.forwardModal.show = true; },
        doForward(targetFriendId) { 
            let targetSession = this.wechatState.sessions.find(s => s.targetId === targetFriendId); 
            if (!targetSession) { 
                const friend = this.wechatState.friendList.find(f => f.id === targetFriendId); 
                if(!friend) return; 
                targetSession = { id: Date.now().toString(), targetId: friend.id, name: friend.remark || friend.name, avatar: friend.avatar, maskId: this.wechatState.activeSession.maskId, messages: [], lastMessage: '', time: Date.now(), wallpaper: '', groupId: null, customAvatarSelf: '', customAvatarTarget: '' }; 
                this.wechatState.sessions.unshift(targetSession); 
            } 
            const summary = this.selectedMessageIds.map(m => `[${m.isSelf?'我':this.wechatState.activeSession.name}] ${m.content.substring(0,20)}${m.content.length>20?'...':''}`).slice(0, 4).join('\n') + (this.selectedMessageIds.length > 4 ? `\n...等${this.selectedMessageIds.length}条消息` : '');
            
            const forwardMsg = { 
                type: 'forward', 
                content: summary, 
                isSelf: true, 
                time: Date.now(), 
                avatar: this.getMaskById(targetSession.maskId).avatar 
            }; 
            
            targetSession.messages.push(forwardMsg); 
            targetSession.lastMessage = '[聊天记录]'; 
            this.forwardModal.show = false; 
            this.isMultiSelectMode = false; 
            this.selectedMessageIds = []; 
            this.saveData(); 
            this.showToast('已转发'); 
        },
        
        toggleStatusMultiSelect() { this.isStatusMultiSelectMode = !this.isStatusMultiSelectMode; this.selectedStatusIndices = []; },
        toggleSelectStatus(idx) { const i = this.selectedStatusIndices.indexOf(idx); if (i > -1) this.selectedStatusIndices.splice(i, 1); else this.selectedStatusIndices.push(idx); },
        deleteSelectedStatus() {
             const session = this.wechatState.activeSession;
             this.selectedStatusIndices.sort((a,b)=>b-a).forEach(idx => {
                 session.statusHistory.splice(idx, 1);
             });
             this.selectedStatusIndices = [];
             this.isStatusMultiSelectMode = false;
             this.saveData();
        },
        
        openFavorites() { this.favoritesModal.show = true; },
        addToFavorites(content, type, source) {
            this.favorites.unshift({
                content: content,
                type: type,
                source: source,
                time: Date.now()
            });
            this.saveData();
        },
        deleteFavorite(idx) {
            this.favorites.splice(idx, 1);
            this.saveData();
        },
        favoriteSelectedStatus() {
            const session = this.wechatState.activeSession;
            this.selectedStatusIndices.forEach(idx => {
                const item = session.statusHistory[idx];
                const content = `[心声] ${item.thought}\n[随笔] ${item.note}\n[动作] ${item.action}`;
                this.addToFavorites(content, 'status', session.name);
            });
            this.showToast(`已收藏 ${this.selectedStatusIndices.length} 条`);
            this.selectedStatusIndices = [];
            this.isStatusMultiSelectMode = false;
        },
        favoriteSelectedMessages() {
             if(this.selectedMessageIds.length === 0) return this.showToast('未选择消息');
             const session = this.wechatState.activeSession;
             this.selectedMessageIds.forEach(msg => {
                 this.addToFavorites(msg.content, 'message', session.name);
             });
             this.showToast(`已收藏 ${this.selectedMessageIds.length} 条`);
             this.selectedMessageIds = [];
             this.isMultiSelectMode = false;
        },
        
        navigateToChatBgSettings() { this.wechatState.activeNav = 'chat-bg-settings'; },
        triggerChatBgUpload() { this.$refs.chatBgInput.click(); },
        async handleChatBgChange(e) {
             const f = e.target.files[0]; if(!f) return;
             try {
                 this.wechatState.activeSession.wallpaper = await compressImage(f, 1080);
                 this.saveData();
                 this.showToast('背景已设置');
             } catch(e) {}
        },
        resetChatBg() {
            this.wechatState.activeSession.wallpaper = '';
            this.saveData();
            this.showToast('已恢复默认背景');
        },

        openVoiceInput() { this.voiceInputModal.show = true; this.voiceInputModal.content = ''; },
        sendVoiceMessage() {
            if(!this.voiceInputModal.content.trim()) return this.showToast('内容为空');
            const txt = this.voiceInputModal.content.trim();
            const duration = Math.max(1, Math.min(60, Math.ceil(txt.length / 3))); // Estimate duration
            
            const msg = {
                type: 'voice',
                content: txt,
                duration: duration,
                isExpanded: false,
                isSelf: true,
                time: Date.now(),
                avatar: this.getMaskById(this.wechatState.activeSession.maskId).avatar
            };
            this.wechatState.activeSession.messages.push(msg);
            this.wechatState.activeSession.lastMessage = '[语音]';
            this.voiceInputModal.show = false;
            this.scrollToBottom();
            this.saveData();
        },
        toggleVoiceText(msg) { msg.isExpanded = !msg.isExpanded; },

        openStickerManager() { this.showStickerManager = true; this.isStickerMultiSelect = false; },
        triggerStickerUpload() { this.$refs.stickerUploadInput.click(); },
        async handleStickerUpload(e) {const files = e.target.files; if(!files.length) return;
            for(let i=0; i<files.length; i++) {
                try {
                    const url = await compressImage(files[i], 300);
                    this.stickers.push({
                        id: Date.now().toString() + Math.random(),
                        url: url,
                        desc: '未命名',
                        groupId: this.activeStickerGroupId === 'all' ? 'all' : this.activeStickerGroupId
                    });
                } catch(err) {}
            }
            this.saveData();
            e.target.value = '';
        },
        openUrlImportModal() {
            this.showInput('导入网络表情', '', '格式: URL 描述 (每行一个)', (val) => {
                if(!val) return;
                const lines = val.split('\n');
                lines.forEach(line => {
                    const parts = line.trim().split(/\s+(.+)/);
                    if(parts.length >= 1 && parts[0].startsWith('http')) {
                        this.stickers.push({
                            id: Date.now().toString() + Math.random(),
                            url: parts[0],
                            desc: parts[1] || '网络表情',
                            groupId: this.activeStickerGroupId === 'all' ? 'all' : this.activeStickerGroupId
                        });
                    }
                });
                this.saveData();
                this.showToast('导入完成');
            }, 'textarea'); 
        },
        toggleStickerMultiSelect() { 
            this.isStickerMultiSelect = !this.isStickerMultiSelect; 
            this.selectedStickerIds = []; 
        },
        handleStickerClick(sticker) {
            if(this.isStickerMultiSelect) {
                const idx = this.selectedStickerIds.indexOf(sticker.id);
                if(idx > -1) this.selectedStickerIds.splice(idx, 1);
                else this.selectedStickerIds.push(sticker.id);
            } else {
                this.showInput('修改描述', sticker.desc, '', (val) => {
                    if(val) { sticker.desc = val; this.saveData(); }
                });
            }
        },
        deleteSelectedStickers() {
            this.stickers = this.stickers.filter(s => !this.selectedStickerIds.includes(s.id));
            this.selectedStickerIds = [];
            this.isStickerMultiSelect = false;
            this.saveData();
        },
        addStickerGroup() {
            this.showInput('新建分组', '', '分组名称', (val) => {
                if(val) {
                    this.stickerGroups.push({ id: Date.now().toString(), name: val });
                    this.saveData();
                }
            });
        },
        handleGroupClick(group) {
            if(this.activeStickerGroupId === group.id && group.id !== 'all') {
                this.showInput('重命名分组', group.name, '', (val) => {
                    if(val) { group.name = val; this.saveData(); }
                });
            } else {
                this.activeStickerGroupId = group.id;
            }
        },
        getStickersForPanel() {
            if(this.activeStickerGroupId === 'all') return this.stickers;
            return this.stickers.filter(s => s.groupId === this.activeStickerGroupId);
        },
        sendSticker(sticker) {
            const msg = {
                type: 'image',
                content: sticker.url,
                isSelf: true,
                time: Date.now(),
                avatar: this.getMaskById(this.wechatState.activeSession.maskId).avatar
            };
            this.wechatState.activeSession.messages.push(msg);
            this.wechatState.activeSession.lastMessage = '[图片]';
            this.showStickerPanel = false;
            this.scrollToBottom();
            this.saveData();
        },
        
        triggerImageUpload() { this.imageUploadInput.click(); },
        async handleImageUploadForChat(e) {
            const f = e.target.files[0]; if(!f) return;
            try {
                const url = await compressImage(f, 600);
                const msg = {
                    type: 'image',
                    content: url,
                    isSelf: true,
                    time: Date.now(),
                    avatar: this.getMaskById(this.wechatState.activeSession.maskId).avatar
                };
                this.wechatState.activeSession.messages.push(msg);
                this.wechatState.activeSession.lastMessage = '[图片]';
                this.wechatState.showAttachMenu = false;
                this.scrollToBottom();
                this.saveData();
                this.triggerReceive();
            } catch(e) {}
            e.target.value = '';
        },

        openFakeImageInput() {
            this.showInput('拍摄 (文字拟图)', '', '例如: 一张风景照', (val) => {
                if(!val) return;
                const msg = {
                    type: 'fake_image',
                    content: val,
                    isRevealed: false,
                    isSelf: true,
                    time: Date.now(),
                    avatar: this.getMaskById(this.wechatState.activeSession.maskId).avatar
                };
                this.wechatState.activeSession.messages.push(msg);
                this.wechatState.activeSession.lastMessage = '[图片]';
                this.wechatState.showAttachMenu = false;
                this.scrollToBottom();
                this.saveData();
            });
        },

        openRedPacketModal() {
             this.redPacketModal = { show: true, amount: '', note: '' };
             this.wechatState.showAttachMenu = false;
        },
        sendRedPacket() {
             const amt = parseFloat(this.redPacketModal.amount);
             if(!amt || amt <= 0) return this.showToast('请输入金额');
             if(this.wallet.balance < amt) return this.showToast('余额不足');
             
             this.addToWallet('expense', amt, this.wechatState.activeSession.name, '发出红包');
             
             const msg = {
                 type: 'red_packet',
                 amount: this.redPacketModal.amount,
                 note: this.redPacketModal.note || '恭喜发财，大吉大利',
                 isSelf: true,
                 time: Date.now(),
                 avatar: this.getMaskById(this.wechatState.activeSession.maskId).avatar
             };
             this.wechatState.activeSession.messages.push(msg);
             this.wechatState.activeSession.lastMessage = '[微信红包]';
             this.redPacketModal.show = false;
             this.scrollToBottom();
             this.saveData();
        },
        
        handleChatBubbleClick(msg) {
            if(msg.type === 'red_packet') {
                if(!msg.isSelf) { 
                    if (!msg.isOpened) {
                         this.addToWallet('income', parseFloat(msg.amount), this.wechatState.activeSession.name, '红包收入');
                         msg.isOpened = true;
                         this.saveData();
                    }
                }
                this.currentRedPacketData = msg;
                this.wechatState.activeNav = 'red-packet-detail';
            } else if(msg.type === 'transfer') {
                if(!msg.isReceived && !msg.isSelf) {
                    msg.isReceived = true;
                    this.addToWallet('income', parseFloat(msg.amount), this.wechatState.activeSession.name, '转账收款');
                    this.saveData();
                    this.showToast(`已收款 ￥${msg.amount}`);
                } else if(msg.isSelf) {
                    this.showToast('等待对方收款');
                }
            } else if(msg.type === 'voice') {
                this.toggleVoiceText(msg);
            } else if(msg.type === 'fake_image') {
                msg.isRevealed = !msg.isRevealed;
            } else if(msg.type === 'moment') {
                this.wechatState.activeNav = 'moments';
            }
        },

        openTransferModal() {
             this.transferModal = { show: true, amount: '', note: '' };
             this.wechatState.showAttachMenu = false;
        },
        sendTransfer() {
             const amt = parseFloat(this.transferModal.amount);
             if(!amt || amt <= 0) return this.showToast('请输入金额');
             if(this.wallet.balance < amt) return this.showToast('余额不足');
             
             this.addToWallet('expense', amt, this.wechatState.activeSession.name, '转账支出');

             const msg = {
                 type: 'transfer',
                 amount: this.transferModal.amount,
                 note: this.transferModal.note,
                 isSelf: true,
                 time: Date.now(),
                 avatar: this.getMaskById(this.wechatState.activeSession.maskId).avatar
             };
             this.wechatState.activeSession.messages.push(msg);
             this.wechatState.activeSession.lastMessage = '[微信转账]';
             this.transferModal.show = false;
             this.scrollToBottom();
             this.saveData();
        },
        
        addToWallet(type, amount, source, desc) {
            if(type === 'income') this.wallet.balance = parseFloat(this.wallet.balance) + parseFloat(amount);
            else this.wallet.balance = parseFloat(this.wallet.balance) - parseFloat(amount);
            
            this.wallet.transactions.unshift({
                type, amount, source, desc, time: Date.now()
            });
            this.saveData();
        },
        formatMoney(num) { return parseFloat(num).toFixed(2); },
        triggerTopUp() {
            this.showInput("充值", "", "请输入充值金额", (val) => {
                const amt = parseFloat(val);
                if(amt > 0) {
                    this.addToWallet('income', amt, '系统', '充值');
                    this.showToast('充值成功');
                }
            }, 'number');
        },
        triggerWithdraw() {
            this.showInput("提现", "", "请输入提现金额", (val) => {
                const amt = parseFloat(val);
                if(amt > 0) {
                    if(this.wallet.balance >= amt) {
                        this.addToWallet('expense', amt, '银行卡', '提现');
                        this.showToast('提现成功');
                    } else {
                        this.showToast('余额不足');
                    }
                }
            }, 'number');
        },
        triggerPayment() {
             this.triggerWithdraw(); 
        },
        
        // Qinmi Logic
        openQinmiSelectModal() { this.qinmiSelectModal.show = true; },
        startQinmiProcess(type) {
            this.qinmiSelectModal.show = false;
            this.forwardModal.mode = 'qinmi';
            this.forwardModal.inviteType = type;
            this.forwardModal.show = true;
        },
        handleFriendSelect(friend) {
            if (this.forwardModal.mode === 'qinmi') {
                const inviteType = this.forwardModal.inviteType;
                const existing = this.wallet.intimatePays.find(p => p.targetId === friend.id && p.status === 'active');
                if (existing) return this.showToast('该好友已有生效的亲密付');

                if (inviteType === 'give') {
                    this.showInput(`为 ${friend.remark || friend.name} 开通亲密付`, '', '设置每月限额', (val) => {
                        const limit = parseFloat(val);
                        if (limit > 0) {
                            this.sendQinmiInviteMessage(friend, inviteType, limit);
                        }
                    }, 'number');
                } else {
                    this.sendQinmiInviteMessage(friend, inviteType, 0);
                }
                this.forwardModal.show = false;
            } else if (this.forwardModal.mode === 'moment') {
                let session = this.wechatState.sessions.find(s => s.targetId === friend.id);
                if (!session) {
                    const myMaskId = this.wechatState.activeSession?.maskId || (this.masks.length > 0 ? this.masks[0].id : null);
                    if(!myMaskId) { this.showToast('请先创建面具'); return; }
                    this.createSession(friend, this.getMaskById(myMaskId));
                    session = this.wechatState.sessions[0];
                }
                const msg = {
                    type: 'moment',
                    momentData: this.forwardingMoment,
                    content: '[朋友圈]',
                    isSelf: true,
                    time: Date.now(),
                    avatar: this.getChatAvatar({isSelf: true})
                };
                session.messages.push(msg);
                session.lastMessage = '[朋友圈]';
                this.saveData();
                this.forwardModal.show = false;
                this.showToast('已转发');
                this.activeMomentMenuId = null;
            } else {
                this.doForward(friend.id);
            }
        },
        sendQinmiInviteMessage(friend, inviteType, limit) {
             let session = this.wechatState.sessions.find(s => s.targetId === friend.id);
             if (!session) {
                 const myMaskId = this.wechatState.activeSession?.maskId || (this.masks.length > 0 ? this.masks[0].id : null);
                 if(!myMaskId) { this.showToast('请先创建面具'); return; }
                 this.createSession(friend, this.getMaskById(myMaskId));
                 session = this.wechatState.sessions[0];
             }
             
             this.wallet.intimatePays.push({
                 id: Date.now().toString(),
                 targetId: friend.id,
                 type: inviteType === 'give' ? 'outcome' : 'income',
                 limit: limit,
                 balanceUsed: 0,
                 status: 'pending',
                 history: []
             });

             const msg = {
                 type: 'qinmi_invite',
                 inviteType: inviteType,
                 isSelf: true,
                 time: Date.now(),
                 avatar: this.getMaskById(session.maskId).avatar
             };
             session.messages.push(msg);
             session.lastMessage = '[亲密付邀请]';
             this.saveData();
             this.openApp('wechat');
             this.enterChatRoom(session);
             this.triggerReceive();
        },
        handleAiQinmiResponse(session, decision) {
             const pending = this.wallet.intimatePays.find(p => p.targetId === session.targetId && p.status === 'pending');
             if (!pending) return;

             const accept = decision ? (decision.toLowerCase().includes('accept') || decision.toLowerCase().includes('ok')) : (Math.random() < 0.8);
             
             if (accept) {
                 pending.status = 'active';
                 if (pending.type === 'income') {
                     pending.limit = (Math.floor(Math.random() * 50) + 10) * 100; 
                 }
                 const replyMsg = {
                     content: pending.type === 'income' ? `没问题，亲密付已开通，每月限额 ¥${pending.limit}。` : `谢谢你的礼物，我会珍惜使用的。`,
                     isSelf: false,
                     time: Date.now(),
                     avatar: session.avatar
                 };
                 session.messages.push(replyMsg);
                 this.saveData();
             } else {
                 pending.status = 'rejected';
                 const replyMsg = {
                     content: `抱歉，我现在不需要这个。`,
                     isSelf: false,
                     time: Date.now(),
                     avatar: session.avatar
                 };
                 session.messages.push(replyMsg);
                 this.saveData();
             }
        },
        openQinmiManage() { this.wechatState.activeNav = 'qinmi-manage'; },
        openQinmiSpecificDetail(qp) {
            this.activeQinmiDetail = qp;
            this.wechatState.activeNav = 'qinmi-specific-detail';
        },
        getAvailableQinmiSources() {
            return this.wallet.intimatePays.filter(p => p.type === 'income' && p.status === 'active' && (p.limit - p.balanceUsed) > 0);
        },
        confirmPayment(method, source) {
            const amount = this.paymentSelectModal.amount;
            if (method === 'balance') {
                if (this.wallet.balance < amount) return this.showToast('余额不足');
                this.addToWallet('expense', amount, '商户消费', '模拟消费');
                this.showToast('支付成功');
            } else if (method === 'qinmi') {
                if ((source.limit - source.balanceUsed) < amount) return this.showToast('额度不足');
                source.balanceUsed = (parseFloat(source.balanceUsed) + parseFloat(amount)).toFixed(2);
                source.history.unshift({ item: '模拟消费', amount: amount, time: Date.now() });
                this.showToast(`亲密付支付成功 (-${amount})`);
            }
            this.paymentSelectModal.show = false;
            this.saveData();
        },
        handleAiIntimatePayConsumption(session) {
             if(!this.wallet.intimatePays) return;
             const pay = this.wallet.intimatePays.find(p => p.targetId === session.targetId && p.type === 'outcome' && p.status === 'active');
             if(pay) {
                 if(Math.random() < 0.3) { 
                     const items = ['奶茶', '游戏皮肤', '电影票', '打车', '网购零食', '超市便利店'];
                     const item = items[Math.floor(Math.random()*items.length)];
                     const cost = (Math.random() * 50 + 10).toFixed(2);
                     
                     if (parseFloat(pay.balanceUsed) + parseFloat(cost) <= parseFloat(pay.limit)) {
                         if (this.wallet.balance >= cost) {
                             pay.balanceUsed = (parseFloat(pay.balanceUsed) + parseFloat(cost)).toFixed(2);
                             pay.history.unshift({ item, amount: cost, time: Date.now() });
                             this.addToWallet('expense', cost, session.name, `亲密付-${item}`);
                         }
                     }
                 }
             }
        },

        // --- Moments Location, Mentions & Visibility ---
        openPublishMoment() { 
            this.showPublishMoment = true; 
            this.newMoment = { content: '', images: [], location: '', mentions: [], visibility: 'public', visibilityGroups: [], visibilityFriends: [] }; 
        },
        openLocationInput() {
            this.showInput('所在位置', this.newMoment.location, '输入你的地理位置', (val) => {
                this.newMoment.location = val;
            });
        },
        openMentionModal() {
            this.mentionModal.selectedIds = [...this.newMoment.mentions];
            this.mentionModal.show = true;
        },
        toggleMention(id) {
            const idx = this.mentionModal.selectedIds.indexOf(id);
            if (idx > -1) this.mentionModal.selectedIds.splice(idx, 1);
            else this.mentionModal.selectedIds.push(id);
        },
        saveMentions() {
            this.newMoment.mentions = [...this.mentionModal.selectedIds];
            this.mentionModal.show = false;
        },
        getMentionNames() {
            if (!this.newMoment.mentions || this.newMoment.mentions.length === 0) return '';
            const names = this.newMoment.mentions.map(id => {
                const f = this.wechatState.friendList.find(x => x.id === id);
                return f ? (f.remark || f.name) : '';
            }).filter(Boolean);
            return names.join(', ');
        },
        getMentionNamesForMoment(moment) {
            if (!moment.mentions) return '';
            return moment.mentions.map(id => {
                const f = this.wechatState.friendList.find(x => x.id === id);
                return f ? (f.remark || f.name) : '';
            }).filter(Boolean).join(', @');
        },
        selectVisibility(type) {
            if (type === 'public' || type === 'private') {
                this.newMoment.visibility = type;
                this.newMoment.visibilityGroups = [];
                this.newMoment.visibilityFriends = [];
                this.visibilityModal.show = false;
            } else {
                this.visibilityTargetModal.mode = type;
                this.visibilityTargetModal.selectedGroupIds = [...this.newMoment.visibilityGroups];
                this.visibilityTargetModal.selectedFriendIds = [...this.newMoment.visibilityFriends];
                this.visibilityModal.show = false;
                this.visibilityTargetModal.show = true;
            }
        },
        toggleVisibilityGroup(id) {
            const idx = this.visibilityTargetModal.selectedGroupIds.indexOf(id);
            if (idx > -1) this.visibilityTargetModal.selectedGroupIds.splice(idx, 1);
            else this.visibilityTargetModal.selectedGroupIds.push(id);
        },
        toggleVisibilityFriend(id) {
            const idx = this.visibilityTargetModal.selectedFriendIds.indexOf(id);
            if (idx > -1) this.visibilityTargetModal.selectedFriendIds.splice(idx, 1);
            else this.visibilityTargetModal.selectedFriendIds.push(id);
        },
        saveVisibilityTargets() {
            this.newMoment.visibility = this.visibilityTargetModal.mode;
            this.newMoment.visibilityGroups = [...this.visibilityTargetModal.selectedGroupIds];
            this.newMoment.visibilityFriends = [...this.visibilityTargetModal.selectedFriendIds];
            this.visibilityTargetModal.show = false;
        },
        getVisibilityName() {
            if (this.newMoment.visibility === 'public') return '公开';
            if (this.newMoment.visibility === 'private') return '私密';
            let count = (this.newMoment.visibilityGroups?.length || 0) + (this.newMoment.visibilityFriends?.length || 0);
            if (this.newMoment.visibility === 'share_to') return `部分可见(${count})`;
            if (this.newMoment.visibility === 'dont_share_to') return `不给谁看(${count})`;
            return '公开';
        },
        canAIFriendSeeMoment(moment, aiFriend) {
            if (moment.visibility === 'private') return false;
            if (moment.visibility === 'public' || !moment.visibility) return true;
            
            let explicitIds = [...(moment.visibilityFriends || [])];
            if (moment.visibilityGroups && moment.visibilityGroups.length > 0) {
                 moment.visibilityGroups.forEach(gId => {
                     const gSessions = this.wechatState.sessions.filter(s => s.groupId === gId);
                     gSessions.forEach(s => {
                         if (!explicitIds.includes(s.targetId)) explicitIds.push(s.targetId);
                     });
                 });
            }

            if (moment.visibility === 'share_to') {
                return explicitIds.includes(aiFriend.id);
            }
            if (moment.visibility === 'dont_share_to') {
                return !explicitIds.includes(aiFriend.id);
            }
            return true;
        },

        // --- Moments AI Generate Selection Modal ---
        openMomentGenerateModal() {
            this.momentGenerateModal.selectedIds = [];
            this.momentGenerateModal.show = true;
        },
        toggleGenerateMomentFriend(id) {
            const idx = this.momentGenerateModal.selectedIds.indexOf(id);
            if (idx > -1) {
                this.momentGenerateModal.selectedIds.splice(idx, 1);
            } else {
                if (this.momentGenerateModal.selectedIds.length >= 5) {
                    return this.showToast('最多只能选择5个好友');
                }
                this.momentGenerateModal.selectedIds.push(id);
            }
        },
        confirmGenerateMoments() {
            if (this.momentGenerateModal.selectedIds.length === 0) return this.showToast('请至少选择一个好友');
            const ids = [...this.momentGenerateModal.selectedIds];
            this.momentGenerateModal.show = false;
            this.generateSelectedAIMoments(ids);
        },

        async handleMomentImgUpload(e) {
            const files = e.target.files; if(!files.length) return;
            for(let i=0; i<files.length; i++) {
                try {
                    const url = await compressImage(files[i], 600);
                    if(this.newMoment.images.length < 9) this.newMoment.images.push(url);
                } catch(e){}
            }
            e.target.value = '';
        },
        publishMoment() {
            if(!this.newMoment.content && this.newMoment.images.length === 0) return;
            const moment = {
                id: Date.now().toString(),
                name: this.homeProfile.name,
                avatar: this.homeProfile.avatar,
                content: this.newMoment.content,
                images: this.newMoment.images,
                location: this.newMoment.location,
                mentions: this.newMoment.mentions,
                visibility: this.newMoment.visibility,
                visibilityGroups: this.newMoment.visibilityGroups,
                visibilityFriends: this.newMoment.visibilityFriends,
                time: Date.now(),
                likes: [],
                comments: [],
                isLiked: false
            };
            this.moments.unshift(moment);
            this.showPublishMoment = false;
            this.saveData();
            this.showToast('发表成功');
            
            if (moment.mentions && moment.mentions.length > 0) {
                moment.mentions.forEach(id => {
                    const friend = this.wechatState.friendList.find(f => f.id === id);
                    if (friend && this.canAIFriendSeeMoment(moment, friend)) {
                        setTimeout(() => { this.generateAIReplyToComment(moment, friend, "提到你了", true); }, 3000 + Math.random() * 5000);
                    }
                });
            }
        },
        toggleLike(moment) {
            moment.isLiked = !moment.isLiked;
            if(moment.isLiked) moment.likes.push(this.homeProfile.name);
            else {
                const idx = moment.likes.indexOf(this.homeProfile.name);
                if(idx > -1) moment.likes.splice(idx, 1);
            }
            this.saveData();
        },
        triggerMomentsCoverUpload() { this.$refs.momentsCoverInput.click(); },
        async handleMomentsCoverUpload(e) {
            const f = e.target.files[0]; if(!f) return;
            try { this.momentsBackground = await compressImage(f, 1080); this.saveData(); } catch(e){}
        },
        
        toggleMomentMenu(moment) {
            this.activeMomentMenuId = this.activeMomentMenuId === moment.id ? null : moment.id;
        },
        handleMomentAction(action, moment) {
            this.activeMomentMenuId = null; 
            if (action === 'like') {
                this.toggleLike(moment);
            } else if (action === 'comment') {
                this.activeCommentMomentId = moment.id;
                this.replyTarget = null; 
                this.$nextTick(() => { if(this.$refs.commentInputRef) this.$refs.commentInputRef.focus(); });
            } else if (action === 'delete') {
                this.showConfirm("确定删除该朋友圈吗？", () => {
                    this.moments = this.moments.filter(m => m.id !== moment.id);
                    this.saveData();
                    this.showToast('已删除');
                });
            } else if (action === 'forward') {
                this.forwardingMoment = moment;
                this.forwardModal.mode = 'moment';
                this.forwardModal.show = true;
            } else if (action === 'generate') {
                this.generateAICommentForMoment(moment);
            }
        },
        setReplyTarget(moment, comment) {
            this.activeCommentMomentId = moment.id;
            this.replyTarget = comment;
            this.$nextTick(() => { if(this.$refs.commentInputRef) this.$refs.commentInputRef.focus(); });
        },
        submitComment(moment) {
            if (!this.commentInput.trim()) return;
            const newComment = {
                user: this.homeProfile.name,
                text: this.commentInput,
                replyTo: this.replyTarget ? this.replyTarget.user : null
            };
            moment.comments.push(newComment);
            
            if (this.replyTarget) {
                 const aiFriend = this.wechatState.friendList.find(f => (f.remark || f.name) === this.replyTarget.user);
                 if (aiFriend && this.canAIFriendSeeMoment(moment, aiFriend)) {
                     this.generateAIReplyToComment(moment, aiFriend, this.commentInput);
                 }
            } else {
                // 如果是回复动态，查找作者是否为 AI
                const aiAuthor = this.wechatState.friendList.find(f => (f.remark || f.name) === moment.name);
                if (aiAuthor) {
                    // 确保触发回复逻辑
                    this.generateAIReplyToComment(moment, aiAuthor, this.commentInput, true); 
                }
            }
            
            this.commentInput = '';
            this.activeCommentMomentId = null;
            this.replyTarget = null;
            this.saveData();
        },

        // --- AI Moments Logic (Interaction) ---
        async generateRandomAIMoment() {
            this.openMomentGenerateModal();
        },

        async generateSelectedAIMoments(friendIds) {
            if (!this.apiConfig.apiKey) return this.showToast('请先配置 API Key');
            this.showToast(`正在生成动态，请稍候...`);
            
            let successCount = 0;
            let failCount = 0;

            for (let id of friendIds) {
                const friend = this.wechatState.friendList.find(f => f.id === id);
                if (!friend) continue;

                let recentChatContext = "无近期聊天记录。";
                const session = this.wechatState.sessions.find(s => s.targetId === id);
                if (session && session.messages && session.messages.length > 0) {
                     const recentMsgs = session.messages.slice(-5).map(m => `[${m.isSelf ? '我' : friend.name}]: ${m.content}`).join('\n');
                     recentChatContext = `你们最近的聊天内容:\n${recentMsgs}`;
                }

                let content = "";
                try {
                    let url = this.apiConfig.baseUrl.trim().replace(/\/+$/, '');
                    if (!url.endsWith('/v1')) url += '/v1';
                    const res = await fetch(`${url}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiConfig.apiKey.trim()}` },
                        body: JSON.stringify({ 
                            model: this.apiConfig.selectedModel, 
                            messages: [
                                { role: 'system', content: `你现在的身份是: ${friend.name}。这是你的背景设定(人设): ${friend.bio || '无'}。这是你最近与用户的聊天记录(可作为参考): ${recentChatContext}。\n规则：1. 请根据你的性格和背景，发布一条微信朋友圈动态。2. 必须以纯文本输出，不要带话题标签(hashtags)或引号。3. 语气自然贴合人设，字数10-50字。4. 严禁使用“今天天气真不错”、“今天很开心”之类的敷衍废话！必须结合你的身份背景来写！` },
                                { role: 'user', content: '请直接输出你现在要发的朋友圈文案内容。' }
                            ]
                        })
                    });
                    
                    if(!res.ok) {
                        console.error(`API Error: ${res.status}`);
                        throw new Error(`HTTP ${res.status}`);
                    }
                    
                    const data = await res.json();
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('API 返回数据格式错误');
                    }
                    
                    content = data.choices[0].message.content.trim();
                    successCount++;
                    
                    const moment = {
                        id: Date.now().toString() + Math.random(),
                        name: friend.remark || friend.name,
                        avatar: friend.avatar,
                        content: content,
                        images: [], 
                        location: '',
                        mentions: [],
                        visibility: 'public',
                        time: Date.now(),
                        likes: [],
                        comments: [],
                        isLiked: false
                    };
                    this.moments.unshift(moment);
                    this.saveData();

                } catch(e) {
                    console.error(`[生成朋友圈失败] ${friend.name}:`, e);
                    failCount++;
                }
            }
            
            if (failCount > 0) {
                this.showToast(`完成：成功 ${successCount} 个，失败 ${failCount} 个`);
            } else if (successCount > 0) {
                this.showToast('朋友圈生成完毕');
            }
        },

        async generateAIMomentFromChat(session, chatContext) {
            const friend = this.wechatState.friendList.find(f => f.id === session.targetId);
            if (!friend) return;
            
            let content = "";
            if (this.apiConfig.apiKey) {
                try {
                    let url = this.apiConfig.baseUrl.trim().replace(/\/+$/, '');
                    if (!url.endsWith('/v1')) url += '/v1';
                    const res = await fetch(`${url}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiConfig.apiKey.trim()}` },
                        body: JSON.stringify({ 
                            model: this.apiConfig.selectedModel, 
                            messages: [
                                { role: 'system', content: `你是 ${friend.name}。人设: ${friend.bio || '无'}。你刚刚在微信里跟别人聊了关于 "${chatContext}" 的内容。请根据你的人设发一条微信朋友圈动态。要求：纯文本，不要带hashtag，不能有引号，严禁使用“今天天气真不错”这种敷衍废话！` },
                                { role: 'user', content: '直接输出要发的朋友圈文案。' }
                            ]
                        })
                    });
                    if(!res.ok) throw new Error();
                    const data = await res.json();
                    content = data.choices[0].message.content.trim();
                    
                    const moment = {
                        id: Date.now().toString(),
                        name: friend.remark || friend.name,
                        avatar: friend.avatar,
                        content: content,
                        images: [], 
                        location: '',
                        mentions: [],
                        visibility: 'public',
                        time: Date.now(),
                        likes: [],
                        comments: [],
                        isLiked: false
                    };
                    this.moments.unshift(moment);
                    this.saveData();
                } catch(e) { console.error("Chat trigger moment failed", e); }
            }
        },

        async generateAICommentForMoment(moment) {
            if (this.wechatState.friendList.length === 0) return this.showToast('暂无好友');
            
            const eligibleFriends = this.wechatState.friendList.filter(f => this.canAIFriendSeeMoment(moment, f));
            
            if (eligibleFriends.length === 0) {
                return this.showToast('由于权限设置，没有 AI 好友可见此条动态');
            }

            const aiFriend = eligibleFriends[Math.floor(Math.random() * eligibleFriends.length)];
            this.showToast(`${aiFriend.name} 正在输入...`);

            let commentText = "";
            if (this.apiConfig.apiKey) {
                 try {
                    let url = this.apiConfig.baseUrl.trim().replace(/\/+$/, '');
                    if (!url.endsWith('/v1')) url += '/v1';
                    const res = await fetch(`${url}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiConfig.apiKey.trim()}` },
                        body: JSON.stringify({ 
                            model: this.apiConfig.selectedModel, 
                            messages: [
                                { role: 'system', content: `你是 ${aiFriend.name}, 这是你的人设: ${aiFriend.bio || '无'}。你在刷朋友圈时看到了这条动态: "${moment.content}"。请根据你的人设，写一句非常简短的评论(最多15个字)。严禁说“哈哈”、“赞”、“不错”等敷衍词汇，必须符合人物性格！` },
                                { role: 'user', content: '直接输出评论内容，不要加引号。' }
                            ]
                        })
                    });
                    if(!res.ok) throw new Error();
                    const data = await res.json();
                    commentText = data.choices[0].message.content.trim();
                    
                    moment.comments.push({
                        user: aiFriend.remark || aiFriend.name,
                        text: commentText
                    });
                    this.saveData();
                } catch(e) { return this.showToast('生成评论失败，请检查API'); }
            } else { return this.showToast('请先配置 API Key'); }
        },

        async generateAIReplyToComment(moment, aiFriend, userComment, isAuthorReply = false) {
            if (!this.canAIFriendSeeMoment(moment, aiFriend)) return;

            // 稍微减少延迟以便更快看到效果
            setTimeout(async () => {
                let replyText = "";
                if (this.apiConfig.apiKey) {
                     try {
                        let url = this.apiConfig.baseUrl.trim().replace(/\/+$/, '');
                        if (!url.endsWith('/v1')) url += '/v1';
                        
                        let context = isAuthorReply 
                            ? `这是你发的朋友圈: "${moment.content}"。别人评论了你: "${userComment}"。`
                            : `在朋友的朋友圈下，别人回复了你的评论: "${userComment}"。`;

                        const res = await fetch(`${url}/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiConfig.apiKey.trim()}` },
                            body: JSON.stringify({ 
                                model: this.apiConfig.selectedModel, 
                                messages: [
                                    { role: 'system', content: `你是 ${aiFriend.name}。这是你的人设: ${aiFriend.bio || '无'}。${context} 请根据你的人设，用符合你性格的口吻简短回复（10字以内）。绝对不要只回“哈哈”、“嗯”！` },
                                    { role: 'user', content: '直接输出回复内容，不要加引号。' }
                                ]
                            })
                        });
                        if(!res.ok) throw new Error();
                        const data = await res.json();
                        replyText = data.choices[0].message.content.trim();
                        
                        moment.comments.push({
                            user: aiFriend.remark || aiFriend.name,
                            text: replyText,
                            replyTo: this.homeProfile.name 
                        });
                        this.saveData();
                        this.showToast(`${aiFriend.name} 回复了你`); // 增加提示
                    } catch(e) { console.error("Reply to comment failed", e); }
                }
            }, 3000 + Math.random() * 2000);
        },

        // Chat Avatar Override Logic
        openAvatarSetting() {
             const session = this.wechatState.activeSession;
             if(!session) return;
             this.avatarSettingModal = {
                 show: true,
                 selfUrl: session.customAvatarSelf || '',
                 targetUrl: session.customAvatarTarget || ''
             };
        },
        triggerAvatarUpload(type) {
            this.avatarSettingModal.uploadType = type;
            this.$refs.avatarSettingInput.click();
        },
        async handleAvatarUpload(e) {
            const f = e.target.files[0]; if(!f) return;
            try {
                const url = await compressImage(f, 300);
                if(this.avatarSettingModal.uploadType === 'self') {
                    this.avatarSettingModal.selfUrl = url;
                } else {
                    this.avatarSettingModal.targetUrl = url;
                }
            } catch(e) {}
            e.target.value = '';
        },
        saveAvatarSetting() {
            const session = this.wechatState.activeSession;
            if(session) {
                session.customAvatarSelf = this.avatarSettingModal.selfUrl;
                session.customAvatarTarget = this.avatarSettingModal.targetUrl;
                this.saveData();
                this.showToast('头像设置已保存');
                this.avatarSettingModal.show = false;
            }
        },
        // Helper to get correct avatar based on override
        getChatAvatar(ctx) {
            let session = this.wechatState.activeSession;
            
            if (ctx.targetId && (!session || session.targetId !== ctx.targetId)) {
                session = this.wechatState.sessions.find(s => s.targetId === ctx.targetId) || session;
            }

            if (!session) return ctx.avatar || '';

            if (ctx.isSelf) {
                return session.customAvatarSelf || this.getMaskById(session.maskId).avatar;
            } else {
                return session.customAvatarTarget || session.avatar;
            }
        },

        getFriendAvatar(tid) {
             const f = this.wechatState.friendList.find(x => x.id === tid);
             return f ? f.avatar : '';
        },
        getFriendName(tid) {
            const f = this.wechatState.friendList.find(x=>x.id===tid);
            return f ? (f.remark||f.name) : '未知好友';
        }
    }
}).mount('#app');
</script>
</body>
</html>
