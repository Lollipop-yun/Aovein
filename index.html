
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aovein OS - Ultimate v6</title>
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* å…¨å±€é…ç½® */
        body { 
            background-color: #000; 
            color: #000; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            overflow: hidden; 
            margin: 0; padding: 0;
        }

        [v-cloak] { display: none !important; }

        /* å¼ºåˆ¶å­—ä½“ç»§æ‰¿ï¼Œè§£å†³éƒ¨åˆ†å¼¹çª—å­—ä½“ä¸ç”Ÿæ•ˆé—®é¢˜ */
        #app, #app * {
            font-family: inherit;
        }

        /* ==================== Aovein åŠ è½½é¡µ ==================== */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; z-index: 999999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        .loading-title { font-size: 40px; font-weight: 300; color: #000; letter-spacing: 4px; margin-bottom: 40px; opacity: 0; animation: fadeInTitle 1s ease-out forwards; }
        .progress-container { width: 200px; height: 2px; background-color: #f0f0f0; border-radius: 2px; overflow: hidden; opacity: 0; animation: fadeInBar 1s ease-out 0.5s forwards; }
        .progress-bar { width: 0%; height: 100%; background-color: #000; animation: progressFill 2.5s ease-in-out 0.8s forwards; }

        /* ==================== æ¿€æ´»ç•Œé¢ ==================== */
        #activation-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; z-index: 999990;
            display: flex; flex-direction: column; align-items: center; padding-top: 120px;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.6s;
        }
        .activation-header { text-align: center; margin-bottom: 40px; }
        .activation-logo { font-size: 24px; font-weight: 600; letter-spacing: 2px; margin-bottom: 8px; }
        .activation-sub { font-size: 14px; color: #888; }
        .device-id-box { background: #f9f9f9; padding: 15px 20px; border-radius: 12px; font-family: monospace; font-size: 16px; color: #333; letter-spacing: 1px; margin-bottom: 30px; border: 1px solid #eee; text-align: center; user-select: text !important; }
        .device-label { font-size: 10px; color: #aaa; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .code-input-group { width: 80%; max-width: 320px; margin-bottom: 20px; }
        .code-input { width: 100%; padding: 15px; text-align: center; font-size: 18px; border: 2px solid #eee; border-radius: 12px; outline: none; letter-spacing: 2px; text-transform: uppercase; font-family: monospace; transition: all 0.3s; background: white; color: black; }
        .code-input:focus { border-color: #000; }
        .code-input.error { border-color: #ff4d4f; animation: shake 0.4s; }
        .error-msg { color: #ff4d4f; font-size: 12px; margin-top: 8px; height: 16px; text-align: center; opacity: 0; transition: opacity 0.2s; }
        .error-msg.show { opacity: 1; }
        .activate-btn { background-color: #000; color: white; padding: 15px 60px; border-radius: 30px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .activate-btn:active { transform: scale(0.95); }
        .hidden-screen { opacity: 0; pointer-events: none; visibility: hidden; }

        /* ==================== åŠ¨ç”»ä¸é€šç”¨ ==================== */
        @keyframes fadeInTitle { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInBar { from { opacity: 0; } to { opacity: 1; } }
        @keyframes progressFill { 0% { width: 0%; } 100% { width: 100%; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes typing-bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-3px); } }
        .typing-dot { display: inline-block; animation: typing-bounce 1.4s infinite ease-in-out both; margin: 0 1px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        input, textarea, select { -webkit-user-select: text !important; user-select: text !important; pointer-events: auto !important; cursor: text !important; transform: translate3d(0,0,0); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scale-enter-active, .scale-leave-active { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .scale-enter-from, .scale-leave-to { transform: scale(0.9); opacity: 0; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .app-slide-enter-active, .app-slide-leave-active { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .app-slide-enter-from { transform: translateY(100%); }
        .app-slide-leave-to { transform: translateY(100%); }
        .page-slide-enter-active, .page-slide-leave-active { transition: transform 0.25s ease; position: absolute; width: 100%; top: 0; }
        .page-slide-enter-from { transform: translateX(100%); }
        .page-slide-leave-to { transform: translateX(-20%); opacity: 0; }
        
        .home-icon { filter: grayscale(100%); transition: all 0.2s; }
        .home-icon:active { filter: grayscale(0%); transform: scale(0.9); }
        .home-icon-custom img { filter: none !important; }
        .dock-container { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); border-radius: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .widget-bubble { background: white; border-radius: 12px; padding: 4px 8px; font-size: 10px; font-weight: bold; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; margin-bottom: 6px; white-space: normal; max-width: 70px; text-align: center; line-height: 1.2; word-break: break-all; }
        .widget-bubble::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid white; }

        /* å¾®ä¿¡ç›¸å…³ */
        .wechat-pill-tab { transition: all 0.2s ease; border-radius: 999px; padding: 6px 16px; font-size: 13px; font-weight: 500; }
        .wechat-pill-active { background-color: #000; color: #fff; }
        .wechat-pill-inactive { background-color: transparent; color: #333; }
        .wechat-bottom-nav { background: white; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 90%; height: 60px; margin-bottom: 20px; }
        .wechat-avatar-ring { border: 2px solid #ffb6c1; padding: 2px; }
        .vip-badge { background-color: #666; color: white; font-size: 9px; padding: 1px 4px; border-radius: 4px; font-weight: bold; letter-spacing: 0.5px; }
        .wechat-search-input::placeholder { text-align: center; color: #9ca3af; }
        .wechat-dropdown { position: absolute; top: 50px; right: 10px; width: 150px; background-color: #4c4c4c; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); z-index: 40000; padding: 4px 0; color: white; display: flex; flex-direction: column; overflow: visible; }
        .wechat-dropdown::before { content: ''; position: absolute; top: -6px; right: 12px; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 6px solid #4c4c4c; }
        .chat-func-menu { position: absolute; top: 50px; right: 10px; width: 140px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 9999; padding: 6px; color: #333; border: 1px solid #f0f0f0; }
        .chat-attach-menu { position: absolute; bottom: 60px; left: 10px; background: white; border-radius: 16px; padding: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid #f0f0f0; display: flex; gap: 16px; z-index: 50; }
        .chat-attach-menu::after { content: ''; position: absolute; bottom: -6px; left: 14px; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid white; }
        
        .chat-bubble { border-radius: 18px; padding: 8px 12px; font-size: 14px; max-width: 100%; line-height: 1.4; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.03); }
        .chat-bubble-ai { background-color: #ffffff; color: #333; border-top-left-radius: 4px; }
        .chat-bubble-user { background-color: #f2f2f2; color: #333; border-top-right-radius: 4px; }
        .chat-timestamp-small { font-size: 10px; color: #999; margin-top: 2px; }
        .quote-block { background-color: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; font-size: 12px; color: #666; border-left: 2px solid #ccc; }
        .chat-bubble-user .quote-block { background-color: rgba(0,0,0,0.05); border-left-color: #999; }
        
        /* è½¬å‘å¡ç‰‡æ ·å¼ */
        .forward-card {
            background: #f5f5f5; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 4px;
            font-size: 12px; color: #666; width: 180px;
        }
        .forward-title { font-size: 14px; color: black; font-weight: 500; margin-bottom: 4px; }

        .system-recall-tip { text-align: center; font-size: 12px; color: #9ca3af; margin: 8px 0; }
        .recall-link { color: #576b95; cursor: pointer; margin-left: 4px; }

        /* é•¿æŒ‰èœå• */
        .chat-context-menu {
            position: fixed; background: #4c4c4c; color: white; border-radius: 12px; padding: 0; 
            z-index: 99999; box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            display: flex; flex-wrap: wrap; width: 260px;
        }
        .chat-context-menu::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #4c4c4c;
        }
        .context-item {
            width: 25%; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; gap: 4px; cursor: pointer;
        }
        .context-item:active { background: rgba(255,255,255,0.1); border-radius: 8px; }

        /* é¡¶éƒ¨æ¶ˆæ¯å¼¹çª— */
        .top-notification-banner {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 380px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 16px; padding: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 100000;
            display: flex; align-items: center; gap: 12px;
            cursor: pointer;
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* å¼€å…³æŒ‰é’® */
        .switch-checkbox { display: none; }
        .switch-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; width: 50px; height: 30px; background: #d1d5db; border-radius: 100px; position: relative; transition: background-color .2s; }
        .switch-label .switch-button { content: ''; position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; border-radius: 45px; transition: 0.2s; background: #fff; box-shadow: 0 0 2px 0 rgba(10, 10, 10, 0.29); }
        .switch-checkbox:checked + .switch-label .switch-button { left: calc(100% - 2px); transform: translateX(-100%); }
        .switch-checkbox:checked + .switch-label { background-color: #34C759; }

        /* iOSé£æ ¼åˆ—è¡¨é€‰æ‹©å™¨ */
        .ios-list-modal { position: absolute; bottom: 0; left: 0; width: 100%; background: #f2f2f2; border-top-left-radius: 20px; border-top-right-radius: 20px; max-height: 70vh; overflow: hidden; display: flex; flex-direction: column; }
        .ios-list-header { padding: 15px; text-align: center; font-weight: bold; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; }
        .ios-list-content { overflow-y: auto; padding: 10px; background: #f2f2f2; }
        .ios-list-item { background: white; padding: 15px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
        .ios-list-item:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .ios-list-item:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }
        .ios-list-item:active { background: #eee; }

    </style>
</head>
<body>

<!-- Aovein å¯åŠ¨åŠ è½½é¡µ -->
<div id="loading-screen">
    <div class="loading-title">Aovein</div>
    <div class="progress-container"><div class="progress-bar"></div></div>
</div>

<!-- æ¿€æ´»ç•Œé¢ -->
<div id="activation-screen" class="hidden-screen">
    <div class="activation-header"><div class="activation-logo">Aovein OS</div><div class="activation-sub">è®¾å¤‡æ¿€æ´»</div></div>
    <div class="device-id-box"><span class="device-label">DEVICE ID</span><span id="device-id-display">...</span></div>
    <div class="code-input-group"><input type="text" id="activation-code" class="code-input" placeholder="XXX-XXXX-XXXX" maxlength="13"><div id="activation-error" class="error-msg">æ¿€æ´»ç é”™è¯¯</div></div>
    <div class="activate-btn" onclick="attemptActivate()">ç«‹å³æ¿€æ´»</div>
</div>

<div id="app" v-cloak class="max-w-md mx-auto h-screen bg-[#f3f4f6] flex flex-col relative overflow-hidden shadow-2xl border-x border-gray-200" style="display: none;" @click="closeAllMenus"
     :style="{ 'font-family': themeConfig.fontFamily || 'inherit', 'color': themeConfig.fontColor || '#000000', '--custom-font-size': themeConfig.fontSize + 'em' }">

    <!-- å…¨å±€å¼¹çª— -->
    <transition name="fade"><div v-if="toast.show" class="fixed inset-0 z-[60000] flex items-center justify-center pointer-events-none"><div class="bg-black/70 text-white px-5 py-3 rounded-xl shadow-lg backdrop-blur-sm text-sm font-medium">{{ toast.message }}</div></div></transition>
    <transition name="scale"><div v-if="inputModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[80%] max-w-xs rounded-2xl overflow-hidden shadow-2xl transform transition-all"><div class="p-5"><h3 class="text-lg font-bold text-gray-900 mb-1 text-center">{{ inputModal.title }}</h3><p v-if="inputModal.desc" class="text-xs text-gray-500 mb-2 text-center">{{ inputModal.desc }}</p><input v-model="inputModal.value" :placeholder="inputModal.placeholder" ref="globalInput" class="w-full bg-gray-100 px-3 py-2 rounded-lg border-none outline-none text-sm text-center mt-3 focus:ring-2 focus:ring-blue-100"></div><div class="flex border-t border-gray-100"><button @click="inputModal.show = false" class="flex-1 py-3 text-gray-600 font-medium active:bg-gray-50 text-sm">å–æ¶ˆ</button><div class="w-px bg-gray-100"></div><button @click="handleInputConfirm" class="flex-1 py-3 text-blue-600 font-bold active:bg-gray-50 text-sm">ç¡®å®š</button></div></div></div></transition>
    <transition name="scale"><div v-if="confirmModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[80%] max-w-xs rounded-2xl overflow-hidden shadow-2xl"><div class="p-6 text-center"><h3 class="text-lg font-bold text-gray-900 mb-2">æç¤º</h3><p class="text-sm text-gray-500">{{ confirmModal.message }}</p></div><div class="flex border-t border-gray-100"><button @click="confirmModal.show = false" class="flex-1 py-3 text-gray-600 text-sm">å–æ¶ˆ</button><div class="w-px bg-gray-100"></div><button @click="handleConfirm" class="flex-1 py-3 text-blue-600 font-bold text-sm">ç¡®å®š</button></div></div></div></transition>

    <!-- æ¶ˆæ¯å¼¹çª— (Heads-up Notification) -->
    <transition name="app-slide">
        <div v-if="globalNotification.show" class="top-notification-banner" @click="jumpToChat(globalNotification.sessionId)">
            <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden shrink-0"><img :src="globalNotification.avatar" class="w-full h-full object-cover"></div>
            <div class="flex-1 min-w-0">
                <div class="font-bold text-sm truncate">{{ globalNotification.title }}</div>
                <div class="text-xs text-gray-500 truncate">{{ globalNotification.content }}</div>
            </div>
            <span class="text-xs text-gray-400">ç°åœ¨</span>
        </div>
    </transition>

    <!-- è½¬å‘/å¤šé€‰ æ“ä½œæ  -->
    <transition name="app-slide">
        <div v-if="isMultiSelectMode" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 p-4 z-[40000] flex justify-around items-center">
            <button @click="executeMultiAction('forward')" class="flex flex-col items-center gap-1 text-gray-600"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-share"></i></div><span class="text-xs">è½¬å‘</span></button>
            <button @click="executeMultiAction('delete')" class="flex flex-col items-center gap-1 text-gray-600"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-trash"></i></div><span class="text-xs">åˆ é™¤</span></button>
            <button @click="exitMultiSelect" class="flex flex-col items-center gap-1 text-gray-600"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-times"></i></div><span class="text-xs">å–æ¶ˆ</span></button>
        </div>
    </transition>

    <!-- è½¬å‘è”ç³»äººé€‰æ‹©å™¨ -->
    <transition name="app-slide">
        <div v-if="forwardModal.show" class="fixed inset-0 z-[65000] bg-white flex flex-col">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white"><button @click="forwardModal.show = false" class="text-gray-500 text-sm">å–æ¶ˆ</button><h3 class="font-bold text-lg">é€‰æ‹©è½¬å‘å¯¹è±¡</h3><div class="w-8"></div></div>
            <div class="flex-1 overflow-y-auto p-4">
                <div v-for="session in wechatState.sessions" :key="session.id" @click="confirmForward(session)" class="flex items-center p-3 hover:bg-gray-50 rounded-xl cursor-pointer">
                    <div class="w-10 h-10 rounded-full bg-gray-100 overflow-hidden mr-3"><img :src="session.avatar" class="w-full h-full object-cover"></div>
                    <span class="font-bold text-sm">{{ session.name }}</span>
                </div>
                <div v-if="wechatState.sessions.length===0" class="text-center text-gray-400 mt-10">æ— æœ€è¿‘ä¼šè¯</div>
            </div>
        </div>
    </transition>

    <!-- å¿ƒå£°/çŠ¶æ€å±•ç¤ºå¼¹çª— -->
    <transition name="scale">
        <div v-if="statusDisplayModal.show" class="fixed inset-0 z-[60000] flex items-center justify-center bg-black/40 backdrop-blur-sm" @click="statusDisplayModal.show = false">
            <div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl p-6 relative" @click.stop>
                <div class="absolute top-4 right-4 text-xs text-gray-400 cursor-pointer underline" @click="showStatusHistory">å†å²è®°å½•</div>
                <div class="flex flex-col items-center mb-6">
                    <div class="w-16 h-16 rounded-full bg-gray-100 overflow-hidden mb-3"><img :src="statusDisplayModal.data.avatar" class="w-full h-full object-cover"></div>
                    <h3 class="font-bold text-xl">{{ statusDisplayModal.data.name }} çš„çŠ¶æ€</h3>
                </div>
                <div class="space-y-4 text-sm text-gray-700">
                    <div><span class="font-bold text-gray-900 block mb-1">ğŸ’¬ å¿ƒå£°</span>{{ statusDisplayModal.data.thought || 'æ— ' }}</div>
                    <div><span class="font-bold text-gray-900 block mb-1">ğŸƒ åŠ¨ä½œ</span>{{ statusDisplayModal.data.action || 'æ— ' }}</div>
                    <div><span class="font-bold text-gray-900 block mb-1">ğŸ‘— ç©¿ç€</span>{{ statusDisplayModal.data.outfit || 'æ— ' }}</div>
                    <div><span class="font-bold text-gray-900 block mb-1">ğŸ“ éšç¬”</span>{{ statusDisplayModal.data.essay || 'æ— ' }}</div>
                </div>
            </div>
        </div>
    </transition>

    <!-- å¿ƒå£°å†å²è®°å½• -->
    <transition name="app-slide">
        <div v-if="statusHistoryModal.show" class="fixed inset-0 z-[61000] bg-white flex flex-col">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center"><button @click="statusHistoryModal.show = false" class="text-gray-500 text-sm"><i class="fas fa-chevron-left"></i> è¿”å›</button><h3 class="font-bold text-lg">å¿ƒå£°å†å²</h3><div class="w-8"></div></div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div v-if="!statusHistoryModal.list.length" class="text-center text-gray-400 mt-10">æš‚æ— å†å²è®°å½•</div>
                <div v-for="(item, idx) in statusHistoryModal.list" :key="idx" class="bg-gray-50 p-4 rounded-xl text-sm">
                    <div class="text-xs text-gray-400 mb-2">{{ formatChatTime(item.time) }}</div>
                    <div class="mb-1"><span class="font-bold">å¿ƒå£°:</span> {{ item.thought }}</div>
                    <div class="mb-1"><span class="font-bold">åŠ¨ä½œ:</span> {{ item.action }}</div>
                    <div class="mb-1"><span class="font-bold">ç©¿ç€:</span> {{ item.outfit }}</div>
                    <div class="italic text-gray-500 mt-2">"{{ item.essay }}"</div>
                </div>
            </div>
        </div>
    </transition>

    <!-- é•¿æŒ‰èœå• é®ç½©å±‚ -->
    <div v-if="chatContextMenu.show" class="fixed inset-0 z-[99998] bg-transparent" @click.stop="closeAllMenus"></div>
    <transition name="fade">
        <div v-if="chatContextMenu.show" class="chat-context-menu" :style="{top: chatContextMenu.y + 'px', left: chatContextMenu.x + 'px'}" @click.stop>
            <div class="context-item" @click="handleChatMenuAction('copy')"><i class="far fa-copy text-lg"></i><span>å¤åˆ¶</span></div>
            <div class="context-item" @click="handleChatMenuAction('forward')"><i class="fas fa-share text-lg"></i><span>è½¬å‘</span></div>
            <div class="context-item" @click="handleChatMenuAction('edit')"><i class="fas fa-pen text-lg"></i><span>ç¼–è¾‘</span></div>
            <div class="context-item" @click="handleChatMenuAction('favorite')"><i class="fas fa-cube text-lg"></i><span>æ”¶è—</span></div>
            <div class="context-item" @click="handleChatMenuAction('delete')"><i class="far fa-trash-alt text-lg"></i><span>åˆ é™¤</span></div>
            <div class="context-item" @click="handleChatMenuAction('multi')"><i class="fas fa-list-check text-lg"></i><span>å¤šé€‰</span></div>
            <div class="context-item" @click="handleChatMenuAction('quote')"><i class="fas fa-quote-right text-lg"></i><span>å¼•ç”¨</span></div>
            <div v-if="chatContextMenu.isSelf" class="context-item" @click="handleChatMenuAction('recall')"><i class="fas fa-undo text-lg"></i><span>æ’¤å›</span></div>
            <div v-if="!chatContextMenu.isSelf" class="context-item" @click="handleChatMenuAction('regenerate')"><i class="fas fa-sync-alt text-lg"></i><span>é‡å›</span></div>
        </div>
    </transition>

    <!-- å¼¹çª—ç»„ä»¶ -->
    <transition name="scale"><div v-if="modelSelectModal.show" class="fixed inset-0 z-[65000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl flex flex-col max-h-[60vh]"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white"><h3 class="font-bold text-lg text-gray-900">é€‰æ‹©æ¨¡å‹</h3><button @click="modelSelectModal.show = false" class="text-gray-400 font-medium text-sm">å…³é—­</button></div><div class="flex-1 overflow-y-auto p-2 space-y-1"><div v-if="availableModels.length===0" class="p-4 text-center text-xs text-gray-400">åˆ—è¡¨ä¸ºç©º</div><div v-for="model in availableModels" :key="model" @click="selectModel(model)" class="p-3.5 rounded-xl flex items-center justify-between active:bg-gray-50 transition" :class="apiConfig.selectedModel === model ? 'bg-blue-50' : ''"><span class="font-bold text-sm text-gray-800">{{ model }}</span><i v-if="apiConfig.selectedModel === model" class="fas fa-check text-blue-500"></i></div></div></div></div></transition>

    <!-- ä¸–ç•Œä¹¦ç»‘å®šå¼¹çª— (White UI Multi-select) -->
    <transition name="scale">
        <div v-if="worldBinderModal.show" class="fixed inset-0 z-[65000] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl flex flex-col max-h-[60vh]">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white"><h3 class="font-bold text-lg text-gray-900">ç»‘å®šä¸–ç•Œä¹¦ (å¤šé€‰)</h3><button @click="worldBinderModal.show = false" class="text-blue-500 font-bold text-sm">å®Œæˆ</button></div>
                <div class="flex-1 overflow-y-auto p-2 space-y-1">
                    <div @click="bindWorldFolder(null)" class="p-3.5 rounded-xl border border-dashed border-gray-200 text-center text-gray-400 text-xs active:bg-gray-50 mb-2">ä¸ç»‘å®š (é»˜è®¤)</div>
                    <div v-for="folder in folders" :key="folder.id" @click="toggleWorldBinding(folder.id)" class="p-3.5 rounded-xl flex items-center justify-between active:bg-gray-50 transition border border-gray-50">
                        <div class="flex items-center gap-3"><i class="fas fa-folder text-yellow-400"></i><span class="font-bold text-sm text-gray-800">{{ folder.name }}</span></div>
                        <div class="w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center transition" :class="isFolderBound(folder.id) ? 'bg-blue-500 border-blue-500' : ''">
                            <i v-if="isFolderBound(folder.id)" class="fas fa-check text-white text-xs"></i>
                        </div>
                    </div>
                    <div v-if="folders.length===0" class="text-center text-xs text-gray-400 py-8">æš‚æ— æ–‡ä»¶å¤¹</div>
                </div>
            </div>
        </div>
    </transition>
    
    <!-- ä¸–ç•Œä¹¦æ–‡ä»¶å¤¹é€‰æ‹©å¼¹çª— (Create/Edit File) - iOS Style -->
    <transition name="app-slide">
        <div v-if="folderSelectModal.show" class="fixed inset-0 z-[66000]">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="folderSelectModal.show = false"></div>
            <div class="ios-list-modal">
                <div class="ios-list-header">é€‰æ‹©æ–‡ä»¶å¤¹ <button class="absolute right-4 text-blue-500 font-normal text-sm" @click="folderSelectModal.show = false">å–æ¶ˆ</button></div>
                <div class="ios-list-content">
                    <div class="ios-list-item" @click="selectWorldFolder(null)"><span class="text-gray-800 font-medium">æ ¹ç›®å½• (ä¸å½’ç±»)</span><i v-if="!worldModal.parentId" class="fas fa-check text-blue-500"></i></div>
                    <div v-for="folder in folders" :key="folder.id" class="ios-list-item" @click="selectWorldFolder(folder.id)">
                        <div class="flex items-center gap-2"><i class="fas fa-folder text-yellow-400"></i><span class="text-gray-800 font-medium">{{ folder.name }}</span></div>
                        <i v-if="worldModal.parentId === folder.id" class="fas fa-check text-blue-500"></i>
                    </div>
                    <div v-if="folders.length===0" class="p-4 text-center text-gray-400 text-xs">æš‚æ— æ–‡ä»¶å¤¹</div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="scale"><div v-if="chatWizard.show" class="fixed inset-0 z-[55000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[90%] h-[70vh] rounded-2xl overflow-hidden shadow-2xl flex flex-col animate-scale-in"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white"><button @click="closeChatWizard" class="text-gray-500 font-medium text-sm">å–æ¶ˆ</button><h3 class="font-bold text-lg text-gray-900">{{ chatWizard.step === 1 ? 'é€‰æ‹©æˆ‘çš„é¢å…·' : (chatWizard.type === 'single' ? 'é€‰æ‹©å¥½å‹' : 'é€‰æ‹©ç¾¤æˆå‘˜') }}</h3><button v-if="chatWizard.step === 2 && chatWizard.type === 'group'" @click="finishCreateChat" class="text-green-600 font-bold text-sm bg-green-50 px-3 py-1 rounded-lg">å®Œæˆ</button></div><div class="flex-1 overflow-y-auto p-4 space-y-3"><div v-if="chatWizard.step === 1"><div v-if="masks.length === 0" class="text-center text-gray-400 mt-20 text-xs">æ²¡æœ‰å¯ç”¨é¢å…·ï¼Œè¯·å»"æˆ‘-é¢å…·"æ·»åŠ </div><div v-for="mask in masks" :key="mask.id" @click="selectWizardMask(mask)" class="bg-white border border-gray-100 p-3 rounded-xl flex items-center gap-3 active:bg-gray-50 cursor-pointer"><div class="w-10 h-10 rounded-full bg-gray-100 overflow-hidden"><img v-if="mask.avatar" :src="mask.avatar" class="w-full h-full object-cover"></div><div class="flex-1"><h4 class="font-bold text-sm">{{ mask.name }}</h4><p class="text-xs text-gray-400">{{ mask.bio || 'æ— ä»‹ç»' }}</p></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div></div><div v-if="chatWizard.step === 2"><div v-if="wechatState.friendList.length === 0" class="text-center text-gray-400 mt-20 text-xs">é€šè®¯å½•æš‚æ— å¥½å‹</div><div v-for="friend in wechatState.friendList" :key="friend.id" @click="selectWizardContact(friend)" class="bg-white border p-3 rounded-xl flex items-center gap-3 active:bg-gray-50 cursor-pointer transition" :class="chatWizard.selectedContacts.includes(friend.id) ? 'border-green-500 bg-green-50' : 'border-gray-100'"><div v-if="chatWizard.type === 'group'" class="w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center" :class="{'bg-green-500 border-green-500': chatWizard.selectedContacts.includes(friend.id)}"><i v-if="chatWizard.selectedContacts.includes(friend.id)" class="fas fa-check text-white text-[10px]"></i></div><div class="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden"><img v-if="friend.avatar" :src="friend.avatar" class="w-full h-full object-cover"></div><span class="font-bold text-sm">{{ friend.remark || friend.name }}</span></div></div></div></div></div></transition>

    <!-- ä¸–ç•Œä¹¦æ·»åŠ /ç¼–è¾‘æ–‡ä»¶ Modal (iOS UI) -->
    <transition name="scale"><div v-if="worldModal.show" class="fixed inset-0 z-[55000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[85%] rounded-[24px] overflow-hidden shadow-2xl p-6 space-y-4"><h3 class="text-lg font-bold text-center text-gray-900">{{ worldModal.id ? 'ç¼–è¾‘æ–‡ä»¶' : (worldModal.type === 'folder' ? 'æ–°å»ºæ–‡ä»¶å¤¹' : 'æ–°å»ºæ–‡ä»¶') }}</h3><input v-model="worldModal.name" placeholder="è¯·è¾“å…¥åç§°" class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 outline-none"><div v-if="worldModal.type === 'file'" class="space-y-4"><div class="space-y-1"><label class="text-xs text-gray-500 ml-1">å½’ç±»æ–‡ä»¶å¤¹</label><div @click="folderSelectModal.show = true" class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 flex justify-between items-center cursor-pointer text-gray-700"><span :class="worldModal.parentId ? 'text-black' : 'text-gray-400'">{{ getFolderName(worldModal.parentId) }}</span><i class="fas fa-chevron-right text-xs text-gray-300"></i></div></div><textarea v-model="worldModal.content" placeholder="è¾“å…¥æ–‡ä»¶å†…å®¹..." class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 outline-none h-32 resize-none"></textarea></div><div class="flex gap-3 pt-2"><button @click="worldModal.show = false" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold text-sm">å–æ¶ˆ</button><button @click="saveWorldItem" class="flex-1 bg-black text-white py-3 rounded-xl font-bold text-sm">ä¿å­˜</button></div></div></div></transition>
    <transition name="scale"><div v-if="addContactModal.show" class="fixed inset-0 z-[55000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[90%] max-h-[85vh] rounded-[24px] overflow-hidden shadow-2xl flex flex-col animate-scale-in"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10"><button @click="addContactModal.show = false" class="text-gray-500 font-medium text-sm">å–æ¶ˆ</button><h3 class="font-bold text-lg text-gray-900">{{ newContact.id ? 'ç¼–è¾‘æœ‹å‹' : 'æ·»åŠ æœ‹å‹' }}</h3><button @click="saveNewContact" class="text-green-600 font-bold text-sm bg-green-50 px-3 py-1 rounded-lg">å®Œæˆ</button></div><div class="flex-1 overflow-y-auto p-6 space-y-5"><div class="flex flex-col items-center gap-2"><div class="w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative cursor-pointer active:opacity-70 transition" @click="triggerAddContactAvatar"><img v-if="newContact.avatar" :src="newContact.avatar" class="w-full h-full object-cover"><div v-else class="flex flex-col items-center text-gray-400"><i class="fas fa-camera text-2xl mb-1"></i><span class="text-[10px]">ä¸Šä¼ å¤´åƒ</span></div></div></div><div class="space-y-4"><div><label class="text-xs text-gray-500 ml-1 mb-1 block">å§“å</label><input v-model="newContact.name" placeholder="è¾“å…¥å§“å" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">å¤‡æ³¨</label><input v-model="newContact.remark" placeholder="è¾“å…¥å¤‡æ³¨å" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">ç½‘å (ID)</label><input v-model="newContact.username" placeholder="è¾“å…¥ç½‘å/å¾®ä¿¡å·" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">æ€§åˆ«</label><div class="flex gap-3"><div @click="newContact.gender = 'ç”·'" class="flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 cursor-pointer transition" :class="newContact.gender==='ç”·'?'bg-blue-50 border-blue-200 text-blue-600':'bg-white border-gray-200 text-gray-500'"><i class="fas fa-mars"></i> ç”·</div><div @click="newContact.gender = 'å¥³'" class="flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 cursor-pointer transition" :class="newContact.gender==='å¥³'?'bg-pink-50 border-pink-200 text-pink-600':'bg-white border-gray-200 text-gray-500'"><i class="fas fa-venus"></i> å¥³</div></div></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">æ‹ä¸€æ‹</label><input v-model="newContact.nudge" placeholder="æ‹ä¸€æ‹åç¼€" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">ä¸ªæ€§ç­¾å</label><input v-model="newContact.signature" placeholder="è¾“å…¥ä¸ªæ€§ç­¾å" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div><div><label class="text-xs text-gray-500 ml-1 mb-1 block">èƒŒæ™¯èµ„æ–™</label><textarea v-model="newContact.bio" placeholder="è¾“å…¥äººè®¾ã€èƒŒæ™¯æ•…äº‹..." class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none h-24 resize-none"></textarea></div></div></div><input type="file" ref="addContactAvatarInput" accept="image/*" class="hidden" @change="handleAddContactAvatar"></div></div></transition>

    <!-- é¢å…·ç®¡ç† Modal (Z-Index 50000) -->
    <transition name="scale"><div v-if="showMaskManager" class="fixed inset-0 z-[50000] bg-gray-50 flex flex-col"><div class="h-[90px] pt-10 px-4 flex items-center justify-between bg-white border-b border-gray-100"><button @click.stop="showMaskManager = false" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-chevron-left"></i></button><h1 class="text-[17px] font-bold">æˆ‘çš„é¢å…·</h1><button @click="openMaskEditor(null)" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-plus"></i></button></div><div class="flex-1 overflow-y-auto p-4 space-y-3"><div v-if="masks.length === 0" class="text-center text-gray-400 mt-20 text-xs">æš‚æ— é¢å…·ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div><div v-for="mask in masks" :key="mask.id" @click="openMaskEditor(mask)" class="bg-white p-4 rounded-xl flex items-center gap-4 shadow-sm border border-gray-100 cursor-pointer active:bg-gray-50"><div class="w-12 h-12 rounded-full bg-gray-100 overflow-hidden shrink-0"><img v-if="mask.avatar" :src="mask.avatar" class="w-full h-full object-cover"><i v-else class="fas fa-mask flex h-full items-center justify-center text-purple-300 text-xl"></i></div><div><h3 class="font-bold text-gray-900">{{ mask.name }}</h3><p class="text-xs text-gray-400 line-clamp-1">{{ mask.bio || 'æš‚æ— ä»‹ç»' }}</p></div></div></div></div></transition>
    
    <!-- é¢å…·ç¼–è¾‘ Modal -->
    <transition name="scale">
        <div v-if="maskModal.show" class="fixed inset-0 z-[55000] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-white w-[90%] max-h-[85vh] rounded-[24px] overflow-hidden shadow-2xl flex flex-col animate-scale-in">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                    <button @click="maskModal.show = false" class="text-gray-500 font-medium text-sm">å–æ¶ˆ</button>
                    <h3 class="font-bold text-lg text-gray-900">{{ maskForm.id ? 'ç¼–è¾‘é¢å…·' : 'æ–°å»ºé¢å…·' }}</h3>
                    <button @click="saveMask" class="text-purple-600 font-bold text-sm bg-purple-50 px-3 py-1 rounded-lg">ä¿å­˜</button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 space-y-5">
                    <div class="flex flex-col items-center gap-2">
                        <div class="w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative cursor-pointer active:opacity-70 transition" @click="triggerMaskAvatar">
                            <img v-if="maskForm.avatar" :src="maskForm.avatar" class="w-full h-full object-cover">
                            <div v-else class="flex flex-col items-center text-gray-400"><i class="fas fa-mask text-2xl mb-1"></i><span class="text-[10px]">é¢å…·å¤´åƒ</span></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div><label class="text-xs text-gray-500 ml-1 mb-1 block">å§“å</label><input v-model="maskForm.name" placeholder="è¾“å…¥å§“å" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div>
                        <div><label class="text-xs text-gray-500 ml-1 mb-1 block">ç½‘å (ID)</label><input v-model="maskForm.username" placeholder="è¾“å…¥ID" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div>
                        <div><label class="text-xs text-gray-500 ml-1 mb-1 block">æ€§åˆ«</label><div class="flex gap-3"><div @click="maskForm.gender = 'ç”·'" class="flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 cursor-pointer transition" :class="maskForm.gender==='ç”·'?'bg-blue-50 border-blue-200 text-blue-600':'bg-white border-gray-200 text-gray-500'"><i class="fas fa-mars"></i> ç”·</div><div @click="maskForm.gender = 'å¥³'" class="flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 cursor-pointer transition" :class="maskForm.gender==='å¥³'?'bg-pink-50 border-pink-200 text-pink-600':'bg-white border-gray-200 text-gray-500'"><i class="fas fa-venus"></i> å¥³</div></div></div>
                        <div><label class="text-xs text-gray-500 ml-1 mb-1 block">æ‹ä¸€æ‹</label><input v-model="maskForm.nudge" placeholder="æ‹ä¸€æ‹åç¼€" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div>
                        <div><label class="text-xs text-gray-500 ml-1 mb-1 block">ä¸ªæ€§ç­¾å</label><input v-model="maskForm.signature" placeholder="è¾“å…¥ä¸ªæ€§ç­¾å" class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none"></div>
                        <div><label class="text-xs text-gray-500 ml-1 mb-1 block">èƒŒæ™¯èµ„æ–™</label><textarea v-model="maskForm.bio" placeholder="äººè®¾èƒŒæ™¯..." class="w-full bg-gray-50 px-4 py-3 rounded-xl text-sm border border-gray-200 outline-none h-24 resize-none"></textarea></div>
                    </div>
                    <button v-if="maskForm.id" @click="deleteMask(maskForm.id)" class="w-full py-3 text-red-500 bg-red-50 rounded-xl font-bold text-sm">åˆ é™¤æ­¤é¢å…·</button>
                </div>
                <input type="file" ref="maskAvatarInput" accept="image/*" class="hidden" @change="handleMaskAvatar">
            </div>
        </div>
    </transition>

    <!-- çŠ¶æ€æ  -->
    <transition name="fade">
        <div v-if="!hideStatusBar" class="h-[44px] flex justify-between items-center px-6 pt-2 text-[15px] z-[5000] absolute top-0 w-full select-none pointer-events-none status-bar-text text-black">
            <span class="w-16 text-center font-semibold">{{ statusBar.time }}</span>
            <div class="flex items-center gap-1.5">
                <i class="fas fa-signal text-[13px]"></i><i class="fas fa-wifi text-[13px] ml-1"></i>
                <div class="relative w-[24px] h-[11.5px] border-[1px] border-current rounded-[3.5px] flex items-center p-[1px] ml-1">
                    <div class="h-full rounded-[1.5px] transition-all duration-500" :class="statusBar.isCharging ? 'bg-green-500' : 'bg-current'" :style="{ width: statusBar.batteryLevel + '%' }"></div>
                    <div class="absolute -right-[3.5px] top-1/2 -translate-y-1/2 w-[1.5px] h-[4px] bg-current rounded-r-[2px]"></div>
                    <i v-if="statusBar.isCharging" class="fas fa-bolt absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[8px] text-white drop-shadow-sm"></i>
                </div>
            </div>
        </div>
    </transition>

    <!-- ä¸»ç•Œé¢ -->
    <div class="h-full w-full flex flex-col items-center pb-safe relative overflow-hidden overflow-y-auto scrollbar-hide transition-all duration-300 bg-center bg-cover" 
         :style="{ backgroundImage: themeConfig.wallpaper ? `url(${themeConfig.wallpaper})` : '', backgroundColor: themeConfig.wallpaper ? 'transparent' : '#f3f4f6' }"
         :class="[hideStatusBar ? 'pt-0' : 'pt-[44px]', {'scale-95 opacity-80': isAppOpen}]">
         <div class="w-full flex flex-col items-center skin-text-container" :style="{ 'font-family': themeConfig.fontFamily || 'inherit', 'color': themeConfig.fontColor || '#000000', '--custom-font-size': themeConfig.fontSize + 'em' }">
            <div class="w-[90%] z-20 mt-2 mb-2 shrink-0"><div class="bg-white/90 backdrop-blur-sm rounded-[20px] p-4 shadow-[0_4px_20px_rgba(0,0,0,0.03)] relative"><div class="flex justify-between items-start mb-3"><div class="flex gap-3"><div class="w-[52px] h-[52px] border border-gray-100 rounded-lg p-0.5 flex flex-col items-center justify-between shrink-0 cursor-pointer active:scale-95 transition bg-white" @click="triggerCardAvatarUpload"><div class="w-full h-[70%] rounded-md overflow-hidden bg-gray-50 relative"><img v-if="cardProfile.avatar" :src="cardProfile.avatar" class="w-full h-full object-cover grayscale opacity-80"><i v-else class="fas fa-user text-gray-300 text-xl flex h-full items-center justify-center"></i></div><span class="text-[8px] opacity-60 scale-90 origin-bottom font-medium truncate w-full text-center" @click.stop="editCardProfile('status')">{{ cardProfile.status }}</span></div><div class="flex flex-col pt-0.5" style="font-size: var(--custom-font-size)"><h2 @click="editCardProfile('name')" class="text-[14px] font-bold tracking-wider mb-0.5 cursor-pointer active:opacity-50" :style="{color: themeConfig.fontColor}">{{ cardProfile.name }}</h2><p @click="editCardProfile('id')" class="text-[10px] opacity-60 font-mono tracking-wide cursor-pointer active:opacity-50" :style="{color: themeConfig.fontColor}">@ {{ cardProfile.id }}</p></div></div><div class="flex items-center gap-1 text-[10px] opacity-60 font-medium pt-1" :style="{color: themeConfig.fontColor}"><span>{{ displayDate.dateString }}</span><i class="fas fa-heart text-[8px]"></i><span>{{ displayDate.dayString }}</span></div></div><div @click="editCardProfile('bio')" class="text-[12px] leading-relaxed font-medium tracking-wide text-justify cursor-pointer active:opacity-50 border-t border-gray-50/20 pt-2" :style="{color: themeConfig.fontColor, fontSize: 'calc(var(--custom-font-size) * 0.9)'}">{{ cardProfile.bio }}</div></div></div>
            <div class="flex flex-col items-center w-full mb-3 z-10 shrink-0" style="font-size: var(--custom-font-size)"><div class="w-20 h-20 rounded-full p-1 bg-gradient-to-tr from-gray-200 to-white shadow-lg mb-2 cursor-pointer active:scale-95 transition" @click="triggerHomeAvatarUpload"><div class="w-full h-full rounded-full overflow-hidden bg-gray-100 relative"><img v-if="homeProfile.avatar" :src="homeProfile.avatar" class="w-full h-full object-cover"><i v-else class="fas fa-user text-gray-300 text-3xl flex h-full items-center justify-center"></i></div></div><h2 @click="editHomeProfile('name')" class="text-lg font-bold tracking-wide cursor-pointer active:opacity-50 transition" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ homeProfile.name }}</h2><p @click="editHomeProfile('id')" class="text-xs opacity-80 mt-1 font-mono tracking-wider cursor-pointer active:opacity-50 transition" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow': themeConfig.wallpaper}">@{{ homeProfile.id }}</p><p @click="editHomeProfile('bio')" class="text-[10px] opacity-80 mt-2 tracking-[0.1em] cursor-pointer active:opacity-50 transition px-8 text-center" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow': themeConfig.wallpaper}">{{ homeProfile.bio }}</p><div @click="editHomeProfile('location')" class="mt-3 flex items-center gap-1 text-xs opacity-80 cursor-pointer active:opacity-50 transition" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow': themeConfig.wallpaper}"><i class="fas fa-map-marker-alt"></i><span>{{ homeProfile.location }}</span></div></div>
            <div class="w-full px-8 grid grid-cols-2 gap-6 mb-auto z-10 items-start shrink-0" style="font-size: var(--custom-font-size)"><div class="flex flex-col items-center"><h3 @click="editHomeConfig('widgetTitle', 'ä¿®æ”¹å·¦ä¾§æ ‡é¢˜')" class="text-sm font-bold mb-4 cursor-pointer active:opacity-50 transition self-start pl-2" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ homeConfig.widgetTitle }}</h3><div class="grid grid-cols-2 gap-x-5 gap-y-5 justify-items-center w-full"><div v-for="id in ['wechat', 'themes', 'worldbook', 'settings']" :key="id" class="flex flex-col items-center gap-1.5 home-icon cursor-pointer" :class="{'home-icon-custom': hasCustomIcon(id)}" @click="handleAppClick(id)"><div class="w-12 h-12 rounded-xl bg-white text-gray-400 flex items-center justify-center text-xl shadow-sm border border-gray-100 overflow-hidden"><img v-if="hasCustomIcon(id)" :src="getAppIcon(id)" class="w-full h-full object-cover"><i v-else :class="getDefaultIconClass(id)"></i></div><span class="text-[10px] font-bold" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow': themeConfig.wallpaper}">{{ getAppName(id) }}</span></div></div></div><div class="flex flex-col items-center"><div class="flex gap-3 justify-center items-end mt-4"><div class="flex flex-col items-center relative w-16"><div @click="editCustomWidget(0, 'bubble')" class="widget-bubble cursor-pointer active:scale-95 transition">{{ customWidgets[0].bubble }}</div><div class="w-14 h-14 rounded-full border-2 border-white shadow-md overflow-hidden bg-gray-100 cursor-pointer active:scale-95 transition" @click="triggerWidgetImageUpload(0)"><img v-if="customWidgets[0].image" :src="customWidgets[0].image" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-gray-300 text-xs">å›¾</div></div><span @click="editCustomWidget(0, 'label')" class="text-[11px] font-bold mt-1 cursor-pointer active:opacity-50" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ customWidgets[0].label }}</span></div><div class="flex flex-col items-center relative w-16"><div @click="editCustomWidget(1, 'bubble')" class="widget-bubble cursor-pointer active:scale-95 transition">{{ customWidgets[1].bubble }}</div><div class="w-14 h-14 rounded-full border-2 border-white shadow-md overflow-hidden bg-gray-100 cursor-pointer active:scale-95 transition" @click="triggerWidgetImageUpload(1)"><img v-if="customWidgets[1].image" :src="customWidgets[1].image" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-gray-300 text-xs">å›¾</div></div><span @click="editCustomWidget(1, 'label')" class="text-[11px] font-bold mt-1 cursor-pointer active:opacity-50" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ customWidgets[1].label }}</span></div></div><h3 @click="editHomeConfig('rightWidgetTitle', 'ä¿®æ”¹å³ä¾§æ ‡é¢˜')" class="text-sm font-bold mt-6 cursor-pointer active:opacity-50 transition" :style="{color: themeConfig.fontColor}" :class="{'drop-shadow-md': themeConfig.wallpaper}">{{ homeConfig.rightWidgetTitle }}</h3></div></div>
        </div>
        <div class="dock-container w-full h-24 flex items-center justify-around px-4 mt-6 mb-8 shrink-0"><div v-for="id in ['icity', 'forum', 'check', 'pinxixi']" :key="id" class="flex flex-col items-center gap-1 home-icon cursor-pointer" :class="{'home-icon-custom': hasCustomIcon(id)}" @click="showToast('ä»…ä½œä¸ºå±•ç¤º')"><div class="w-12 h-12 rounded-xl bg-white shadow-sm flex items-center justify-center text-gray-400 text-lg overflow-hidden"><img v-if="hasCustomIcon(id)" :src="getAppIcon(id)" class="w-full h-full object-cover"><i v-else :class="getDefaultIconClass(id)"></i></div><span class="text-[10px] font-bold text-gray-600">{{ getAppName(id) }}</span></div></div>
        <input type="file" ref="homeAvatarInput" accept="image/*" class="hidden" @change="handleHomeAvatarChange"><input type="file" ref="cardAvatarInput" accept="image/*" class="hidden" @change="handleCardAvatarChange"><input type="file" ref="widgetImageInput" accept="image/*" class="hidden" @change="handleWidgetImageChange">
    </div>

    <!-- ================= å¾®ä¿¡ (WeChat) App ================= -->
    <transition name="app-slide">
        <div v-if="currentApp === 'wechat'" class="absolute inset-0 z-[1000] bg-[#f7f7f7] flex flex-col overflow-hidden text-black" @click="closeChatMenus">
            
            <!-- å¤´éƒ¨ -->
            <header v-if="wechatState.activeNav !== 'room' && wechatState.activeNav !== 'chat-details'" class="h-[90px] pt-10 px-4 flex items-center justify-between sticky top-0 z-[60] bg-[#f7f7f7]">
                <button @click="closeApp" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-times text-lg"></i></button>
                <h1 class="text-[17px] font-medium">{{ wechatState.activeNav === 'contacts' ? 'é€šè®¯å½•' : (wechatState.activeNav === 'discover' ? 'å‘ç°' : (wechatState.activeNav === 'me' ? '' : 'å¾®ä¿¡')) }}</h1>
                <div class="w-8 flex justify-end relative">
                    <i v-if="wechatState.activeNav === 'chat'" class="fas fa-plus text-lg cursor-pointer" @click.stop="wechatState.showPlusMenu = !wechatState.showPlusMenu"></i>
                    <i v-if="wechatState.activeNav === 'contacts'" class="fas fa-plus text-lg cursor-pointer" @click="openAddContactModal"></i>
                    
                    <!-- ä¿®å¤åçš„ä¸‹æ‹‰èœå• -->
                    <div v-if="wechatState.showPlusMenu" class="wechat-dropdown">
                        <div @click="startChatWizard('single')" class="px-4 py-3 hover:bg-white/10 flex items-center gap-3 text-sm cursor-pointer border-b border-white/10"><i class="fas fa-comment-alt"></i> å‘èµ·å•èŠ</div>
                        <div @click="startChatWizard('group')" class="px-4 py-3 hover:bg-white/10 flex items-center gap-3 text-sm cursor-pointer"><i class="fas fa-users"></i> å‘èµ·ç¾¤èŠ</div>
                    </div>
                </div>
            </header>

            <!-- èŠå¤©æˆ¿é—´ (Chat Room) -->
            <div v-if="wechatState.activeNav === 'room'" class="flex-1 flex flex-col bg-[#fdfdfd] absolute inset-0 z-20">
                <header class="h-[90px] pt-10 px-4 flex items-center justify-between bg-white border-b border-gray-100">
                    <button @click="wechatState.activeNav = 'chat'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg text-gray-800"></i></button>
                    <!-- ç‚¹å‡»åå­—æ˜¾ç¤ºçŠ¶æ€ -->
                    <div class="flex flex-col items-center cursor-pointer active:opacity-50" @click="showStatusDisplay">
                        <h1 class="font-medium text-[16px] text-gray-900 flex items-center gap-1">
                            <span v-if="isTyping">å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­<span class="typing-dot">.</span><span class="typing-dot">.</span><span class="typing-dot">.</span></span>
                            <span v-else>{{ wechatState.activeSession.name }}</span>
                        </h1>
                        <span class="text-[10px] text-gray-300 tracking-wider">Only You.</span>
                    </div>
                    <button class="w-8 h-8 flex items-center justify-center text-gray-800" @click="goToChatDetails"><i class="fas fa-ellipsis-h"></i></button>
                </header>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-5 bg-[#fdfdfd]" ref="chatContainer" @click="closeChatMenus">
                    <div v-if="wechatState.activeSession.messages.length === 0" class="text-center text-xs text-gray-300 py-4">æ˜ŸæœŸæ—¥ 13:42</div>
                    
                    <div v-for="(msg, i) in wechatState.activeSession.messages" :key="i">
                        <!-- æ­£å¸¸æ¶ˆæ¯ (æ”¯æŒå¤šé€‰) -->
                        <div v-if="!msg.isRecalled" class="flex w-full gap-3 mb-2" :class="msg.isSelf ? 'flex-row-reverse' : 'flex-row'" @contextmenu.prevent="showChatContextMenu($event, msg, i)" @touchstart="longPressStart($event, msg, i)" @touchend="longPressEnd">
                            <!-- å¤šé€‰å‹¾é€‰æ¡† -->
                            <div v-if="isMultiSelectMode" class="flex items-center px-2">
                                <input type="checkbox" :checked="selectedMessageIds.includes(msg.id)" @click.stop="toggleMultiSelect(msg)" class="w-5 h-5 rounded-full border border-gray-300 checked:bg-green-500 checked:border-green-500 appearance-none cursor-pointer">
                            </div>

                            <div class="w-10 h-10 rounded-full overflow-hidden shrink-0 border border-gray-100"><img :src="msg.avatar" class="w-full h-full object-cover"></div>
                            <div class="flex flex-col max-w-[70%]" :class="msg.isSelf ? 'items-end' : 'items-start'">
                                <div class="chat-bubble" :class="msg.isSelf ? 'chat-bubble-user' : 'chat-bubble-ai'">
                                    <div v-if="msg.quote" class="quote-block"><span class="font-bold mr-1">{{ msg.quote.name }}:</span>{{ msg.quote.content }}</div>
                                    {{ msg.content }}
                                </div>
                                <span class="chat-timestamp-small">{{ formatChatTime(msg.time) }} Read</span>
                            </div>
                        </div>
                        <!-- æ’¤å›æç¤º -->
                        <div v-else class="system-recall-tip">
                            {{ msg.isSelf ? 'ä½ ' : wechatState.activeSession.name }} æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯
                            <span v-if="!msg.isSelf" class="recall-link" @click="viewRecalled(msg)">(ç‚¹å‡»æŸ¥çœ‹)</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white border-t border-gray-100 pb-safe relative">
                    <transition name="fade"><div v-if="replyingTo" class="absolute bottom-full left-0 w-full bg-gray-100 p-2 text-xs text-gray-500 border-t border-gray-200 flex justify-between items-center z-10"><span>å¼•ç”¨: {{ replyingTo.content }}</span><button @click="replyingTo=null"><i class="fas fa-times"></i></button></div></transition>
                    <transition name="scale"><div v-if="wechatState.showAttachMenu" class="chat-attach-menu"><i class="far fa-image text-xl text-gray-500 cursor-pointer hover:text-black"></i><i class="far fa-star text-xl text-gray-500 cursor-pointer hover:text-black"></i><i class="fas fa-rss text-xl text-gray-500 cursor-pointer hover:text-black"></i></div></transition>
                    <div class="flex items-center gap-3 px-3 py-2"><button @click.stop="wechatState.showAttachMenu = !wechatState.showAttachMenu" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-paperclip text-xl"></i></button><i class="fas fa-microphone text-xl text-gray-400"></i><input v-model="inputMsg" @keyup.enter="sendMessage" class="flex-1 bg-gray-100 rounded-full py-2 px-4 text-sm border-none outline-none" placeholder="Aa..."><i class="far fa-smile text-xl text-gray-400"></i><button v-if="inputMsg.trim().length > 0" @click="sendMessage" class="text-gray-500 active:text-green-500 transition"><i class="fas fa-check-circle text-xl"></i></button><button v-else @click="triggerReceive" class="text-gray-400 active:text-blue-500 transition"><i class="far fa-comment-dots text-xl"></i></button></div>
                </div>
            </div>

            <!-- èŠå¤©è¯¦æƒ…é¡µ -->
            <div v-if="wechatState.activeNav === 'chat-details'" class="flex-1 flex flex-col bg-white absolute inset-0 z-30">
                <header class="h-[90px] pt-10 px-4 flex items-center bg-white border-b border-gray-100"><button @click="wechatState.activeNav = 'room'" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left text-lg text-black"></i></button><h1 class="font-bold text-[17px] ml-2">èŠå¤©è¯¦æƒ…</h1></header><div class="flex-1 overflow-y-auto p-5"><div class="bg-gray-50 rounded-2xl p-4 flex items-center gap-4 mb-6 cursor-pointer active:bg-gray-100 transition" @click="editCurrentSessionFriend"><div class="w-16 h-16 rounded-full bg-white overflow-hidden shadow-sm shrink-0"><img :src="getCurrentSessionAvatar()" class="w-full h-full object-cover"></div><div class="flex-1 min-w-0"><h3 class="font-bold text-lg text-gray-900 truncate">{{ wechatState.activeSession.name }}</h3><p class="text-xs text-gray-500 mt-1 truncate">ID: {{ getCurrentSessionId() }}</p><p class="text-xs text-gray-400 mt-1 truncate">{{ getCurrentSessionBio() }}</p></div><i class="fas fa-chevron-right text-gray-300"></i></div><div class="space-y-6"><div class="flex justify-between items-center"><span class="text-sm">æŸ¥æ‰¾èŠå¤©è®°å½•</span><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="flex justify-between items-center"><span class="text-sm">æ¶ˆæ¯å…æ‰“æ‰°</span><div class="w-10 h-6 bg-gray-200 rounded-full relative"><div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 shadow-sm"></div></div></div><div class="flex justify-between items-center"><span class="text-sm">ç½®é¡¶èŠå¤©</span><input type="checkbox" class="switch-checkbox" id="pin-chat-toggle" :checked="wechatState.activeSession?.isPinned" @change="togglePin"><label for="pin-chat-toggle" class="switch-label"><div class="switch-button"></div></label></div><div class="flex justify-between items-center cursor-pointer active:opacity-50" @click="worldBinderModal.show = true"><div class="flex flex-col"><span class="text-sm">ç»‘å®šä¸–ç•Œä¹¦ (å¯å¤šé€‰)</span><span class="text-xs text-gray-400 mt-0.5">{{ getWorldbookStatus() }}</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><button @click="clearChatHistory" class="w-full text-red-500 font-bold text-sm py-2">æ¸…ç©ºèŠå¤©è®°å½•</button></div></div>
            </div>
            
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <main v-if="wechatState.activeNav === 'chat'" class="flex-1 overflow-y-auto px-3 pb-24 z-0">
                <div class="bg-white rounded-lg py-2 flex items-center justify-center text-gray-400 text-sm mb-4"><i class="fas fa-search mr-1.5"></i><input v-model="wechatState.searchQuery" class="bg-transparent outline-none text-sm text-center wechat-search-input w-full" placeholder="i miss...(T u T)o"></div>
                <!-- ç­›é€‰ Tabs -->
                <div class="bg-white rounded-[20px] p-1 flex justify-between items-center mb-4 sticky top-0 z-0 shadow-sm overflow-x-auto scrollbar-hide"><div v-for="filter in ['Chats', 'Group', 'Likes', 'All']" :key="filter" @click="wechatState.activeFilter = filter" class="wechat-pill-tab cursor-pointer flex-1 text-center" :class="wechatState.activeFilter === filter ? 'wechat-pill-active' : 'wechat-pill-inactive'">{{ filter }}</div></div>
                <div class="bg-white rounded-[18px] min-h-[300px] overflow-hidden">
                    <div v-if="wechatState.sessions.length === 0" class="flex flex-col items-center justify-center h-40 text-gray-300 mt-10"><i class="far fa-comment-dots text-4xl mb-3 opacity-20"></i><p class="text-xs">æš‚æ— ä¼šè¯</p></div>
                    <div v-else><div v-for="session in filteredWechatContacts" :key="session.id" @click="enterChatRoom(session)" class="flex items-center p-4 active:bg-gray-50 transition border-b border-gray-50 last:border-0 relative" :class="{'bg-gray-50': session.isPinned}"><div class="relative shrink-0 mr-3"><div class="w-[50px] h-[50px] rounded-full overflow-hidden wechat-avatar-ring"><div class="w-full h-full rounded-full bg-gray-100 overflow-hidden"><img :src="session.avatar" class="w-full h-full object-cover"></div></div></div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline mb-1"><h3 class="text-[16px] font-semibold text-gray-900 truncate flex items-center gap-1">{{ session.name }} <i v-if="session.isPinned" class="fas fa-thumbtack text-[10px] text-gray-400 rotate-45"></i></h3><span class="text-[11px] text-gray-400 font-normal">åˆšåˆš</span></div><div class="flex justify-between items-center"><p class="text-[13px] text-gray-500 truncate max-w-[80%]">{{ session.lastMessage || '...' }}</p></div></div></div></div>
                </div>
            </main>

            <!-- é€šè®¯å½• -->
            <main v-if="wechatState.activeNav === 'contacts'" class="flex-1 overflow-y-auto px-3 pb-24">
                <div class="bg-white rounded-[18px] mt-4 overflow-hidden shadow-sm">
                    <div class="p-3 bg-gray-50 border-b border-gray-100 text-xs font-bold text-gray-400 sticky top-0">æœ‹å‹</div>
                    <div v-if="wechatState.friendList.length === 0" class="flex flex-col items-center justify-center h-40 text-gray-300"><i class="fas fa-user-plus text-3xl mb-2 opacity-30"></i><p class="text-xs">æš‚æ— æœ‹å‹ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ </p></div>
                    <div v-else class="divide-y divide-gray-50"><div v-for="(friend, index) in wechatState.friendList" :key="index" @click="editFriend(friend)" class="flex items-center p-3 hover:bg-gray-50 transition cursor-pointer"><div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden mr-3 shrink-0"><img v-if="friend.avatar" :src="friend.avatar" class="w-full h-full object-cover"><i v-else class="fas fa-user flex h-full items-center justify-center text-gray-300"></i></div><div class="flex-1 min-w-0"><h4 class="font-bold text-gray-900 text-[15px] truncate">{{ friend.remark || friend.name }}</h4><p class="text-xs text-gray-400 truncate" v-if="friend.bio">{{ friend.bio }}</p></div></div></div>
                </div>
            </main>

            <!-- å‘ç° -->
            <main v-if="wechatState.activeNav === 'discover'" class="flex-1 overflow-y-auto flex items-center justify-center text-gray-400"><div class="text-center"><i class="fas fa-hammer text-3xl mb-2"></i><p>åŠŸèƒ½å¼€å‘ä¸­</p></div></main>

            <!-- æˆ‘ -->
            <main v-if="wechatState.activeNav === 'me'" class="flex-1 overflow-y-auto bg-white">
                <div class="pt-20 px-6 pb-6">
                    <div class="flex items-center gap-4 mb-8"><div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100"><img v-if="homeProfile.avatar" :src="homeProfile.avatar" class="w-full h-full object-cover"></div><div><h2 class="text-xl font-bold">{{ homeProfile.name }}</h2><p class="text-xs text-gray-400 mt-1">å¾®ä¿¡å·: {{ homeProfile.id }}</p></div><i class="fas fa-qrcode ml-auto text-gray-400"></i><i class="fas fa-chevron-right ml-4 text-gray-300 text-xs"></i></div>
                    <div class="space-y-1 border-t border-gray-100"><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50" @click="openMaskManager"><div class="flex items-center gap-3"><i class="fas fa-mask text-purple-500 w-6"></i><span>é¢å…·</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50"><div class="flex items-center gap-3"><i class="fas fa-image text-blue-500 w-6"></i><span>æœ‹å‹åœˆ</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50"><div class="flex items-center gap-3"><i class="fas fa-cube text-orange-500 w-6"></i><span>æ”¶è—</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50"><div class="flex items-center gap-3"><i class="fas fa-smile text-yellow-500 w-6"></i><span>è¡¨æƒ…</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="py-4 flex items-center justify-between cursor-pointer active:bg-gray-50"><div class="flex items-center gap-3"><i class="fas fa-cog text-blue-600 w-6"></i><span>è®¾ç½®</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div></div>
                </div>
            </main>

            <!-- åº•éƒ¨æ‚¬æµ®å¯¼èˆª (èŠå¤©æˆ¿é—´å’ŒèŠå¤©è¯¦æƒ…ä¸æ˜¾ç¤º) -->
            <div v-if="wechatState.activeNav !== 'room' && wechatState.activeNav !== 'chat-details'" class="absolute bottom-6 left-1/2 -translate-x-1/2 wechat-bottom-nav flex items-center justify-around px-4 z-20">
                <div @click="wechatState.activeNav='chat'" class="flex items-center justify-center w-10 h-full cursor-pointer transition text-xl" :class="wechatState.activeNav==='chat' ? 'text-black' : 'text-gray-400'"><i class="fas fa-comment"></i></div>
                <div @click="wechatState.activeNav='contacts'" class="flex items-center justify-center w-10 h-full cursor-pointer transition text-xl" :class="wechatState.activeNav==='contacts' ? 'text-black' : 'text-gray-400'"><i class="fas fa-address-book"></i></div>
                <div @click="wechatState.activeNav='discover'" class="flex items-center justify-center w-10 h-full cursor-pointer transition text-xl" :class="wechatState.activeNav==='discover' ? 'text-black' : 'text-gray-400'"><i class="far fa-compass"></i></div>
                <div @click="wechatState.activeNav='me'" class="flex items-center justify-center w-10 h-full cursor-pointer transition text-xl" :class="wechatState.activeNav==='me' ? 'text-black' : 'text-gray-400'"><i class="far fa-user"></i></div>
            </div>

            <!-- é¢å…·ç®¡ç† View -->
            <transition name="page-slide"><div v-if="showMaskManager" class="absolute inset-0 z-30 bg-gray-50 flex flex-col"><div class="h-[90px] pt-10 px-4 flex items-center justify-between bg-white border-b border-gray-100"><button @click.stop="showMaskManager = false" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-chevron-left"></i></button><h1 class="text-[17px] font-bold">æˆ‘çš„é¢å…·</h1><button @click="openMaskEditor(null)" class="w-8 h-8 flex items-center justify-center text-black"><i class="fas fa-plus"></i></button></div><div class="flex-1 overflow-y-auto p-4 space-y-3"><div v-if="masks.length === 0" class="text-center text-gray-400 mt-20 text-xs">æš‚æ— é¢å…·ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div><div v-for="mask in masks" :key="mask.id" @click="openMaskEditor(mask)" class="bg-white p-4 rounded-xl flex items-center gap-4 shadow-sm border border-gray-100 cursor-pointer active:bg-gray-50"><div class="w-12 h-12 rounded-full bg-gray-100 overflow-hidden shrink-0"><img v-if="mask.avatar" :src="mask.avatar" class="w-full h-full object-cover"><i v-else class="fas fa-mask flex h-full items-center justify-center text-purple-300 text-xl"></i></div><div><h3 class="font-bold text-gray-900">{{ mask.name }}</h3><p class="text-xs text-gray-400 line-clamp-1">{{ mask.bio || 'æš‚æ— ä»‹ç»' }}</p></div></div></div></div></transition>
        </div>
    </transition>

    <!-- è®¾ç½®ã€ä¸»é¢˜ã€ä¸–ç•Œä¹¦ App ä¿æŒåŸæ · (Templateçœç•¥, é€»è¾‘ä¿ç•™) -->
    <transition name="app-slide"><div v-if="currentApp === 'settings'" class="absolute inset-0 z-[1000] bg-gray-50 flex flex-col overflow-hidden"><header class="bg-white/80 backdrop-blur h-[90px] pt-10 flex items-center justify-between px-4 border-b border-gray-200 sticky top-0 z-10"><button @click="navigateSettings('back')" class="w-8 h-8 flex items-center justify-center text-gray-800 bg-gray-100 rounded-full active:bg-gray-200 transition"><i v-if="settingsPage !== 'main'" class="fas fa-chevron-left text-sm"></i><i v-else class="fas fa-times text-sm"></i></button><h1 class="font-bold text-gray-900 text-[17px]">{{ settingsTitle }}</h1><div class="w-8"></div></header><main class="flex-1 overflow-y-auto relative"><transition name="page-slide"><div v-if="settingsPage === 'main'" class="absolute inset-0 p-4"><div class="space-y-4"><div class="bg-white rounded-2xl p-4 flex items-center gap-4 shadow-sm border border-gray-100"><div class="w-14 h-14 rounded-full bg-gray-100 overflow-hidden"><img v-if="homeProfile.avatar" :src="homeProfile.avatar" class="w-full h-full object-cover"></div><div><div class="font-bold text-lg">{{ homeProfile.name }}</div><div class="text-xs text-gray-400">@{{ homeProfile.id }}</div></div></div><div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 divide-y divide-gray-50"><div @click="navigateSettings('api-config')" class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-blue-500 text-white flex items-center justify-center"><i class="fas fa-robot"></i></div><span class="font-medium text-gray-800">API é…ç½®</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div @click="navigateSettings('notification')" class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-green-500 text-white flex items-center justify-center"><i class="fas fa-bell"></i></div><span class="font-medium text-gray-800">æ¶ˆæ¯æç¤ºéŸ³</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div @click="navigateSettings('data-manage')" class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-orange-500 text-white flex items-center justify-center"><i class="fas fa-database"></i></div><span class="font-medium text-gray-800">æ•°æ®ç®¡ç†</span></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div><div class="p-4 flex items-center justify-between active:bg-gray-50"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-purple-500 text-white flex items-center justify-center"><i class="fas fa-expand"></i></div><span class="font-medium text-gray-800">å…¨å±æ¨¡å¼</span></div><input type="checkbox" id="toggle-fs" class="switch-checkbox" v-model="isFullScreen" @change="toggleFullScreen"><label for="toggle-fs" class="switch-label"><div class="switch-button"></div></label></div><div class="p-4 flex items-center justify-between active:bg-gray-50"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-gray-500 text-white flex items-center justify-center"><i class="fas fa-eye-slash"></i></div><span class="font-medium text-gray-800">éšè—çŠ¶æ€æ </span></div><input type="checkbox" id="toggle-sb" class="switch-checkbox" v-model="hideStatusBar" @change="saveData"><label for="toggle-sb" class="switch-label"><div class="switch-button"></div></label></div></div></div></div></transition><transition name="page-slide"><div v-if="settingsPage === 'api-config'" class="absolute inset-0 p-4"><div class="space-y-5 pb-10"><div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 space-y-4"><div><label class="text-xs font-bold text-gray-500 ml-1 mb-1 block">åä»£åœ°å€</label><input v-model="apiConfig.baseUrl" placeholder="https://..." class="w-full bg-gray-50 p-3 rounded-xl text-sm font-mono border border-gray-200 outline-none"></div><div><label class="text-xs font-bold text-gray-500 ml-1 mb-1 block">API å¯†é’¥</label><input v-model="apiConfig.apiKey" type="password" placeholder="sk-..." class="w-full bg-gray-50 p-3 rounded-xl text-sm font-mono border border-gray-200 outline-none"></div><div class="flex items-center gap-2"><button @click="fetchModels" :disabled="isLoading" class="flex-1 bg-gray-900 text-white py-2.5 rounded-xl text-sm font-bold active:scale-95 transition flex items-center justify-center gap-2"><i v-if="isLoading" class="fas fa-spinner fa-spin"></i><span v-else>æ‹‰å–æ¨¡å‹</span></button></div><div v-if="availableModels.length > 0" class="animate-fade-in"><label class="text-xs font-bold text-gray-500 ml-1 mb-1 block">é€‰æ‹©æ¨¡å‹</label><select v-model="apiConfig.selectedModel" class="w-full bg-gray-50 p-3 rounded-xl text-sm font-medium border border-gray-200 outline-none"><option v-for="m in availableModels" :key="m" :value="m">{{ m }}</option></select></div></div><div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100"><div class="p-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50"><span class="font-bold text-gray-800 text-sm">API é¢„è®¾</span><button @click="savePreset" class="text-blue-600 text-xs font-bold px-3 py-1 bg-blue-50 rounded-lg active:bg-blue-100">ä¿å­˜</button></div><div v-if="apiPresets.length === 0" class="p-8 text-center text-gray-400 text-xs">æš‚æ— é¢„è®¾</div><div v-else class="divide-y divide-gray-50"><div v-for="(preset, idx) in apiPresets" :key="idx" class="p-4 flex items-center justify-between"><div class="flex-1 min-w-0 mr-4"><div class="font-bold text-gray-800 text-sm truncate">{{ preset.name }}</div><div class="text-[10px] text-gray-400 truncate">{{ preset.baseUrl }}</div></div><div class="flex items-center gap-2"><button @click="applyPreset(preset)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-green-100 hover:text-green-600 transition"><i class="fas fa-check text-xs"></i></button><button @click="deletePreset(idx)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-red-100 hover:text-red-600 transition"><i class="fas fa-trash text-xs"></i></button></div></div></div></div><button @click="saveSettings" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-200 active:scale-95 transition">ä¿å­˜é…ç½®</button></div></div></transition><transition name="page-slide"><div v-if="settingsPage === 'data-manage'" class="absolute inset-0 p-4"><div class="space-y-4"><div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center"><div class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-database"></i></div><h3 class="font-bold text-gray-900 text-lg">æ•°æ®ç®¡ç†</h3><p class="text-xs text-gray-400 mt-2 px-4">å¤‡ä»½æ¢å¤æ‰€æœ‰è®¾ç½®ã€‚</p></div><div class="grid grid-cols-2 gap-4"><button @click="exportData" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition"><div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-file-export"></i></div><span class="text-sm font-bold text-gray-700">å¯¼å‡º</span></button><button @click="triggerImport" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition"><div class="w-10 h-10 rounded-full bg-green-50 text-green-500 flex items-center justify-center"><i class="fas fa-file-import"></i></div><span class="text-sm font-bold text-gray-700">å¯¼å…¥</span></button></div><input type="file" ref="importInput" accept=".json" class="hidden" @change="handleImport"></div></div></transition><transition name="page-slide"><div v-if="settingsPage === 'notification'" class="absolute inset-0 p-4"><div class="space-y-4"><div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100"><div class="flex items-center justify-between mb-4"><span class="text-sm font-bold text-gray-700">å½“å‰æç¤ºéŸ³</span><span class="text-xs text-gray-400">{{ notificationConfig.currentName || 'ç³»ç»Ÿé»˜è®¤' }}</span></div><div class="flex gap-2"><button @click="triggerAudioUpload" class="flex-1 bg-gray-50 py-2.5 rounded-xl text-xs font-bold text-gray-700 active:bg-gray-100 transition border border-gray-100 flex items-center justify-center gap-2"><i class="fas fa-upload"></i> å¯¼å…¥</button><button @click="playCurrentSound" class="w-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center border border-green-100 active:scale-95 transition"><i class="fas fa-play"></i></button></div><input type="file" ref="audioInput" accept="audio/*" class="hidden" @change="handleAudioUpload"><button @click="simulateAiMessage" class="w-full mt-3 bg-gray-800 text-white py-2.5 rounded-xl text-xs font-bold active:bg-black transition">æµ‹è¯•éŸ³æ•ˆ</button></div><div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100"><div class="p-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50"><span class="font-bold text-gray-800 text-sm">éŸ³é¢‘é¢„è®¾</span><button @click="saveSoundPreset" class="text-blue-600 text-xs font-bold px-3 py-1 bg-blue-50 rounded-lg active:bg-blue-100">ä¿å­˜</button></div><div v-if="soundPresets.length === 0" class="p-6 text-center text-gray-400 text-xs">æš‚æ— é¢„è®¾</div><div v-else class="divide-y divide-gray-50"><div v-for="(sound, idx) in soundPresets" :key="idx" class="p-4 flex items-center justify-between"><span class="font-bold text-gray-700 text-sm truncate max-w-[50%]">{{ sound.name }}</span><div class="flex items-center gap-2"><button @click="playPresetSound(sound)" class="w-7 h-7 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center"><i class="fas fa-play text-[10px]"></i></button><button @click="applySoundPreset(sound)" class="w-7 h-7 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-check text-[10px]"></i></button><button @click="deleteSoundPreset(idx)" class="w-7 h-7 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button></div></div></div></div></div></div></transition></main></div></transition>
    <transition name="app-slide"><div v-if="currentApp === 'themes'" class="absolute inset-0 z-[1000] bg-gray-50 flex flex-col overflow-hidden"><header class="bg-white/80 backdrop-blur h-[90px] pt-10 flex items-center justify-between px-4 border-b border-gray-200 sticky top-0 z-10"><button @click="navigateThemes('back')" class="w-8 h-8 flex items-center justify-center text-gray-800 bg-gray-100 rounded-full active:bg-gray-200 transition"><i v-if="themesPage !== 'main'" class="fas fa-chevron-left text-sm"></i><i v-else class="fas fa-times text-sm"></i></button><h1 class="font-bold text-gray-900 text-[17px]">{{ themesTitle }}</h1><div class="w-8"></div></header><main class="flex-1 overflow-y-auto relative"><transition name="page-slide"><div v-if="themesPage === 'main'" class="absolute inset-0 p-4"><div class="grid grid-cols-1 gap-4"><div @click="navigateThemes('wallpaper')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer active:bg-gray-50 transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center text-xl"><i class="fas fa-image"></i></div><div><div class="font-bold text-gray-800">å£çº¸è®¾ç½®</div><div class="text-xs text-gray-400 mt-0.5">æ›´æ¢ä¸»å±å¹•èƒŒæ™¯</div></div></div><i class="fas fa-chevron-right text-gray-300"></i></div><div @click="navigateThemes('font')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer active:bg-gray-50 transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-pink-100 text-pink-600 flex items-center justify-center text-xl"><i class="fas fa-font"></i></div><div><div class="font-bold text-gray-800">å­—ä½“è®¾ç½®</div><div class="text-xs text-gray-400 mt-0.5">è‡ªå®šä¹‰å­—ä½“ã€å¤§å°å’Œé¢œè‰²</div></div></div><i class="fas fa-chevron-right text-gray-300"></i></div><div @click="navigateThemes('icons')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer active:bg-gray-50 transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center text-xl"><i class="fas fa-icons"></i></div><div><div class="font-bold text-gray-800">å›¾æ ‡è®¾ç½®</div><div class="text-xs text-gray-400 mt-0.5">è‡ªå®šä¹‰ App å›¾æ ‡ä¸åç§°</div></div></div><i class="fas fa-chevron-right text-gray-300"></i></div></div></div></transition><transition name="page-slide"><div v-if="themesPage === 'wallpaper'" class="absolute inset-0 p-4 space-y-6"><div class="w-full aspect-[9/16] bg-gray-200 rounded-3xl overflow-hidden shadow-lg relative mx-auto max-w-[240px] border-4 border-white"><img v-if="themeConfig.wallpaper" :src="themeConfig.wallpaper" class="w-full h-full object-cover"><div v-else class="w-full h-full flex flex-col items-center justify-center text-gray-400 bg-gray-100"><i class="fas fa-image text-3xl mb-2"></i><span class="text-xs">é»˜è®¤å£çº¸</span></div></div><div class="flex flex-col gap-3"><button @click="triggerWallpaperUpload" class="w-full bg-gray-900 text-white py-3.5 rounded-2xl font-bold active:scale-95 transition shadow-lg">ä»ç›¸å†Œé€‰æ‹©</button><button @click="resetWallpaper" class="w-full bg-white text-gray-600 py-3.5 rounded-2xl font-bold border border-gray-200 active:bg-gray-50 transition">æ¢å¤é»˜è®¤</button></div><input type="file" ref="wallpaperInput" accept="image/*" class="hidden" @change="handleWallpaperUpload"></div></transition><transition name="page-slide"><div v-if="themesPage === 'font'" class="absolute inset-0 p-4 pb-20"><div class="space-y-6"><div class="bg-gray-100 rounded-2xl p-6 text-center border border-gray-200" :style="{fontFamily: themeConfig.fontFamily}"><div class="text-2xl font-bold mb-2" :style="{color: themeConfig.fontColor}">12:30</div><div class="text-lg" :style="{color: themeConfig.fontColor}">Hello World</div><div class="text-sm opacity-60" :style="{color: themeConfig.fontColor}">é¢„è§ˆå­—ä½“æ•ˆæœ</div></div><div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-3"><label class="text-xs font-bold text-gray-500 ml-1">å­—ä½“ URL</label><div class="flex gap-2"><input v-model="fontInputUrl" placeholder="https://..." class="flex-1 bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 outline-none"><button @click="loadFontFromUrl" :disabled="isLoading" class="bg-black text-white px-4 rounded-xl font-bold text-xs active:scale-95 transition min-w-[60px]"><span v-if="!isLoading">é¢„è§ˆ</span><i v-else class="fas fa-spinner fa-spin"></i></button></div></div><div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-4"><div><div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-500">å¤§å°</span><span class="text-xs text-gray-400">{{ (themeConfig.fontSize * 100).toFixed(0) }}%</span></div><input type="range" min="0.8" max="1.2" step="0.05" v-model.number="themeConfig.fontSize" @change="saveData" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-500">è‰²å·</span></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full border border-gray-200 shadow-sm shrink-0" :style="{backgroundColor: themeConfig.fontColor}"></div><input type="text" v-model="themeConfig.fontColor" @change="saveData" placeholder="#000000" class="flex-1 bg-gray-50 px-3 py-2 rounded-xl text-sm border border-gray-200 font-mono outline-none uppercase"></div></div></div><div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100"><div class="p-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50"><span class="font-bold text-gray-800 text-sm">é¢„è®¾</span><button @click="saveFontPreset" class="text-blue-600 text-xs font-bold px-3 py-1 bg-blue-50 rounded-lg active:bg-blue-100">ä¿å­˜</button></div><div v-if="fontPresets.length === 0" class="p-6 text-center text-gray-400 text-xs">æ— é¢„è®¾</div><div v-else class="divide-y divide-gray-50"><div v-for="(fp, idx) in fontPresets" :key="idx" class="p-4 flex items-center justify-between"><div class="flex-1 min-w-0 mr-2"><div class="font-bold text-gray-800 text-sm truncate" :style="{fontFamily: fp.fontFamily}">{{ fp.name }}</div></div><div class="flex items-center gap-2"><button @click="applyFontPreset(fp)" class="w-7 h-7 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-check text-[10px]"></i></button><button @click="deleteFontPreset(idx)" class="w-7 h-7 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button></div></div></div></div></div></div></transition><transition name="page-slide"><div v-if="themesPage === 'icons'" class="absolute inset-0 p-4 pb-20"><div class="space-y-4"><div class="flex justify-end"><button @click="resetAllIcons" class="text-xs text-red-500 font-bold px-3 py-1 bg-red-50 rounded-lg active:bg-red-100">é‡ç½®æ‰€æœ‰</button></div><div class="space-y-3"><div v-for="appId in appList" :key="appId" class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex flex-col gap-3"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl border border-gray-100 overflow-hidden flex items-center justify-center bg-gray-50 shrink-0"><img v-if="hasCustomIcon(appId)" :src="getAppIcon(appId)" class="w-full h-full object-cover"><i v-else :class="getDefaultIconClass(appId) + ' text-gray-400 text-xl'"></i></div><div class="flex-1"><label class="text-[10px] font-bold text-gray-400 mb-1 block">åº”ç”¨åç§°</label><input :value="getAppName(appId)" @input="(e)=>setAppName(appId, e.target.value)" class="w-full bg-gray-50 px-2 py-1.5 rounded-lg text-sm border border-gray-200 outline-none"></div></div><div class="flex gap-2"><input v-model="tempIconUrls[appId]" placeholder="å›¾æ ‡ URL" class="flex-1 bg-gray-50 px-3 py-2 rounded-lg text-xs border border-gray-200 outline-none"><button @click="setAppIcon(appId, tempIconUrls[appId])" class="px-3 bg-black text-white rounded-lg text-xs font-bold">ç¡®å®š</button><button @click="triggerIconUpload(appId)" class="px-3 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold active:bg-gray-200"><i class="fas fa-image"></i></button><button @click="resetApp(appId)" class="px-3 bg-red-50 text-red-500 rounded-lg text-xs active:bg-red-100"><i class="fas fa-undo"></i></button></div></div></div><input type="file" ref="iconUploadInput" accept="image/*" class="hidden" @change="handleIconFile"></div></div></transition></main></div></transition>
    <transition name="app-slide"><div v-if="currentApp === 'worldbook'" class="absolute inset-0 z-[1000] bg-gray-50 flex flex-col overflow-hidden"><header class="bg-white/80 backdrop-blur h-[90px] pt-10 flex items-center justify-between px-4 border-b border-gray-200 sticky top-0 z-10"><button @click="closeApp" class="w-8 h-8 flex items-center justify-center text-gray-800 bg-gray-100 rounded-full active:bg-gray-200 transition"><i class="fas fa-times text-sm"></i></button><h1 class="font-bold text-gray-900 text-[17px]">ä¸–ç•Œä¹¦</h1><div class="flex gap-2"><button @click="openWorldModal('folder')" class="w-8 h-8 flex items-center justify-center text-yellow-600 bg-yellow-50 rounded-full"><i class="fas fa-folder-plus text-xs"></i></button><button @click="openWorldModal('file')" class="w-8 h-8 flex items-center justify-center text-blue-600 bg-blue-50 rounded-full"><i class="fas fa-file-circle-plus text-xs"></i></button></div></header><main class="flex-1 overflow-y-auto p-4 space-y-2"><div v-if="folders.length === 0 && rootFiles.length === 0" class="text-center text-gray-400 mt-20 text-xs">æš‚æ— å†…å®¹ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div><div v-for="folder in folders" :key="folder.id" class="bg-white rounded-xl border border-gray-100 overflow-hidden shadow-sm"><div @click="toggleFolder(folder.id)" class="p-4 flex items-center justify-between active:bg-gray-50 transition cursor-pointer"><div class="flex items-center gap-3"><i class="fas fa-folder text-yellow-400 text-lg"></i><span class="font-bold text-gray-800 text-sm">{{ folder.name }}</span></div><div class="flex items-center gap-3"><button @click.stop="deleteWorldItem(folder.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button><i class="fas fa-chevron-right text-gray-300 text-xs transition-transform duration-200" :class="{'rotate-90': expandedFolders.includes(folder.id)}"></i></div></div><transition name="expand"><div v-if="expandedFolders.includes(folder.id)" class="bg-gray-50 border-t border-gray-100"><div v-if="getFiles(folder.id).length===0" class="p-3 text-center text-xs text-gray-400">ç©ºæ–‡ä»¶å¤¹</div><div v-for="file in getFiles(folder.id)" :key="file.id" @click="viewFile(file)" class="p-3 pl-10 border-b border-gray-100 last:border-0 flex items-center justify-between active:bg-gray-100 cursor-pointer"><div class="flex items-center gap-3"><i class="fas fa-file-alt text-blue-400 text-sm"></i><span class="text-sm text-gray-700">{{ file.name }}</span></div><button @click.stop="deleteWorldItem(file.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button></div></div></transition></div><div v-for="file in rootFiles" :key="file.id" @click="viewFile(file)" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between active:scale-[0.98] transition cursor-pointer"><div class="flex items-center gap-3"><i class="fas fa-file-alt text-gray-400 text-lg"></i><span class="font-bold text-gray-800 text-sm">{{ file.name }}</span></div><button @click.stop="deleteWorldItem(file.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button></div></main></div></transition>
    <transition name="scale"><div v-if="viewFileModal.show" class="fixed inset-0 z-[9000] flex items-center justify-center bg-black/40 backdrop-blur-sm"><div class="bg-white w-[85%] max-h-[70%] rounded-3xl overflow-hidden shadow-2xl flex flex-col"><div class="p-4 border-b border-gray-100 flex justify-between items-center"><h3 class="font-bold text-lg">{{ viewFileModal.data.name }}</h3><button @click="saveFileContent" class="text-blue-600 font-bold text-sm">ä¿å­˜</button></div><textarea v-model="viewFileModal.data.content" class="flex-1 p-4 text-sm leading-relaxed outline-none resize-none"></textarea><button @click="viewFileModal.show=false" class="p-4 bg-gray-50 text-gray-500 font-bold text-sm">å…³é—­</button></div></div></transition>

</div>

<script>
const { createApp } = Vue;

const compressImage = (file, maxWidth = 800, quality = 0.8) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = reject;
        };
        reader.onerror = reject;
    });
};

const DEFAULT_APPS = {
    'wechat': { name: 'å¾®ä¿¡', iconClass: 'fas fa-comment' },
    'themes': { name: 'ä¸»é¢˜', iconClass: 'fas fa-palette' },
    'worldbook': { name: 'ä¸–ç•Œä¹¦', iconClass: 'fas fa-book-atlas' },
    'settings': { name: 'è®¾ç½®', iconClass: 'fas fa-cog' },
    'icity': { name: 'icity', iconClass: 'fas fa-city' },
    'forum': { name: 'è®ºå›', iconClass: 'fas fa-users' },
    'check': { name: 'æŸ¥å²—', iconClass: 'fas fa-magnifying-glass-location' },
    'pinxixi': { name: 'æ‹¼å¤•å¤•', iconClass: 'fas fa-bag-shopping' }
};

createApp({
    data() {
        return {
            isActivated: false,
            isAppOpen: false, currentApp: null, settingsPage: 'main', themesPage: 'main', isLoading: false, isFullScreen: false, hideStatusBar: false,
            apiConfig: { baseUrl: '', apiKey: '', selectedModel: 'gpt-3.5-turbo' }, availableModels: [], apiPresets: [], 
            notificationConfig: { currentSound: null, currentName: 'é»˜è®¤æç¤ºéŸ³' }, soundPresets: [],
            themeConfig: { wallpaper: '', fontFamily: '', fontUrl: '', fontSize: 1.0, fontColor: '#000000' }, fontPresets: [], fontInputUrl: '',
            appList: Object.keys(DEFAULT_APPS), appCustomization: {}, tempIconUrls: {}, uploadingAppId: null,
            wechatState: { activeFilter: 'Chats', activeNav: 'chat', contacts: [], searchQuery: '', friendList: [], sessions: [], activeSession: null, showPlusMenu: false, showChatFunctions: false, showAttachMenu: false },
            addContactModal: { show: false }, chatWizard: { show: false, step: 1, type: 'single', selectedContacts: [], selectedMask: null },
            newContact: { name: '', remark: '', username: '', gender: 'ç”·', bio: '', nudge: '', signature: '', avatar: '' },
            masks: [], showMaskManager: false, maskModal: { show: false }, maskForm: { id: null, name: '', username: '', gender: 'å¥³', bio: '', nudge: '', signature: '', avatar: '' },
            worldData: [], expandedFolders: [], worldModal: { show: false, type: 'folder', name: '', content: '', parentId: '' }, viewFileModal: { show: false, data: {} },
            worldBinderModal: { show: false },
            modelSelectModal: { show: false }, 
            chatContextMenu: { show: false, x: 0, y: 0, msg: null, index: -1, isSelf: false },
            folderSelectModal: { show: false },
            statusDisplayModal: { show: false, data: {} }, 
            statusHistoryModal: { show: false, list: [] },
            isMultiSelectMode: false, selectedMessageIds: [], forwardModal: { show: false },
            
            // Global Notifications
            globalNotification: { show: false, title: '', content: '', avatar: '', sessionId: '' },

            cardProfile: { name: 'è¾“å…¥æ–‡å­—', id: 'è¾“å…¥æ–‡å­—', bio: 'ä½ å°æˆ‘ä¾†èªªæ˜¯å®‡å®™ï¼Œä½†æˆ‘å°ä½ ä¾†èªªåªæ˜¯ä¸€é¡†æ˜Ÿå—ï¼Ÿ', status: 'è¯¥ç”¨æˆ·å·²æ³¨é”€', avatar: '' },
            homeProfile: { name: 'ç‚¹å‡»ä¿®æ”¹åå­—', id: 'username', bio: 'ç‚¹å‡»ä¿®æ”¹ä¸ªæ€§ç­¾å', location: 'æœªçŸ¥æ˜Ÿç³»', avatar: '' },
            homeConfig: { widgetTitle: 'è¾“å…¥æ–‡å­—', rightWidgetTitle: 'è¾“å…¥æ–‡å­—' },
            customWidgets: [ { id: 1, bubble: 'çŠ¶æ€', image: '', label: 'ç»„ä»¶A' }, { id: 2, bubble: 'å¿ƒæƒ…', image: '', label: 'ç»„ä»¶B' } ],
            editingWidgetId: null,
            statusBar: { time: '', batteryLevel: 100, isCharging: false },
            displayDate: { dateString: '', dayString: '' },
            timer: null, toast: { show: false, message: '' }, inputModal: { show: false, title: '', value: '', placeholder: '', callback: null, desc: '' }, confirmModal: { show: false, message: '', callback: null },
            inputMsg: '', deviceId: '', isTyping: false, replyingTo: null
        }
    },
    computed: {
        settingsTitle() { if (this.settingsPage === 'api-config') return 'API é…ç½®'; if (this.settingsPage === 'data-manage') return 'æ•°æ®ç®¡ç†'; if (this.settingsPage === 'notification') return 'æ¶ˆæ¯æç¤ºéŸ³'; return 'ç³»ç»Ÿè®¾ç½®'; },
        themesTitle() { if (this.themesPage === 'wallpaper') return 'å£çº¸è®¾ç½®'; if (this.themesPage === 'font') return 'å­—ä½“è®¾ç½®'; if (this.themesPage === 'icons') return 'å›¾æ ‡è®¾ç½®'; return 'ä¸»é¢˜å•†åº—'; },
        folders() { return this.worldData.filter(i => i.type === 'folder'); },
        rootFiles() { return this.worldData.filter(i => i.type === 'file' && !i.parentId); },
        filteredWechatContacts() {
            let sessions = [...this.wechatState.sessions];
            sessions.sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                return b.time - a.time;
            });
            if (!this.wechatState.searchQuery) return sessions;
            const query = this.wechatState.searchQuery.toLowerCase();
            return sessions.filter(c => c.name.toLowerCase().includes(query));
        }
    },
    mounted() { 
        this.initDevice();
        this.loadData();
        
        setTimeout(() => {
            const loader = document.getElementById('loading-screen');
            if(loader) loader.style.opacity = '0';
            setTimeout(()=> { if(loader)loader.style.visibility='hidden'; }, 800);
            if(this.isActivated) {
                document.getElementById('app').style.display = 'flex';
                document.getElementById('activation-screen').classList.add('hidden-screen');
            } else {
                document.getElementById('activation-screen').classList.remove('hidden-screen');
            }
        }, 2000);

        this.updateTime(); this.timer = setInterval(this.updateTime, 1000); this.initBattery();
        document.addEventListener("fullscreenchange", () => { this.isFullScreen = !!document.fullscreenElement; });
        if(this.themeConfig.fontUrl && this.themeConfig.fontFamily) { this.loadFont(this.themeConfig.fontUrl, this.themeConfig.fontFamily); }
        window.attemptActivate = this.attemptActivate; 
    },
    unmounted() { clearInterval(this.timer); },
    methods: {
        initDevice() {
            let did = localStorage.getItem('onyunx_device_id');
            if(!did) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                const rand = (l) => Array.from({length:l}, ()=>chars[Math.floor(Math.random()*chars.length)]).join('');
                did = `${rand(3)}-${rand(4)}-${rand(4)}`;
                localStorage.setItem('onyunx_device_id', did);
            }
            this.deviceId = did;
            document.getElementById('device-id-display').innerText = did;
            const clean = did.replace(/-/g, '').toUpperCase();
            const map = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'; 
            let res = '';
            for(let i = 0; i < clean.length; i++) {
                let code = clean.charCodeAt(i);
                let mixed = (code * 7 + i * 13 + 99) % 36;
                res += map[mixed];
            }
            const validCode = `${res.substring(0,3)}-${res.substring(3,7)}-${res.substring(7,11)}`;
            console.log(`%c ğŸ”‘ [ADMIN] å½“å‰è®¾å¤‡æ¿€æ´»ç : ${validCode} `, 'background: #222; color: #bada55; font-size: 16px; padding: 10px;');
            this.validCode = validCode;
        },
        attemptActivate() {
            if (localStorage.getItem('onyunx_is_activated') === 'true') {
                this.isActivated = true; return;
            }
            const input = document.getElementById('activation-code');
            const err = document.getElementById('activation-error');
            const val = input.value.trim().toUpperCase();
            if(val === this.validCode) {
                this.isActivated = true;
                localStorage.setItem('onyunx_is_activated', 'true');
                this.saveData();
                const screen = document.getElementById('activation-screen');
                screen.style.transform = 'scale(1.1)'; screen.style.opacity = '0';
                setTimeout(() => { screen.classList.add('hidden-screen'); document.getElementById('app').style.display = 'flex'; }, 600);
            } else {
                input.classList.add('error'); err.classList.add('show');
                setTimeout(() => { input.classList.remove('error'); err.classList.remove('show'); }, 1000);
            }
        },

        openApp(name) { this.currentApp = name; this.isAppOpen = true; this.settingsPage = 'main'; this.themesPage = 'main'; },
        closeApp() { 
            this.isAppOpen = false; 
            setTimeout(() => { 
                this.currentApp = null; 
                this.showMaskManager = false; 
                this.maskModal.show = false;
                this.addContactModal.show = false;
                this.chatWizard.show = false;
            }, 300); 
        },
        navigateSettings(t) { if (t === 'back') { if (this.settingsPage === 'main') this.closeApp(); else this.settingsPage = 'main'; } else { this.settingsPage = t; } },
        navigateThemes(t) { if (t === 'back') { if (this.themesPage === 'main') this.closeApp(); else this.themesPage = 'main'; } else { this.themesPage = t; } },
        toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e => { this.showToast("å…¨å±å¤±è´¥: " + e.message); this.isFullScreen = false; }); } else { if (document.exitFullscreen) document.exitFullscreen(); } },

        // Chat Wizard
        startChatWizard(type) { this.wechatState.showPlusMenu = false; this.chatWizard = { show: true, step: 1, type: type, selectedContacts: [], selectedMask: null }; },
        closeChatWizard() { this.chatWizard.show = false; },
        selectWizardMask(mask) { this.chatWizard.selectedMask = mask; this.chatWizard.step = 2; },
        selectWizardContact(friend) {
            if (this.chatWizard.type === 'single') { this.createSession(friend, this.chatWizard.selectedMask); this.chatWizard.show = false; }
            else { const idx = this.chatWizard.selectedContacts.indexOf(friend.id); if(idx > -1) this.chatWizard.selectedContacts.splice(idx, 1); else this.chatWizard.selectedContacts.push(friend.id); }
        },
        finishCreateChat() {
            if (this.chatWizard.selectedContacts.length === 0) return this.showToast('è¯·é€‰æ‹©æˆå‘˜');
            const groupFakeFriend = { id: Date.now().toString(), name: `ç¾¤èŠ(${this.chatWizard.selectedContacts.length})`, avatar: '' }; 
            this.createSession(groupFakeFriend, this.chatWizard.selectedMask); this.chatWizard.show = false;
        },
        createSession(target, mask) {
            let session = this.wechatState.sessions.find(s => s.targetId === target.id);
            if (!session) {
                session = { 
                    id: Date.now().toString(), targetId: target.id, name: target.remark || target.name, 
                    avatar: target.avatar, maskId: mask.id, messages: [], lastMessage: '', time: Date.now(),
                    isPinned: false, boundWorldbookFolderId: null, boundWorldbookFolderIds: [], statusHistory: [] 
                };
                this.wechatState.sessions.unshift(session);
            }
            this.enterChatRoom(session); this.saveData();
        },
        enterChatRoom(session) { this.wechatState.activeSession = session; this.wechatState.activeNav = 'room'; this.inputMsg = ''; this.scrollToBottom(); },
        goToChatDetails() { this.wechatState.activeNav = 'chat-details'; },
        scrollToBottom() { this.$nextTick(() => { const c = this.$refs.chatContainer; if (c) c.scrollTop = c.scrollHeight; }); },
        
        // Chat Logic
        sendMessage() {
            if(!this.inputMsg.trim()) return;
            const msg = { content: this.inputMsg, isSelf: true, time: Date.now(), avatar: this.getMaskById(this.wechatState.activeSession.maskId).avatar };
            if(this.replyingTo) { msg.quote = { name: this.replyingTo.isSelf ? 'æˆ‘' : this.wechatState.activeSession.name, content: this.replyingTo.content }; this.replyingTo = null; }
            this.wechatState.activeSession.messages.push(msg);
            this.wechatState.activeSession.lastMessage = this.inputMsg;
            this.inputMsg = ''; this.scrollToBottom(); this.saveData();
        },
        triggerReceive() {
            if (!this.apiConfig.apiKey) { this.showToast('è¯·å…ˆé…ç½® API Key'); return; }
            this.isTyping = true; 
            this.generateAiReply();
        },
        async generateAiReply() {
            const session = this.wechatState.activeSession;
            const friend = this.wechatState.friendList.find(f => f.id === session.targetId);
            const mask = this.getMaskById(session.maskId);
            
            let worldContext = "";
            let folderIds = session.boundWorldbookFolderIds || [];
            if (session.boundWorldbookFolderId) folderIds.push(session.boundWorldbookFolderId);
            folderIds = [...new Set(folderIds)];

            if (folderIds.length > 0) {
                const files = this.worldData.filter(i => i.type === 'file' && folderIds.includes(i.parentId));
                if (files.length > 0) {
                    worldContext = "\n[World Info]:\n" + files.map(f => `(${f.name}): ${f.content}`).join("\n");
                }
            }

            let contextMessages = [];
            // Updated Prompt to request JSON
            let systemPrompt = `Roleplay. You: ${friend ? friend.name : session.name}. Bio: ${friend ? friend.bio : 'None'}. User: ${mask.name}. Bio: ${mask.bio}. ${worldContext} 
            Reply in JSON format: { "reply": "Your message text here", "action": "current action", "thought": "inner voice", "outfit": "clothing description", "essay": "short essay < 100 words" }.`;
            
            contextMessages.push({ role: 'system', content: systemPrompt });
            const recentMsgs = session.messages.slice(-15);
            recentMsgs.forEach(m => {
                if(!m.isRecalled) contextMessages.push({ role: m.isSelf ? 'user' : 'assistant', content: m.content });
            });

            try {
                let url = this.apiConfig.baseUrl.trim().replace(/\/+$/, '');
                if (!url.endsWith('/v1')) url += '/v1';
                
                const res = await fetch(`${url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiConfig.apiKey.trim()}` },
                    body: JSON.stringify({ model: this.apiConfig.selectedModel, messages: contextMessages })
                });

                if (!res.ok) throw new Error('API Request Failed');
                const data = await res.json();
                let contentRaw = data.choices[0].message.content;
                let replyContent = contentRaw;
                
                // Parse JSON
                try {
                    // Try to find JSON object in the string
                    const jsonStart = contentRaw.indexOf('{');
                    const jsonEnd = contentRaw.lastIndexOf('}');
                    if (jsonStart !== -1 && jsonEnd !== -1) {
                        const jsonStr = contentRaw.substring(jsonStart, jsonEnd + 1);
                        const parsed = JSON.parse(jsonStr);
                        replyContent = parsed.reply || "No reply";
                        // Save Status
                        if(!session.statusHistory) session.statusHistory = [];
                        session.statusHistory.unshift({
                            time: Date.now(),
                            action: parsed.action,
                            thought: parsed.thought,
                            outfit: parsed.outfit,
                            essay: parsed.essay
                        });
                        this.saveData();
                    }
                } catch(e) {
                    // Fallback to text
                }

                const segments = replyContent.split(/(?<=ã€‚|\n)/).filter(s => s.trim() !== '');
                if (segments.length === 0) segments.push(replyContent);

                this.isTyping = false; 
                
                let delay = 0;
                segments.forEach((seg, index) => {
                    setTimeout(() => {
                         // Check global notification condition
                         if (this.currentApp !== 'wechat' || this.wechatState.activeNav !== 'room' || this.wechatState.activeSession.id !== session.id) {
                             this.showGlobalNotification(session, seg.trim());
                         }

                         const aiMsg = { content: seg.trim(), isSelf: false, time: Date.now(), avatar: session.avatar };
                         session.messages.push(aiMsg);
                         this.scrollToBottom();
                         if (index === segments.length - 1) {
                             session.lastMessage = seg.trim();
                             // Recall Logic (10% chance after 3s)
                             if (Math.random() < 0.1) {
                                 setTimeout(() => {
                                     const targetIdx = session.messages.indexOf(aiMsg);
                                     if (targetIdx > -1) {
                                         session.messages[targetIdx].isRecalled = true; 
                                         this.saveData();
                                     }
                                 }, 3000);
                             }
                             this.saveData();
                             if(this.notificationConfig.currentSound) new Audio(this.notificationConfig.currentSound).play();
                         }
                    }, delay);
                    delay += 1000 + Math.random() * 800; 
                });

            } catch(e) {
                this.isTyping = false;
                this.showToast('AI å›å¤å¤±è´¥: ' + e.message);
            }
        },
        viewRecalled(msg) { this.showConfirm(`æ’¤å›çš„å†…å®¹:\n${msg.content}`, null); },

        // Global Notification
        showGlobalNotification(session, content) {
            this.globalNotification = {
                show: true,
                title: session.name,
                content: content,
                avatar: session.avatar,
                sessionId: session.id
            };
            setTimeout(() => { this.globalNotification.show = false; }, 3000);
        },
        jumpToChat(sessionId) {
            const session = this.wechatState.sessions.find(s => s.id === sessionId);
            if (session) {
                this.openApp('wechat');
                this.enterChatRoom(session);
                this.globalNotification.show = false;
            }
        },

        // Context Menu Logic
        showChatContextMenu(e, msg, index) {
            const rect = e.target.closest('.flex').getBoundingClientRect();
            this.chatContextMenu = { show: true, x: 20, y: rect.bottom + 5, msg, index, isSelf: msg.isSelf };
        },
        handleChatMenuAction(action) {
            const { msg, index } = this.chatContextMenu;
            const session = this.wechatState.activeSession;
            
            if (action === 'copy') { navigator.clipboard.writeText(msg.content); this.showToast('å·²å¤åˆ¶'); }
            else if (action === 'delete') { session.messages.splice(index, 1); this.saveData(); }
            else if (action === 'recall') { session.messages[index].isRecalled = true; this.saveData(); this.showToast('å·²æ’¤å›'); }
            else if (action === 'quote') { this.replyingTo = msg; }
            else if (action === 'edit') { this.showInput("ç¼–è¾‘", msg.content, "", (v) => { if(v){msg.content=v; this.saveData();} }); }
            else if (action === 'regenerate') {
                let i = session.messages.length - 1;
                while (i >= 0) {
                    const m = session.messages[i];
                    if (!m.isSelf) { session.messages.splice(i, 1); } 
                    else { break; } 
                    i--;
                }
                this.saveData();
                this.triggerReceive(); 
            }
            else if (action === 'multi') {
                this.isMultiSelectMode = true;
                this.selectedMessageIds = [msg]; // Using object ref or add ID to msg
                // Need unique ID for msgs for proper selection, using reference for now
            }
            else { this.showToast('åŠŸèƒ½å¼€å‘ä¸­'); }
            this.chatContextMenu.show = false;
        },
        
        // Multi-select
        toggleMultiSelect(msg) {
            const idx = this.selectedMessageIds.indexOf(msg);
            if(idx > -1) this.selectedMessageIds.splice(idx, 1);
            else this.selectedMessageIds.push(msg);
        },
        exitMultiSelect() { this.isMultiSelectMode = false; this.selectedMessageIds = []; },
        executeMultiAction(type) {
            if(this.selectedMessageIds.length === 0) return;
            const session = this.wechatState.activeSession;
            if(type === 'delete') {
                this.showConfirm(`åˆ é™¤ ${this.selectedMessageIds.length} æ¡æ¶ˆæ¯ï¼Ÿ`, () => {
                    session.messages = session.messages.filter(m => !this.selectedMessageIds.includes(m));
                    this.saveData(); this.exitMultiSelect();
                });
            } else if (type === 'forward') {
                this.forwardModal.show = true;
            }
        },
        confirmForward(targetSession) {
            // Create a merged forward card message
            const content = this.selectedMessageIds.map(m => `[${m.isSelf ? 'æˆ‘' : session.name}]: ${m.content}`).join('\n');
            const cardMsg = {
                content: `[èŠå¤©è®°å½•] ${this.selectedMessageIds.length}æ¡æ¶ˆæ¯\n${content.substring(0, 50)}...`,
                isSelf: true,
                time: Date.now(),
                avatar: this.getMaskById(targetSession.maskId).avatar,
                type: 'forward_card' // Special type
            };
            targetSession.messages.push(cardMsg);
            targetSession.lastMessage = "[èŠå¤©è®°å½•]";
            this.saveData();
            this.forwardModal.show = false;
            this.exitMultiSelect();
            this.showToast('å·²è½¬å‘');
        },

        closeAllMenus() {
            this.chatContextMenu.show = false;
            this.wechatState.showPlusMenu = false;
            this.wechatState.showChatFunctions = false;
            this.wechatState.showAttachMenu = false;
        },

        togglePin() { if (this.wechatState.activeSession) { this.wechatState.activeSession.isPinned = !this.wechatState.activeSession.isPinned; this.saveData(); } },
        
        bindWorldFolder(folderId) {
            const session = this.wechatState.activeSession;
            if (!session) return;
            if (!session.boundWorldbookFolderIds) session.boundWorldbookFolderIds = [];
            
            if (folderId === null) {
                session.boundWorldbookFolderIds = [];
                session.boundWorldbookFolderId = null; 
            } else {
                const idx = session.boundWorldbookFolderIds.indexOf(folderId);
                if (idx > -1) session.boundWorldbookFolderIds.splice(idx, 1);
                else session.boundWorldbookFolderIds.push(folderId);
            }
            this.saveData();
        },
        toggleWorldBinding(fid) { this.bindWorldFolder(fid); }, 
        isFolderBound(fid) {
            const session = this.wechatState.activeSession;
            if (!session) return false;
            if (session.boundWorldbookFolderId === fid) return true; 
            return session.boundWorldbookFolderIds && session.boundWorldbookFolderIds.includes(fid);
        },
        getWorldbookStatus() {
            const session = this.wechatState.activeSession;
            if (!session) return 'æœªç»‘å®š';
            let count = (session.boundWorldbookFolderIds?.length || 0) + (session.boundWorldbookFolderId ? 1 : 0);
            if (session.boundWorldbookFolderId && session.boundWorldbookFolderIds?.includes(session.boundWorldbookFolderId)) count--; 
            return count > 0 ? `å·²ç»‘å®š ${count} ä¸ª` : 'æœªç»‘å®š';
        },
        selectModel(model) {
            this.apiConfig.selectedModel = model;
            this.saveData();
            this.modelSelectModal.show = false;
        },
        
        // Status System
        showStatusDisplay() {
            const session = this.wechatState.activeSession;
            const friend = this.wechatState.friendList.find(f => f.id === session.targetId);
            const latestStatus = (session.statusHistory && session.statusHistory.length > 0) ? session.statusHistory[0] : {};
            
            this.statusDisplayModal.data = {
                name: session.name,
                avatar: session.avatar,
                thought: latestStatus.thought,
                action: latestStatus.action,
                outfit: latestStatus.outfit,
                essay: latestStatus.essay
            };
            this.statusDisplayModal.show = true;
        },
        showStatusHistory() {
             const session = this.wechatState.activeSession;
             this.statusHistoryModal.list = session.statusHistory || [];
             this.statusHistoryModal.show = true;
        },

        getMaskById(id) { return this.masks.find(m => m.id === id) || { avatar: '' }; },
        formatChatTime(ts) { const d = new Date(ts); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; },
        editCurrentSessionFriend() {
            const session = this.wechatState.activeSession;
            if(!session) return;
            const friend = this.wechatState.friendList.find(f => f.id === session.targetId);
            if(friend) { this.editFriend(friend); } else { this.showToast('å½“å‰ä¼šè¯å¯¹è±¡æœªåœ¨é€šè®¯å½•ä¸­'); }
        },
        getCurrentSessionAvatar() { return this.wechatState.activeSession?.avatar || ''; },
        getCurrentSessionId() { const friend = this.wechatState.friendList.find(f => f.id === this.wechatState.activeSession?.targetId); return friend ? (friend.username || friend.id) : 'unknown'; },
        getCurrentSessionBio() { const friend = this.wechatState.friendList.find(f => f.id === this.wechatState.activeSession?.targetId); return friend ? (friend.signature || 'æš‚æ— ä¸ªæ€§ç­¾å') : ''; },

        addMockContact() { /* Deprecated */ },
        openAddContactModal() { this.newContact = { name: '', remark: '', username: '', gender: 'ç”·', bio: '', nudge: '', signature: '', avatar: '' }; this.addContactModal.show = true; },
        editFriend(friend) { this.newContact = { ...friend }; this.addContactModal.show = true; },
        triggerAddContactAvatar() { this.$refs.addContactAvatarInput.click(); },
        async handleAddContactAvatar(e) { const f = e.target.files[0]; if(!f) return; try { this.newContact.avatar = await compressImage(f, 300); } catch(e){} },
        saveNewContact() {
            if(!this.newContact.name) return this.showToast('è¯·è¾“å…¥å§“å');
            if (this.newContact.id) { const idx = this.wechatState.friendList.findIndex(f => f.id === this.newContact.id); if (idx !== -1) { this.wechatState.friendList[idx] = { ...this.newContact }; this.showToast('ä¿®æ”¹æˆåŠŸ'); } } 
            else { this.wechatState.friendList.push({ ...this.newContact, id: Date.now().toString() }); this.showToast('å·²æ·»åŠ æœ‹å‹'); }
            this.addContactModal.show = false; this.saveData();
        },

        openMaskManager() { this.showMaskManager = true; },
        openMaskEditor(mask) { if (mask) { this.maskForm = { ...mask }; } else { this.maskForm = { id: null, name: '', username: '', gender: 'å¥³', bio: '', nudge: '', signature: '', avatar: '' }; } this.maskModal.show = true; },
        triggerMaskAvatar() { this.$refs.maskAvatarInput.click(); },
        async handleMaskAvatar(e) { const f = e.target.files[0]; if(!f) return; try { this.maskForm.avatar = await compressImage(f, 300); } catch(e){} },
        saveMask() {
            if(!this.maskForm.name) return this.showToast('è¯·è¾“å…¥å§“å');
            if(this.maskForm.id) { const idx = this.masks.findIndex(m => m.id === this.maskForm.id); if(idx !== -1) this.masks[idx] = { ...this.maskForm }; } 
            else { this.masks.push({ ...this.maskForm, id: Date.now().toString() }); }
            this.saveData(); this.maskModal.show = false; this.showToast('é¢å…·å·²ä¿å­˜');
        },
        deleteMask(id) { this.showConfirm('åˆ é™¤æ­¤é¢å…·ï¼Ÿ', () => { this.masks = this.masks.filter(m => m.id !== id); this.saveData(); this.maskModal.show = false; }); },

        async fetchModels() {
            if (!this.apiConfig.baseUrl) return this.showToast('è¯·è¾“å…¥åä»£åœ°å€');
            if (this.apiConfig.baseUrl.includes('api520.pro')) return this.showToast('è¯¥åä»£åœ°å€ä¸ç¨³å®šï¼Œå·²è¢«å±è”½');
            if (!this.apiConfig.apiKey) return this.showToast('è¯·è¾“å…¥ API å¯†é’¥');
            this.isLoading = true;
            try {
                let url = this.apiConfig.baseUrl.trim().replace(/\/+$/, '');
                if (!url.endsWith('/v1')) url += '/v1';
                const res = await fetch(`${url}/models`, { method: 'GET', headers: { 'Authorization': `Bearer ${this.apiConfig.apiKey.trim()}` } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (data && Array.isArray(data.data)) { 
                    this.availableModels = data.data.map(m => m.id); 
                    this.showToast(`è·å–æˆåŠŸ: ${this.availableModels.length}ä¸ª`); 
                    if (!this.apiConfig.selectedModel && this.availableModels.length > 0) this.apiConfig.selectedModel = this.availableModels[0]; 
                    this.modelSelectModal.show = true; 
                } else throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
            } catch (e) { console.error(e); this.showToast('æ‹‰å–å¤±è´¥: ' + e.message); if(this.availableModels.length===0) this.availableModels = ['gpt-3.5-turbo', 'gpt-4', 'claude-3-opus']; } finally { this.isLoading = false; }
        },
        openWorldModal(type) { this.worldModal = { show: true, type, name: '', content: '', parentId: '' }; },
        saveWorldItem() { if(!this.worldModal.name) return this.showToast('è¯·è¾“å…¥åç§°'); const item = { id: Date.now().toString(), type: this.worldModal.type, name: this.worldModal.name, parentId: this.worldModal.parentId || null }; if(this.worldModal.type === 'file') item.content = this.worldModal.content; this.worldData.push(item); this.saveData(); this.worldModal.show = false; },
        deleteWorldItem(id) { this.showConfirm('ç¡®å®šåˆ é™¤ï¼Ÿ', () => { this.worldData = this.worldData.filter(i => i.id !== id && i.parentId !== id); this.saveData(); }); },
        toggleFolder(id) { const i = this.expandedFolders.indexOf(id); if (i > -1) this.expandedFolders.splice(i, 1); else this.expandedFolders.push(id); },
        getFiles(fid) { return this.worldData.filter(i => i.type === 'file' && i.parentId === fid); },
        viewFile(file) { this.viewFileModal.data = file; this.viewFileModal.show = true; },
        saveFileContent() { this.saveData(); this.showToast('å·²ä¿å­˜'); },
        handleAppClick(id) { if(id==='themes'||id==='worldbook'||id==='settings'||id==='wechat')this.openApp(id); else this.showToast('ä»…ä½œä¸ºå±•ç¤º'); },
        getAppName(id) { return (this.appCustomization[id] && this.appCustomization[id].name) ? this.appCustomization[id].name : DEFAULT_APPS[id].name; },
        hasCustomIcon(id) { return this.appCustomization[id] && this.appCustomization[id].icon; },
        getAppIcon(id) { return this.appCustomization[id] ? this.appCustomization[id].icon : ''; },
        getDefaultIconClass(id) { return DEFAULT_APPS[id].iconClass; },
        setAppName(id, name) { if(!this.appCustomization[id]) this.appCustomization[id] = {}; this.appCustomization[id].name = name; this.saveData(); },
        setAppIcon(id, url) { if(!url)return; if(!this.appCustomization[id]) this.appCustomization[id] = {}; this.appCustomization[id].icon = url; this.tempIconUrls[id] = ''; this.saveData(); this.showToast('å›¾æ ‡å·²æ›´æ–°'); },
        triggerIconUpload(id) { this.uploadingAppId = id; this.$refs.iconUploadInput.click(); },
        async handleIconFile(e) { const f = e.target.files[0]; if(f && this.uploadingAppId) { try { const url = await compressImage(f, 200); this.setAppIcon(this.uploadingAppId, url); } catch(e){} } e.target.value = ''; },
        resetApp(id) { if(this.appCustomization[id]) { delete this.appCustomization[id]; this.saveData(); this.showToast('å·²é‡ç½®'); } },
        resetAllIcons() { this.showConfirm("é‡ç½®æ‰€æœ‰ï¼Ÿ", () => { this.appCustomization = {}; this.saveData(); }); },
        async loadFontFromUrl() { 
            if(!this.fontInputUrl) return this.showToast('è¯·è¾“å…¥URL'); 
            this.isLoading=true; 
            try { 
                const n='CF_'+Date.now(); 
                await this.loadFont(this.fontInputUrl, n); 
                this.themeConfig.fontFamily=n; 
                this.themeConfig.fontUrl=this.fontInputUrl; 
                this.saveData(); 
                this.showToast('å­—ä½“å·²åº”ç”¨'); 
            } catch(e){ this.showToast('å¤±è´¥'); } finally{ this.isLoading=false; } 
        },
        async loadFont(u, n) { const f = new FontFace(n, `url(${u})`); await f.load(); document.fonts.add(f); },
        saveFontPreset() { this.showInput("é¢„è®¾åç§°", "", "", (n) => { if(n) { this.fontPresets.push({ name:n, fontFamily:this.themeConfig.fontFamily, fontUrl:this.themeConfig.fontUrl, fontSize:this.themeConfig.fontSize, fontColor:this.themeConfig.fontColor }); this.saveData(); } }); },
        applyFontPreset(p) { if(p.fontUrl) this.loadFont(p.fontUrl, p.fontFamily); this.themeConfig.fontFamily=p.fontFamily; this.themeConfig.fontUrl=p.fontUrl; this.themeConfig.fontSize=p.fontSize; this.themeConfig.fontColor=p.fontColor; this.saveData(); },
        deleteFontPreset(i) { this.showConfirm("åˆ é™¤ï¼Ÿ",()=>{this.fontPresets.splice(i,1);this.saveData();}); },
        triggerWallpaperUpload() { this.$refs.wallpaperInput.click(); },
        async handleWallpaperUpload(e) { const f=e.target.files[0]; if(!f)return; try { this.themeConfig.wallpaper = await compressImage(f, 1080); this.saveData(); } catch(e){} },
        resetWallpaper() { this.themeConfig.wallpaper=''; this.saveData(); },
        triggerAudioUpload() { this.$refs.audioInput.click(); },
        handleAudioUpload(e) { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{this.notificationConfig.currentSound=ev.target.result; this.notificationConfig.currentName=f.name; this.saveData();}; r.readAsDataURL(f); },
        playCurrentSound() { if(this.notificationConfig.currentSound) new Audio(this.notificationConfig.currentSound).play(); },
        simulateAiMessage() { setTimeout(()=>{this.playCurrentSound(); this.showToast('æ”¶åˆ°æ¶ˆæ¯');},2000); },
        saveSoundPreset() { this.showInput("åç§°", "", "", (n)=>{ if(n) { this.soundPresets.push({name:n, data:this.notificationConfig.currentSound}); this.saveData(); } }); },
        playPresetSound(s) { new Audio(s.data).play(); },
        applySoundPreset(s) { this.notificationConfig.currentSound=s.data; this.notificationConfig.currentName=s.name; this.saveData(); },
        deleteSoundPreset(i) { this.showConfirm("åˆ é™¤ï¼Ÿ",()=>{this.soundPresets.splice(i,1);this.saveData();}); },
        
        // Import Logic Fixed
        exportData() { const d={...this.$data}; delete d.isAppOpen; delete d.currentApp; delete d.showMaskManager; delete d.maskModal.show; delete d.addContactModal.show; delete d.chatWizard.show; delete d.chatContextMenu.show; const b=new Blob([JSON.stringify(d)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='backup.json'; a.click(); },
        triggerImport() { this.$refs.importInput.click(); },
        handleImport(e) { 
            const f=e.target.files[0]; if(!f)return; 
            const r=new FileReader(); 
            r.onload=(ev)=>{ 
                try { 
                    const d=JSON.parse(ev.target.result); 
                    // Deep Merge
                    Object.keys(d).forEach(k => {
                        if (this.$data.hasOwnProperty(k) && k !== 'isActivated' && k !== 'deviceId') {
                            this[k] = d[k];
                        }
                    });
                    this.saveData(); 
                    if(localStorage.getItem('onyunx_is_activated')) this.isActivated = true;
                    
                    this.showToast('å¯¼å…¥æˆåŠŸï¼Œå³å°†åˆ·æ–°'); 
                    setTimeout(() => location.reload(), 1000); 
                } catch(e){ this.showToast('å¯¼å…¥å¤±è´¥'); } 
            }; 
            r.readAsText(f); e.target.value = ''; 
        },
        
        triggerCardAvatarUpload() { if(this.$refs.cardAvatarInput) this.$refs.cardAvatarInput.click(); },
        async handleCardAvatarChange(e) { const f=e.target.files[0]; if(!f)return; try { this.cardProfile.avatar = await compressImage(f); this.saveData(); } catch(e){} },
        editCardProfile(f) { let m = { 'name': 'å¡ç‰‡åå­—', 'id': 'å¡ç‰‡ID', 'bio': 'å¡ç‰‡ç­¾å', 'status': 'å¡ç‰‡çŠ¶æ€' }; this.showInput(m[f], this.cardProfile[f], "è¯·è¾“å…¥...", (v) => { if(v){ this.cardProfile[f]=v; this.saveData(); } }); },
        triggerHomeAvatarUpload() { if(this.$refs.homeAvatarInput) this.$refs.homeAvatarInput.click(); },
        async handleHomeAvatarChange(e) { const f=e.target.files[0]; if(!f)return; try { this.homeProfile.avatar = await compressImage(f); this.saveData(); } catch(e){} },
        editHomeProfile(f) { let m = { 'name': 'ä¸»é¡µåå­—', 'id': 'ä¸»é¡µID', 'bio': 'ä¸»é¡µç­¾å', 'location': 'ä¸»é¡µå®šä½' }; this.showInput(m[f], this.homeProfile[f], "è¯·è¾“å…¥...", (v) => { if(v){ this.homeProfile[f]=v; this.saveData(); } }); },
        editHomeConfig(k, t) { this.showInput(t, this.homeConfig[k], "", (v) => { if(v){ this.homeConfig[k]=v; this.saveData(); } }); },
        editCustomWidget(i, f) { let t = f==='bubble'?'æ°”æ³¡æ–‡å­—':'ä¸‹æ–¹æ–‡å­—'; this.showInput(t, this.customWidgets[i][f], "", (v) => { if(v){ this.customWidgets[i][f]=v; this.saveData(); } }); },
        triggerWidgetImageUpload(i) { this.editingWidgetId=i; if(this.$refs.widgetImageInput)this.$refs.widgetImageInput.click(); },
        async handleWidgetImageChange(e) { const f=e.target.files[0]; if(!f)return; try { this.customWidgets[this.editingWidgetId].image = await compressImage(f); this.saveData(); } catch(e){} },
        saveData() { try { localStorage.setItem('onyunx_hybrid_v36', JSON.stringify(this.$data)); } catch(e){} },
        loadData() { 
            const s=localStorage.getItem('onyunx_hybrid_v36'); 
            if(s) { try { const d=JSON.parse(s); Object.assign(this.$data, d); } catch(e){} }
            if (localStorage.getItem('onyunx_is_activated') === 'true') { this.isActivated = true; }
        },
        showToast(m) { this.toast.message=m; this.toast.show=true; setTimeout(()=>{this.toast.show=false},2000); },
        showInput(t,v,p,cb) { this.inputModal={show:true,title:t,value:v,placeholder:p,callback:cb,desc:''}; },
        showConfirm(m, cb) { this.confirmModal={show:true, message:m, callback:cb}; },
        handleInputConfirm() { if(this.inputModal.callback)this.inputModal.callback(this.inputModal.value); this.inputModal.show=false; },
        handleConfirm() { if(this.confirmModal.callback)this.confirmModal.callback(); this.confirmModal.show=false; },
        updateTime() { const now=new Date(); this.statusBar.time=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; const m=now.getMonth()+1; const d=now.getDate(); const ds=['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­']; this.displayDate={dateString:`${m}æœˆ${d}æ—¥`,dayString:ds[now.getDay()]}; },
        async initBattery() { try{const b=await navigator.getBattery();this.statusBar.batteryLevel=Math.round(b.level*100);this.statusBar.isCharging=b.charging;}catch(e){} },
        savePreset() { if (!this.apiConfig.baseUrl) return this.showToast('é…ç½®ä¸ºç©º'); this.showInput("é¢„è®¾åç§°", "", "ä¾‹å¦‚: DeepSeek", (name) => { if (name) { this.apiPresets.push({ name, baseUrl: this.apiConfig.baseUrl, apiKey: this.apiConfig.apiKey, selectedModel: this.apiConfig.selectedModel }); this.saveData(); this.showToast('é¢„è®¾å·²ä¿å­˜'); } }); },
        applyPreset(p) { this.apiConfig.baseUrl = p.baseUrl; this.apiConfig.apiKey = p.apiKey; this.apiConfig.selectedModel = p.selectedModel; this.showToast(`å·²åº”ç”¨: ${p.name}`); },
        deletePreset(i) { this.showConfirm("ç¡®å®šåˆ é™¤è¯¥é¢„è®¾å—ï¼Ÿ", () => { this.apiPresets.splice(i, 1); this.saveData(); this.showToast('å·²åˆ é™¤'); }); },
        saveSettings() { this.saveData(); this.showToast('é…ç½®å·²ä¿å­˜'); this.navigateSettings('back'); },
    }
}).mount('#app');
</script>
</body>
</html>
